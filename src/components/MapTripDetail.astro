---
---

<div id="trip-detail-modal" style="
  position:fixed; inset:0; z-index:3000;
  display:none; align-items:center; justify-content:center;
  padding:20px; box-sizing:border-box;
">
  <div id="trip-detail-backdrop" style="
    position:absolute; inset:0;
    background:rgba(3,7,18,0.65);
    backdrop-filter:blur(6px); -webkit-backdrop-filter:blur(6px);
  "></div>

  <div id="trip-detail-content" style="
    position:relative; z-index:1;
    background:#fff;
    border-radius:24px;
    width:100%; max-width:420px;
    max-height:90vh;
    overflow:hidden; overflow-y:auto;
    box-shadow:
      0 0 0 1px rgba(0,0,0,0.06),
      0 32px 64px -12px rgba(0,0,0,0.35),
      0 8px 24px -4px rgba(0,0,0,0.15);
    scrollbar-width:none;
  "></div>
</div>

<script>
  import { PUBLIC_R2_URL } from "astro:env/client";

  const tripModal    = document.getElementById('trip-detail-modal')    as HTMLDivElement;
  const tripContent  = document.getElementById('trip-detail-content')  as HTMLDivElement;
  const tripBackdrop = document.getElementById('trip-detail-backdrop') as HTMLDivElement;

  tripBackdrop?.addEventListener('click', closeModal);
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });

  function closeModal() {
    tripModal.style.display = 'none';
  }

  (window as any).showTripDetail = function(trip: any) {
    const hasSlots  = trip.current_participants < trip.max_participants;
    const slotsLeft = trip.max_participants - trip.current_participants;
    const current   = trip.current_participants || 0;
    const max       = trip.max_participants || 0;
    const fillPct   = max > 0 ? Math.min(100, Math.round((current / max) * 100)) : 0;
    const img       = trip.images?.[0] ? `${PUBLIC_R2_URL}${trip.images[0]}` : '/images/default-trip.jpg';

    const accentColor = hasSlots ? (slotsLeft <= 3 ? '#f59e0b' : '#10b981') : '#ef4444';
    const pillTxt     = hasSlots
      ? `${slotsLeft} slot${slotsLeft !== 1 ? 's' : ''} left`
      : 'Fully Booked';

    const fmtShort = (d: string) =>
      d ? new Date(d).toLocaleDateString('en-PH', { month: 'short', day: 'numeric' }) : 'TBD';
    const fmtBudget = (b: number | null) =>
      b ? `‚Ç±${b.toLocaleString('en-PH')}` : 'Open';

    // Build a clean single destination label:
    // Prefer region alone, or just location_name ‚Äî never show both if they're duplicates
    const destination = (() => {
      const loc    = (trip.location_name || '').trim();
      const region = (trip.region || '').trim();
      if (!loc && !region) return 'Unknown destination';
      if (!region || loc === region) return loc;
      // If location_name already contains the region text, just use location_name
      if (loc.toLowerCase().includes(region.toLowerCase())) return loc;
      return `${loc}, ${region}`;
    })();

    const tags = (trip.tags || []) as string[];

    tripContent.innerHTML = `
      <!-- ‚îÄ‚îÄ HERO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div style="position:relative; height:230px; overflow:hidden; border-radius:24px 24px 0 0;">
        <img src="${img}" alt="${trip.title}"
          style="width:100%; height:100%; object-fit:cover; display:block;" />

        <!-- Gradient -->
        <div style="
          position:absolute; inset:0;
          background:linear-gradient(
            to bottom,
            rgba(0,0,0,0.05) 0%,
            rgba(0,0,0,0)    25%,
            rgba(0,0,0,0.55) 68%,
            rgba(0,0,0,0.88) 100%
          );
        "></div>

        <!-- Close -->
        <button id="close-trip-detail" style="
          position:absolute; top:14px; right:14px;
          width:34px; height:34px; border-radius:50%; border:none;
          background:rgba(255,255,255,0.95);
          display:flex; align-items:center; justify-content:center;
          cursor:pointer; color:#1e293b; font-size:15px; font-weight:800;
          box-shadow:0 2px 12px rgba(0,0,0,0.18);
          font-family:sans-serif; line-height:1;
        ">‚úï</button>

        <!-- Pill -->
        <div style="
          position:absolute; top:14px; left:14px;
          background:${accentColor}; color:#fff;
          padding:5px 12px; border-radius:99px;
          font-size:11.5px; font-weight:700;
          display:flex; align-items:center; gap:5px;
          box-shadow:0 2px 10px rgba(0,0,0,0.25);
          font-family:sans-serif;
        ">
          <span style="width:6px;height:6px;border-radius:50%;background:rgba(255,255,255,0.85);display:inline-block;"></span>
          ${pillTxt}
        </div>

        <!-- Title + single destination line -->
        <div style="position:absolute; bottom:0; left:0; right:0; padding:16px 18px 18px;">
          <div style="
            display:flex; align-items:center; gap:5px;
            font-size:11.5px; color:rgba(255,255,255,0.72);
            font-weight:500; margin-bottom:6px; font-family:sans-serif;
          ">
            üìç <span>${destination}</span>
          </div>
          <h2 style="
            margin:0; font-size:20px; font-weight:800;
            color:#fff; line-height:1.2; letter-spacing:-0.025em;
            text-shadow:0 1px 10px rgba(0,0,0,0.4);
            font-family:sans-serif;
          ">${trip.title}</h2>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ BODY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div style="padding:18px 18px 24px; font-family:sans-serif;">

        <!-- Info chips -->
        <div style="display:flex; flex-wrap:wrap; gap:7px; margin-bottom:18px;">
          <span style="display:inline-flex;align-items:center;gap:6px;padding:7px 13px;background:#f1f5f9;border-radius:99px;font-size:12.5px;font-weight:600;color:#1e293b;">
            üìÖ ${fmtShort(trip.start_date)} ‚Üí ${fmtShort(trip.end_date)}
          </span>
          ${trip.duration_days ? `
          <span style="display:inline-flex;align-items:center;gap:6px;padding:7px 13px;background:#f1f5f9;border-radius:99px;font-size:12.5px;font-weight:600;color:#1e293b;">
            ‚è± ${trip.duration_days} day${trip.duration_days !== 1 ? 's' : ''}
          </span>` : ''}
          <span style="display:inline-flex;align-items:center;gap:6px;padding:7px 13px;background:#f1f5f9;border-radius:99px;font-size:12.5px;font-weight:600;color:#1e293b;">
            üí∞ ${fmtBudget(trip.estimated_budget)}
          </span>
        </div>

        <!-- Divider -->
        <div style="height:1px;background:#f1f5f9;margin-bottom:18px;"></div>

        <!-- Group capacity -->
        <div style="margin-bottom:${tags.length > 0 ? '18px' : '22px'};">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
            <span style="font-size:13px;color:#64748b;font-weight:600;display:flex;align-items:center;gap:5px;">
              üë• Group capacity
            </span>
            <div style="font-family:sans-serif;">
              <span style="font-size:15px;font-weight:800;color:#0f172a;">${current}</span>
              <span style="font-size:13px;color:#cbd5e1;font-weight:400;margin:0 2px;">/</span>
              <span style="font-size:15px;font-weight:800;color:#0f172a;">${max}</span>
              <span style="font-size:11.5px;color:#94a3b8;font-weight:500;"> joined</span>
            </div>
          </div>
          <div style="height:8px;background:#e2e8f0;border-radius:99px;overflow:hidden;">
            <div style="height:100%;width:${fillPct}%;background:${accentColor};border-radius:99px;min-width:${fillPct > 0 ? '8px' : '0'};"></div>
          </div>
          ${!hasSlots ? `
          <div style="text-align:center;margin-top:8px;font-size:11.5px;color:#ef4444;font-weight:600;">
            This trip is fully booked
          </div>` : ''}
        </div>

        ${tags.length > 0 ? `
        <!-- Tags -->
        <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:20px;">
          ${tags.slice(0, 5).map((t: string) => `
            <span style="padding:5px 12px;background:#ecfdf5;color:#047857;border-radius:99px;font-size:12px;font-weight:600;">#${t}</span>
          `).join('')}
          ${tags.length > 5 ? `
            <span style="padding:5px 12px;background:#f3f4f6;color:#9ca3af;border-radius:99px;font-size:12px;font-weight:600;">+${tags.length - 5} more</span>
          ` : ''}
        </div>
        ` : ''}

        <!-- CTA -->
        <a href="/trips/${trip.trip_id}" style="
          display:flex; align-items:center; justify-content:center; gap:9px;
          width:100%; padding:15px 20px; box-sizing:border-box;
          background:linear-gradient(135deg,#10b981 0%,#059669 100%);
          color:#fff; border-radius:14px;
          font-size:15px; font-weight:700; letter-spacing:0.01em;
          text-decoration:none;
          box-shadow:0 4px 18px rgba(16,185,129,0.4);
        ">
          View Full Details <span style="font-size:17px;">‚Üí</span>
        </a>

      </div>
    `;

    document.getElementById('close-trip-detail')?.addEventListener('click', closeModal);
    tripModal.style.display = 'flex';
  };
</script>

<style>
  #trip-detail-content::-webkit-scrollbar { display: none; }

  #trip-detail-content {
    animation: tdSlideUp 0.3s cubic-bezier(0.34, 1.4, 0.64, 1) both;
  }
  @keyframes tdSlideUp {
    from { opacity: 0; transform: translateY(20px) scale(0.97); }
    to   { opacity: 1; transform: translateY(0) scale(1); }
  }

  #trip-detail-backdrop {
    animation: tdFadeIn 0.22s ease both;
  }
  @keyframes tdFadeIn {
    from { opacity: 0; }
    to   { opacity: 1; }
  }

  #close-trip-detail:hover {
    transform: scale(1.08) !important;
    background: #fff !important;
  }
</style>