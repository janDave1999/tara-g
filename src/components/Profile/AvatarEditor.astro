---
interface Props {
  currentAvatarUrl: string;
}

const { currentAvatarUrl } = Astro.props;
---

<dialog id="avatar-editor-modal" class="modal modal-bottom sm:modal-middle">
  <div class="modal-box bg-white rounded-2xl shadow-2xl p-0 max-w-sm w-full mx-4">
    <!-- Header -->
    <div class="flex items-center justify-between p-6 border-b border-gray-100">
      <h2 class="text-xl font-semibold text-gray-900">Change Profile Photo</h2>
      <button 
        onclick="document.getElementById('avatar-editor-modal').close()" 
        class="p-2 hover:bg-gray-100 rounded-full transition-colors"
      >
        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    
    <!-- Content -->
    <div class="p-6 space-y-5">
      <!-- Current/New Avatar Preview -->
      <div class="flex flex-col items-center">
        <div class="w-36 h-36 rounded-full overflow-hidden border-4 border-white shadow-lg">
          <img 
            id="avatar-preview" 
            src={currentAvatarUrl || "/default-avatar.png"} 
            alt="Avatar preview" 
            class="w-full h-full object-cover"
          />
        </div>
      </div>
      
      <!-- File Input -->
      <div class="text-center">
        <label class="inline-flex items-center justify-center px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors cursor-pointer">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          Choose Image
          <input 
            type="file" 
            id="avatar-file-input"
            accept="image/jpeg,image/png,image/gif,image/webp"
            class="hidden"
          />
        </label>
        <p class="mt-3 text-sm text-gray-500">
          Supported: JPG, PNG, GIF (max 5MB)
        </p>
      </div>
      
      <!-- Error -->
      <div id="avatar-error" class="p-3 bg-red-50 border border-red-200 rounded-lg hidden">
        <p id="avatar-error-message" class="text-sm text-red-600"></p>
      </div>
      
      <!-- Actions -->
      <div class="flex gap-3 pt-2">
        <button
          type="button"
          onclick="document.getElementById('avatar-editor-modal').close()"
          class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition-colors"
        >
          Cancel
        </button>
        <button
          type="button"
          id="avatar-save-btn"
          disabled
          class="flex-1 px-4 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
        >
          <span id="avatar-spinner" class="hidden">
            <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" />
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z" />
            </svg>
          </span>
          <span id="avatar-btn-text">Save Photo</span>
        </button>
      </div>
    </div>
  </div>
  
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>

<script>
  import { actions } from 'astro:actions';

  const avatarFileInput = document.getElementById('avatar-file-input') as HTMLInputElement | null;
  const avatarPreview = document.getElementById('avatar-preview') as HTMLImageElement | null;
  const saveBtn = document.getElementById('avatar-save-btn') as HTMLButtonElement | null;
  const btnText = document.getElementById('avatar-btn-text') as HTMLSpanElement | null;
  const spinner = document.getElementById('avatar-spinner') as HTMLElement | null;
  const errorDiv = document.getElementById('avatar-error') as HTMLDivElement | null;
  const errorMessage = document.getElementById('avatar-error-message') as HTMLParagraphElement | null;

  let selectedFile: File | null = null;

  function showError(message: string) {
    if (errorMessage) errorMessage.textContent = message;
    if (errorDiv) errorDiv.classList.remove('hidden');
  }

  function hideError() {
    if (errorDiv) errorDiv.classList.add('hidden');
  }

  // Handle file selection
  avatarFileInput?.addEventListener('change', (e) => {
    hideError();
    const file = (e.target as HTMLInputElement).files?.[0];
    
    if (!file) {
      selectedFile = null;
      if (saveBtn) saveBtn.disabled = true;
      return;
    }

    // Validate file type
    if (!file.type.startsWith('image/')) {
      showError('Please select an image file (JPG, PNG, GIF)');
      selectedFile = null;
      if (saveBtn) saveBtn.disabled = true;
      return;
    }

    // Validate file size (max 5MB)
    if (file.size > 5 * 1024 * 1024) {
      showError('File size must be less than 5MB');
      selectedFile = null;
      if (saveBtn) saveBtn.disabled = true;
      return;
    }

    selectedFile = file;
    if (saveBtn) saveBtn.disabled = false;

    // Show preview
    const reader = new FileReader();
    reader.onload = (e) => {
      if (avatarPreview) avatarPreview.src = e.target?.result as string;
    };
    reader.readAsDataURL(file);
  });

  // Handle save
  saveBtn?.addEventListener('click', async () => {
    if (!selectedFile) return;

    hideError();
    if (saveBtn) saveBtn.disabled = true;
    if (btnText) btnText.textContent = 'Uploading...';
    if (spinner) spinner.classList.remove('hidden');

    try {
      // Convert file to base64
      const base64 = await new Promise<string>((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const result = reader.result as string;
          // Remove data URL prefix to get just the base64
          const base64Data = result.split(',')[1];
          resolve(base64Data);
        };
        reader.onerror = reject;
        reader.readAsDataURL(selectedFile!);
      });

      const { data, error } = await actions.user.uploadAvatarToR2({
        file: base64,
        name: selectedFile.name,
        type: selectedFile.type
      });

      if (error) {
        throw new Error(error.message);
      }

      if (!data?.url) {
        throw new Error('Failed to get avatar URL');
      }

      // Success - close modal and reload
      (document.getElementById('avatar-editor-modal') as HTMLDialogElement | null)?.close();
      window.location.reload();
    } catch (error) {
      showError(error instanceof Error ? error.message : 'Failed to upload avatar');
      if (btnText) btnText.textContent = 'Save Photo';
      if (spinner) spinner.classList.add('hidden');
      if (saveBtn) saveBtn.disabled = false;
    }
  });
</script>
