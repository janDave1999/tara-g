---
interface Props {
  username: string;
}
const { username } = Astro.props;
---

<div class="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden">

  <!-- Header -->
  <div class="px-5 py-4 border-b border-gray-100">
    <h2 class="section-title">Trips</h2>
  </div>

  <!--
    Grid container — 3×3 square cells.
    background-color shows through the 2px gap and acts as grid lines.
  -->
  <div id="publicTripGrid" class="trip-grid" role="tabpanel" aria-live="polite" aria-busy="true">
    <div style="aspect-ratio:1/1;background:#F3F4F6"></div>
    <div style="aspect-ratio:1/1;background:#F3F4F6"></div>
    <div style="aspect-ratio:1/1;background:#F3F4F6"></div>
    <div style="aspect-ratio:1/1;background:#F3F4F6"></div>
    <div style="aspect-ratio:1/1;background:#F3F4F6"></div>
    <div style="aspect-ratio:1/1;background:#F3F4F6"></div>
    <div style="aspect-ratio:1/1;background:#F3F4F6"></div>
    <div style="aspect-ratio:1/1;background:#F3F4F6"></div>
    <div style="aspect-ratio:1/1;background:#F3F4F6"></div>
  </div>

  <!-- Empty state -->
  <div id="publicTripsEmpty" class="hidden py-14 px-6 text-center">
    <div class="w-14 h-14 rounded-2xl bg-blue-50 flex items-center justify-center mb-3 mx-auto">
      <svg class="w-7 h-7 text-blue-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
    </div>
    <p class="text-sm font-semibold text-gray-700 mb-1">No trips yet</p>
    <p class="text-xs text-gray-400">This traveler hasn't created any trips.</p>
  </div>
</div>

<style>
  .section-title {
    font-size: 10px; font-weight: 700; color: #9CA3AF;
    text-transform: uppercase; letter-spacing: 0.1em;
  }

  .trip-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 2px;
    background-color: #E5E7EB;
  }
</style>

<script define:vars={{ username }}>
  const grid  = document.getElementById('publicTripGrid');
  const empty = document.getElementById('publicTripsEmpty');

  const GRID_SLOTS = 9;

  const esc = (s) =>
    s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

  const pinSvg = `<svg width="9" height="9" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
    <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
  </svg>`;

  const CELL_STYLE = `position:relative;aspect-ratio:1/1;overflow:hidden;display:block;background:#F3F4F6;cursor:pointer;text-decoration:none;`.trim();
  const IMG_STYLE  = `position:absolute;inset:0;width:100%;height:100%;object-fit:cover;object-position:center;display:block;transition:transform 0.3s ease;`.trim();
  const FALLBACK_STYLE = `position:absolute;inset:0;background:linear-gradient(135deg,#3B82F6,#2563EB);`.trim();
  const OVERLAY_STYLE  = `position:absolute;inset:0;padding:8px;background:linear-gradient(to top,rgba(0,0,0,0.60) 0%,transparent 55%);display:flex;align-items:flex-end;`.trim();
  const MORE_STYLE     = `position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;background:rgba(0,0,0,0.50);backdrop-filter:blur(2px);-webkit-backdrop-filter:blur(2px);`.trim();

  function cellHtml(trip) {
    const media = trip.cover_image_url
      ? `<img src="${esc(trip.cover_image_url)}" alt="${esc(trip.title)}" loading="lazy" style="${IMG_STYLE}"/>`
      : `<div aria-hidden="true" style="${FALLBACK_STYLE}"></div>`;

    const dest = trip.destination
      ? `<span style="display:flex;align-items:center;gap:2px;margin-top:1px;font-size:10px;color:rgba(255,255,255,0.75)">${pinSvg}${esc(trip.destination)}</span>`
      : '';

    return `
      <a href="/trips/${esc(trip.id)}" title="${esc(trip.title)}" style="${CELL_STYLE}"
         onmouseenter="this.querySelector('img')&&(this.querySelector('img').style.transform='scale(1.05)')"
         onmouseleave="this.querySelector('img')&&(this.querySelector('img').style.transform='scale(1)')">
        ${media}
        <div aria-hidden="true" style="${OVERLAY_STYLE}">
          <div style="width:100%">
            <span style="display:block;font-size:11px;font-weight:700;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(trip.title)}</span>
            ${dest}
          </div>
        </div>
      </a>`;
  }

  function moreCellHtml(trip, extraCount) {
    const media = trip.cover_image_url
      ? `<img src="${esc(trip.cover_image_url)}" alt="" aria-hidden="true" loading="lazy" style="${IMG_STYLE}"/>`
      : `<div aria-hidden="true" style="${FALLBACK_STYLE}"></div>`;

    return `
      <a href="/profile/${esc(username)}/trips" aria-label="View all trips — ${extraCount} more" style="${CELL_STYLE}">
        ${media}
        <div style="${MORE_STYLE}">
          <span style="font-size:28px;font-weight:900;color:#fff;line-height:1;letter-spacing:-0.5px">+${extraCount}</span>
          <span style="font-size:10px;font-weight:700;letter-spacing:0.1em;color:rgba(255,255,255,0.82);text-transform:uppercase">more</span>
        </div>
      </a>`;
  }

  function skeletonHtml() {
    return Array.from({ length: GRID_SLOTS })
      .map(() => `<div aria-hidden="true" style="aspect-ratio:1/1;background:#F3F4F6;animation:tripShimmer 1.4s ease-in-out infinite"></div>`)
      .join('');
  }

  async function loadTrips() {
    grid.setAttribute('aria-busy', 'true');
    grid.innerHTML = skeletonHtml();
    grid.style.display = 'grid';
    empty.style.display = 'none';

    try {
      const res   = await fetch(`/api/profile/${encodeURIComponent(username)}/trips`);
      const data  = await res.json();
      const trips = data.trips ?? [];

      grid.setAttribute('aria-busy', 'false');

      if (!trips.length) {
        grid.style.display = 'none';
        empty.style.display = 'block';
        return;
      }

      const total = trips.length;

      if (total <= GRID_SLOTS) {
        grid.innerHTML = trips.map(t => cellHtml(t)).join('');
      } else {
        const visible    = trips.slice(0, 8);
        const ninthTrip  = trips[8];
        const extraCount = total - 8;
        grid.innerHTML = visible.map(t => cellHtml(t)).join('') + moreCellHtml(ninthTrip, extraCount);
      }
    } catch {
      grid.setAttribute('aria-busy', 'false');
      grid.innerHTML = `
        <p style="grid-column:span 3;padding:2rem;text-align:center;font-size:12px;color:#9CA3AF">
          Failed to load trips.
        </p>`;
    }
  }

  if (!document.getElementById('trip-shimmer-kf')) {
    const s = document.createElement('style');
    s.id = 'trip-shimmer-kf';
    s.textContent = '@keyframes tripShimmer{0%,100%{opacity:1}50%{opacity:.45}}';
    document.head.appendChild(s);
  }

  loadTrips();
</script>
