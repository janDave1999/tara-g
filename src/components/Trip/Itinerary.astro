---
interface Location {
  name: string;
  lat: number;
  lng: number;
}

interface TripLocation {
  scheduled_start: string;
  scheduled_end: string;
  waiting_time: number;
  stop_type: string;
  location: Location | undefined;
}

interface Props {
  trip_location: TripLocation[];
  userRole: string;
  tripId: string;
}

const { userRole, tripId, trip_location = [] } = Astro.props;

// Helper: Format Date
const formatDate = (isoStr: string) => {
  const d = new Date(isoStr);
  return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
};

// Helper: Format Time
const formatTime = (isoStr: string) => {
  const d = new Date(isoStr);
  return d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
};

// Helper: Human Readable Timeline Logic
const getDisplayTime = (start: any, end: any, waiting_time: number) => {
  console.log("start", start, "end", end);

  // if waiting time is 0 then make default to 15 minutes
  if (waiting_time === 0) {
    waiting_time = 15;
  }

  // if start is null then set it to end - waiting time
  if (!start) {
    start = new Date(end).getTime() - (waiting_time * 60000);
    start = new Date(start).toISOString();
  }

  // if end is null then set it to start + waiting time
  if (!end) {
    end = new Date(start).getTime() + (waiting_time * 60000);
    end = new Date(end).toISOString();
  }
  console.log("start", start, "end", end);
  const isSameDay = start.slice(0, 10) === end?.slice(0, 10);
  if (isSameDay) {
    return `${formatDate(start)} | ${formatTime(start)} - ${formatTime(end)}`;
  }
  return `${formatDate(start)}, ${formatTime(start)} â€” ${formatDate(end)}, ${formatTime(end)}`;
};

// Sort timeline by start_time
const sortedLocations = [...trip_location].sort((a, b) => 
  new Date(a.scheduled_start).getTime() - new Date(b.scheduled_end).getTime()
);

// Category color mapping (green theme)
const categoryStyles = {
  destination: { bg: 'bg-emerald-100', text: 'text-emerald-700', dot: 'border-emerald-500' },
  activity: { bg: 'bg-green-100', text: 'text-green-700', dot: 'border-green-500' },
  lodging: { bg: 'bg-teal-100', text: 'text-teal-700', dot: 'border-teal-500' },
  transit: { bg: 'bg-lime-100', text: 'text-lime-700', dot: 'border-lime-500' },
  pickup: { bg: 'bg-cyan-100', text: 'text-cyan-700', dot: 'border-cyan-500' }
};
---

<div id="itinerary-root" class="max-w-4xl mx-auto p-4 md:p-6" data-is-owner={userRole} data-trip-id={tripId}>
  
  <!-- Header Section -->
  <div class="bg-gradient-to-br from-green-50 via-white to-emerald-50 rounded-2xl p-6 md:p-8 mb-8 border border-gray-100 shadow-xl">
    <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-4">
      <div>
        <h2 class="text-3xl font-bold text-gray-900 tracking-tight mb-1">Trip Itinerary</h2>
        <p class="text-gray-600 text-sm">Your adventure timeline</p>
      </div>
      
      <div class="flex gap-2">
        {userRole === 'owner' && (
          <>
            <button 
              id="add-stop-btn" 
              class="hidden items-center gap-2 px-4 py-2.5 bg-white/60 backdrop-blur-sm hover:bg-white border border-gray-200 rounded-xl text-sm font-semibold text-gray-700 transition-all shadow-sm focus:ring-2 focus:ring-green-500 focus:outline-none"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              Add Stop
            </button>
            <button 
              id="toggle-mode-btn" 
              class="px-5 py-2.5 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white rounded-xl text-sm font-semibold transition-all shadow-lg shadow-green-500/30 focus:ring-2 focus:ring-green-500 focus:outline-none"
            >
              Edit Timeline
            </button>
          </>
        )}
      </div>
    </div>
  </div>

  <!-- Timeline Container -->
  <div id="timeline-container" class="space-y-6 relative ml-6 md:ml-8">
    <!-- Vertical Line -->
    <div class="absolute left-0 top-0 bottom-0 w-0.5 bg-gradient-to-b from-green-200 via-emerald-200 to-teal-200"></div>
    
    {sortedLocations.map((item) => {
      const style = categoryStyles[item.stop_type as keyof typeof categoryStyles] || categoryStyles.activity;
      
      return (
        <div class="timeline-item relative group pl-8 md:pl-10">
          <!-- Timeline Dot -->
          <div class={`absolute -left-[9px] top-2 w-5 h-5 bg-white border-4 ${style.dot} rounded-full group-hover:scale-125 transition-transform z-10 shadow-sm`}></div>

          <!-- Card -->
          <div class="bg-white border border-gray-100 rounded-2xl p-5 md:p-6 shadow-md hover:shadow-xl transition-all">
            
            <!-- View Mode -->
            <div class="view-mode">
              <div class="flex flex-col md:flex-row md:justify-between md:items-start gap-3">
                <div class="space-y-2 flex-1">
                  <span class={`inline-flex items-center px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider ${style.bg} ${style.text}`}>
                    {item.stop_type}
                  </span>
                  <h3 class="text-xl font-bold text-gray-900 leading-tight">
                    {item.location?.name || 'Unnamed Stop'}
                  </h3>
                  <p class="text-sm text-gray-600 font-medium flex items-center gap-2">
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    {getDisplayTime(item.scheduled_start, item.scheduled_end, item.waiting_time)}
                  </p>
                </div>
                
                {item.stop_type !== 'destination' && item.waiting_time > 0 && (
                  <div class="flex items-center gap-2 px-4 py-2 bg-gradient-to-br from-amber-50 to-orange-50 rounded-xl border border-amber-100">
                    <svg class="w-4 h-4 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <div>
                      <p class="text-[10px] font-bold text-amber-600 uppercase tracking-wide">Wait Time</p>
                      <p class="text-sm font-bold text-amber-700">{item.waiting_time} mins</p>
                    </div>
                  </div>
                )}
              </div>
            </div>

            <!-- Edit Mode -->
            {userRole === 'owner' && (
              <form class="edit-mode hidden space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div class="space-y-2">
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wide">Category</label>
                    <select 
                      name="type" 
                      class="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl text-sm font-medium text-gray-700 outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all"
                    >
                      <option value="pickup" selected={item.stop_type === 'pickup'}>Pickup</option>
                      <option value="transit" selected={item.stop_type === 'transit'}>Transit</option>
                      <option value="activity" selected={item.stop_type === 'activity'}>Activity</option>
                      <option value="lodging" selected={item.stop_type === 'lodging'}>Lodging</option>
                      <option value="dropoff" selected={item.stop_type === 'dropoff'}>Drop-off</option>
                      <option value="destination" selected={item.stop_type === 'destination'}>Destination</option>
                    </select>
                  </div>
                  <div class="space-y-2">
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wide">Waiting Time (min)</label>
                    <input 
                      type="number" 
                      name="waiting_time" 
                      value={item.waiting_time} 
                      class="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl text-sm font-medium text-gray-700 outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all"
                    />
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div class="space-y-2">
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wide">Start Date/Time</label>
                    <input 
                      type="datetime-local" 
                      name="start_time" 
                      value={(item?.scheduled_start || '').slice(0, 16)} 
                      class="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl text-sm font-medium text-gray-700 outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all"
                    />
                  </div>
                  <div class="space-y-2">
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wide">End Date/Time</label>
                    <input 
                      type="datetime-local" 
                      name="end_time" 
                      value={"item?.scheduled_end.slice(0, 16)"} 
                      class="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl text-sm font-medium text-gray-700 outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all"
                    />
                  </div>
                </div>

                <div class="space-y-2">
                  <label class="text-xs font-bold text-gray-500 uppercase tracking-wide">Location Name</label>
                  <input 
                    type="text" 
                    name="location_name" 
                    value={item.location?.name || ''} 
                    class="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl text-sm font-medium text-gray-700 outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all" 
                    placeholder="e.g. Airport, Hotel, Attraction" 
                  />
                  <input type="hidden" name="lat" value={item.location?.lat || 0} />
                  <input type="hidden" name="lng" value={item.location?.lng || 0} />
                </div>

                <div class="flex justify-between items-center pt-4 border-t border-gray-100">
                  <button 
                    type="button" 
                    class="delete-btn px-4 py-2 text-sm text-red-600 hover:bg-red-50 rounded-lg font-semibold transition-all focus:ring-2 focus:ring-red-500 focus:outline-none"
                  >
                    Delete Stop
                  </button>
                  <button 
                    type="button" 
                    class="save-btn px-6 py-2.5 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white text-sm font-semibold rounded-xl shadow-lg shadow-green-500/30 transition-all focus:ring-2 focus:ring-green-500 focus:outline-none"
                  >
                    Save Stop
                  </button>
                </div>
              </form>
            )}
          </div>
        </div>
      );
    })}
  </div>

  <!-- New Stop Template -->
  <template id="new-stop-template">
    <div class="timeline-item relative group pl-8 md:pl-10 animate-in fade-in slide-in-from-left-4">
      <div class="absolute -left-[9px] top-2 w-5 h-5 bg-gradient-to-br from-green-500 to-emerald-500 border-4 border-green-200 rounded-full z-10 shadow-lg"></div>
      
      <div class="bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-dashed border-green-300 rounded-2xl p-5 md:p-6 shadow-md">
        <h4 class="text-green-700 font-bold text-base mb-4 flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
          New Stop Information
        </h4>
        
        <form class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <select 
              name="type" 
              class="w-full px-4 py-2.5 bg-white border border-green-200 rounded-xl text-sm font-medium text-gray-700 outline-none focus:ring-2 focus:ring-green-500 transition-all"
            >
              <option value="activity">Activity</option>
              <option value="transit">Transit</option>
              <option value="lodging">Lodging</option>
              <option value="destination">Destination</option>
            </select>
            <input 
              type="number" 
              name="waiting_time" 
              placeholder="Wait time (mins)" 
              class="w-full px-4 py-2.5 bg-white border border-green-200 rounded-xl text-sm font-medium placeholder:text-gray-400 outline-none focus:ring-2 focus:ring-green-500 transition-all" 
            />
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input 
              type="datetime-local" 
              name="start_time" 
              class="w-full px-4 py-2.5 bg-white border border-green-200 rounded-xl text-sm font-medium outline-none focus:ring-2 focus:ring-green-500 transition-all" 
            />
            <input 
              type="datetime-local" 
              name="end_time" 
              class="w-full px-4 py-2.5 bg-white border border-green-200 rounded-xl text-sm font-medium outline-none focus:ring-2 focus:ring-green-500 transition-all" 
            />
          </div>
          
          <input 
            type="text" 
            name="location_name" 
            placeholder="Enter location name..." 
            class="w-full px-4 py-2.5 bg-white border border-green-200 rounded-xl text-sm font-medium placeholder:text-gray-400 outline-none focus:ring-2 focus:ring-green-500 transition-all" 
          />
          
          <div class="flex justify-end gap-3 pt-2">
            <button 
              type="button" 
              class="cancel-new-btn px-4 py-2 text-sm text-gray-600 hover:bg-white/50 rounded-lg font-semibold transition-all focus:ring-2 focus:ring-gray-500 focus:outline-none"
            >
              Cancel
            </button>
            <button 
              type="button" 
              class="save-btn px-6 py-2.5 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white text-sm font-semibold rounded-xl shadow-lg shadow-green-500/30 transition-all focus:ring-2 focus:ring-green-500 focus:outline-none"
            >
              Create Stop
            </button>
          </div>
        </form>
      </div>
    </div>
  </template>
</div>

<script>
  function initItinerary() {
    const root = document.getElementById('itinerary-root');
    const container = document.getElementById('timeline-container');
    const template = document.getElementById('new-stop-template') as HTMLTemplateElement;
    
    if (!root || !container || !template) return;

    const toggleBtn = document.getElementById('toggle-mode-btn');
    const addBtn = document.getElementById('add-stop-btn');
    const isOwner = root.dataset.isOwner === 'owner' ? true : false;

    if (!isOwner) return;

    let isEditing = false;

    // Toggle Edit Mode
    toggleBtn?.addEventListener('click', () => {
      isEditing = !isEditing;
      toggleBtn.innerText = isEditing ? 'Finish Editing' : 'Edit Timeline';
      toggleBtn.className = isEditing 
        ? 'px-5 py-2.5 bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-700 hover:to-orange-700 text-white rounded-xl text-sm font-semibold transition-all shadow-lg shadow-amber-500/30 focus:ring-2 focus:ring-amber-500 focus:outline-none'
        : 'px-5 py-2.5 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white rounded-xl text-sm font-semibold transition-all shadow-lg shadow-green-500/30 focus:ring-2 focus:ring-green-500 focus:outline-none';
      
      addBtn?.classList.toggle('hidden', !isEditing);
      addBtn?.classList.toggle('flex', isEditing);

      document.querySelectorAll('.view-mode').forEach(el => el.classList.toggle('hidden', isEditing));
      document.querySelectorAll('.edit-mode').forEach(el => el.classList.toggle('hidden', !isEditing));
    });

    // Add New Stop to DOM
    addBtn?.addEventListener('click', () => {
      const clone = template.content.cloneNode(true) as any;
      const now = new Date().toISOString().slice(0, 16);
      clone.querySelectorAll('input[type="datetime-local"]').forEach((input: any) => input.value = now);
      
      container.prepend(clone);
    });

    // Event Delegation for Save/Delete/Cancel
    root.addEventListener('click', async (e) => {
      const target = e.target as HTMLElement;

      // CANCEL NEW
      if (target.classList.contains('cancel-new-btn')) {
        target.closest('.timeline-item')?.remove();
      }

      // DELETE
      if (target.classList.contains('delete-btn')) {
        if (confirm("Remove this stop from your itinerary?")) {
          target.closest('.timeline-item')?.remove();
          // TODO: Call Action to delete from DB
        }
      }

      // SAVE (New or Existing)
      if (target.classList.contains('save-btn')) {
        const form = target.closest('form');
        const item = target.closest('.timeline-item');
        if (!form || !item) return;

        const formData = new FormData(form);
        const payload = {
          start_time: formData.get('start_time'),
          end_time: formData.get('end_time'),
          waiting_time: Number(formData.get('waiting_time')),
          type: formData.get('type'),
          locations: {
            name: formData.get('location_name'),
            lat: Number(formData.get('lat')) || 0,
            lng: Number(formData.get('lng')) || 0
          }
        };

        target.innerText = "Saving...";
        target.setAttribute('disabled', 'true');

        console.log("Submitting to Astro Action:", payload);
        
        // Example Action Call:
        // const { data, error } = await actions.trip.updateItinerary({ tripId, payload });
        
        setTimeout(() => {
          target.innerText = "Saved!";
          window.location.reload();
        }, 800);
      }
    });
  }

  // Load logic
  initItinerary();
  document.addEventListener('astro:page-load', initItinerary);
</script>