---
import StopCard from './StopCard.astro';
import type { ItineraryStop } from '@/types/itinerary';
import { formatDate } from '@/utility/dateFormatter';

interface Props {
  dayIndex: number;
  stops: ItineraryStop[];
  isOwner: boolean;
}

const { dayIndex, stops, isOwner } = Astro.props;
const firstStop = stops[0];
const dayDate = firstStop?.scheduled_start ? formatDate(firstStop.scheduled_start) : firstStop?.scheduled_end ? formatDate(firstStop.scheduled_end) : '';
---

<div class="day-section mb-6" data-day-index={dayIndex}>

  <!-- Day Header -->
  <div class="day-header flex items-center gap-3 py-2.5 cursor-pointer select-none group mb-4">
    <div class="w-7 h-7 rounded-full bg-gray-100 group-hover:bg-gray-200 transition-colors flex items-center justify-center text-xs font-bold text-gray-600 shrink-0">
      {dayIndex + 1}
    </div>
    <div class="flex-1 min-w-0">
      <span class="text-sm font-bold text-gray-800">Day {dayIndex + 1}</span>
      {dayDate && <span class="text-xs text-gray-400 ml-2">{dayDate}</span>}
    </div>
    <span class="text-xs text-gray-400 font-medium shrink-0">
      {stops.length} {stops.length === 1 ? 'stop' : 'stops'}
    </span>
    {isOwner && (
      <button
        class="add-stop-btn hidden items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-semibold text-blue-600 hover:bg-blue-50 transition-colors"
        data-day-index={dayIndex}
      >
        <svg class="w-3 h-3 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        Add Stop
      </button>
    )}
    <svg class="w-4 h-4 text-gray-400 chevron-icon shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
    </svg>
  </div>

  <!-- Timeline Container -->
  <div class="timeline-container relative ml-5" data-day={dayIndex}>
    <!-- Vertical line -->
    <div class="absolute left-0 top-0 bottom-0 w-px bg-gray-200"></div>

    {stops.map((completeStops) => (
      <StopCard
        completeStop={completeStops}
        isOwner={isOwner}
      />
    ))}
  </div>
</div>

<style>
  .chevron-icon {
    transition: transform 0.3s ease;
  }
  :global(.rotate-180) {
    transform: rotate(180deg);
  }
</style>
