---
import { obfuscate } from "@/lib/obfuscate";

// 1. Get real data from Props
const { member } = Astro.props;
let currentUserId = Astro.locals.user_id || "";

// 2. Transform data for secure client-side use
const secureMembers = member?.map((m: any) => ({
  role: m.role,
  status: m.member_status,
  fullName: m.full_name,
  displayId: m.user_id.slice(0, 8),
  // Obfuscated ID for secure operations
  secureId: obfuscate(m.user_id),
  // Flag to identify current user without exposing full ID
  isCurrentUser: m.user_id === currentUserId
}));

// 3. Determine current user's role
const currentUserMember = member?.find((m: any) => m.user_id === currentUserId);
const userRole = currentUserMember?.role || 'visitor';
const isOwner = userRole === 'owner';
---

<div 
  id="members-data-container" 
  data-members={JSON.stringify(secureMembers)}
  data-user-role={userRole}
>
  <!-- <button class="btn btn-sm" id="member-btn">
    Members
  </button> -->
</div>

<div 
  id="members-modal" 
  class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm"
>
  <div class="bg-white w-full max-w-2xl rounded-xl shadow-2xl overflow-hidden flex flex-col animate-in fade-in zoom-in duration-200">
    
    <!-- Header -->
    <div class="px-6 py-4 border-b border-slate-100 flex items-center justify-between bg-slate-50/50">
      <div>
        <h3 class="text-lg font-bold text-slate-800">Trip Members</h3>
        <p id="role-indicator" class="text-xs text-slate-500 italic"></p>
      </div>
      <button 
        id="close-modal" 
        class="text-slate-400 hover:text-slate-600 transition-colors p-2 hover:bg-slate-100 rounded-full"
        aria-label="Close modal"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <!-- Table -->
    <div class="overflow-y-auto max-h-[400px]">
      <table class="w-full text-left border-separate border-spacing-0">
        <thead class="sticky top-0 bg-white shadow-[0_1px_0_rgba(0,0,0,0.05)] z-10">
          <tr id="table-headers">
            <!-- Headers will be dynamically populated -->
          </tr>
        </thead>
        <tbody id="members-list" class="divide-y divide-slate-100"></tbody>
      </table>
    </div>

    <!-- Footer -->
    <div class="px-6 py-4 border-t border-slate-100 bg-slate-50/50 text-right">
      <!-- Invite button -->
      <button id="invite-btn" class="px-4 py-2 text-sm font-semibold text-blue-700 hover:bg-blue-200 rounded-lg transition-colors">
        Invite Members
      </button>
      <button 
        id="close-modal-btn" 
        class="px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-200 rounded-lg transition-colors"
      >
        Close
      </button>
    </div>
  </div>
</div>

<!-- Invite Modal (Messenger-style) -->
<div 
  id="invite-modal" 
  class="fixed inset-0 z-[60] hidden items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm"
>
  <div class="bg-white w-full max-w-lg rounded-xl shadow-2xl overflow-hidden flex flex-col animate-in fade-in zoom-in duration-200">
    
    <!-- Header -->
    <div class="px-6 py-4 border-b border-slate-100 flex items-center justify-between bg-slate-50/50">
      <div>
        <h3 class="text-lg font-bold text-slate-800">Invite to Trip</h3>
        <p class="text-xs text-slate-500">Search by name or email</p>
      </div>
      <button 
        id="close-invite-modal" 
        class="text-slate-400 hover:text-slate-600 transition-colors p-2 hover:bg-slate-100 rounded-full"
        aria-label="Close"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <!-- Search Input -->
    <div class="px-6 py-4 border-b border-slate-100">
      <div class="relative">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <input 
          type="text" 
          id="invite-search"
          placeholder="Search people by name or email..."
          class="w-full pl-10 pr-4 py-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
        />
      </div>

      <!-- Selected Users Pills -->
      <div id="selected-users" class="mt-3 flex flex-wrap gap-2 empty:hidden"></div>
    </div>

    <!-- Suggestions List -->
    <div class="px-6 py-3 bg-slate-50/50">
      <h4 class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">Suggestions</h4>
    </div>

    <!-- Scrollable User List -->
    <div class="overflow-y-auto max-h-[300px] px-2">
      <div id="invite-suggestions" class="divide-y divide-slate-100"></div>
      <div id="invite-search-results" class="divide-y divide-slate-100"></div>
    </div>

    <!-- Footer -->
    <div class="px-6 py-4 border-t border-slate-100 bg-slate-50/50 flex items-center justify-between">
      <div class="text-sm text-slate-600">
        <span id="selected-count">0</span> selected
      </div>
      <div class="flex gap-2">
        <button 
          id="cancel-invite-btn" 
          class="px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-200 rounded-lg transition-colors"
        >
          Cancel
        </button>
        <button 
          id="send-invite-btn" 
          class="px-4 py-2 text-sm font-semibold bg-blue-600 text-white hover:bg-blue-700 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          disabled
        >
          Send Invitations
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  import { deobfuscate } from "@/lib/obfuscate";

  // ===== Mock Data for Suggestions =====
  const MOCK_SUGGESTIONS = [
    { id: 'user_001', name: 'Sarah Johnson', email: 'sarah.j@email.com', avatar: 'SJ', relation: 'From previous trip to Bali' },
    { id: 'user_002', name: 'Michael Chen', email: 'mchen@email.com', avatar: 'MC', relation: 'From previous trip to Tokyo' },
    { id: 'user_003', name: 'Emma Wilson', email: 'emma.w@email.com', avatar: 'EW', relation: 'From previous trip to Paris' },
    { id: 'user_004', name: 'James Rodriguez', email: 'jrod@email.com', avatar: 'JR', relation: 'Suggested based on interests' },
  ];

  // Mock searchable users (simulating API search)
  const MOCK_SEARCHABLE_USERS = [
    { id: 'user_005', name: 'Olivia Brown', email: 'olivia.b@email.com', avatar: 'OB' },
    { id: 'user_006', name: 'Daniel Kim', email: 'daniel.kim@email.com', avatar: 'DK' },
    { id: 'user_007', name: 'Sophia Martinez', email: 'sophia.m@email.com', avatar: 'SM' },
    { id: 'user_008', name: 'Alex Turner', email: 'alex.t@email.com', avatar: 'AT' },
  ];

  // ===== Configuration =====
  const STATUS_CONFIG: Record<string, string> = {
    pending: 'bg-amber-100 text-amber-700 ring-amber-600/20',
    joined: 'bg-emerald-100 text-emerald-700 ring-emerald-600/20',
    invited: 'bg-blue-100 text-blue-700 ring-blue-600/20',
    left: 'bg-slate-100 text-slate-700 ring-slate-600/20'
  };

  // ===== Data Initialization =====
  const container = document.getElementById('members-data-container');
  const rawMembers = container?.getAttribute('data-members');
  const userRole = container?.getAttribute('data-user-role') || 'visitor';

  let tripMembers = rawMembers ? JSON.parse(rawMembers) : [];
  const isOwner = userRole === 'owner';

  // Invite modal state
  let selectedUsers: Set<string> = new Set();

  // ===== DOM Elements =====
  const modal = document.getElementById('members-modal') as HTMLDivElement;
  const membersList = document.getElementById('members-list') as HTMLTableSectionElement;
  const tableHeaders = document.getElementById('table-headers') as HTMLTableRowElement;
  const roleIndicator = document.getElementById('role-indicator') as HTMLParagraphElement;

  // Invite modal elements
  const inviteModal = document.getElementById('invite-modal') as HTMLDivElement;
  const inviteSearch = document.getElementById('invite-search') as HTMLInputElement;
  const inviteSuggestions = document.getElementById('invite-suggestions') as HTMLDivElement;
  const inviteSearchResults = document.getElementById('invite-search-results') as HTMLDivElement;
  const selectedUsersContainer = document.getElementById('selected-users') as HTMLDivElement;
  const selectedCountSpan = document.getElementById('selected-count') as HTMLSpanElement;
  const sendInviteBtn = document.getElementById('send-invite-btn') as HTMLButtonElement;

  // ===== Table Setup =====
  function setupTableStructure() {
    const roleText = isOwner 
      ? "You are the Owner (Full Access)" 
      : userRole === 'member' 
        ? "Viewing as Member" 
        : "Viewing as Visitor";
    
    roleIndicator.textContent = roleText;

    // Build headers based on role
    let headersHTML = `
      <th class="px-6 py-3 text-xs font-semibold uppercase tracking-wider text-slate-500">Member</th>
      <th class="px-6 py-3 text-xs font-semibold uppercase tracking-wider text-slate-500">Role</th>
    `;

    if (isOwner) {
      headersHTML += `
        <th class="px-6 py-3 text-xs font-semibold uppercase tracking-wider text-slate-500">Status</th>
        <th class="px-6 py-3 text-xs font-semibold uppercase tracking-wider text-slate-500 text-right">Actions</th>
      `;
    }

    tableHeaders.innerHTML = headersHTML;
  }

  // ===== Render Members =====
  function renderMembers() {
    membersList.innerHTML = '';

    tripMembers.forEach((member: any) => {
      const row = document.createElement('tr');
      row.className = 'hover:bg-slate-50/80 transition-colors';

      // User column
      let rowHTML = `
        <td class="px-6 py-4">
          <div class="flex flex-col">
            <span class="text-sm font-medium text-slate-800">
              ${member.isCurrentUser ? 'You' : member.fullName}
            </span>
          </div>
        </td>
        <td class="px-6 py-4">
          <span class="inline-flex items-center rounded-md px-2 py-1 text-xs font-medium bg-slate-100 text-slate-700 ring-1 ring-inset ring-slate-600/20 capitalize">
            ${member.role}
          </span>
        </td>
      `;

      // Owner-only columns
      if (isOwner) {
        rowHTML += `
          <td class="px-6 py-4">
            <span class="inline-flex items-center rounded-md px-2 py-1 text-xs font-medium ring-1 ring-inset ${STATUS_CONFIG[member.status] || STATUS_CONFIG.pending} capitalize">
              ${member.status}
            </span>
          </td>
          <td class="px-6 py-4 text-right">
            <div class="flex justify-end gap-2 action-container"></div>
          </td>
        `;
      }

      row.innerHTML = rowHTML;

      // Add action buttons for owners (excluding current user)
      if (isOwner && !member.isCurrentUser) {
        const actionContainer = row.querySelector('.action-container') as HTMLDivElement;
        
        if (member.status === 'pending') {
          actionContainer.appendChild(
            createButton('Accept', 'bg-emerald-600 hover:bg-emerald-700 text-white', 
              () => handleUpdateStatus(member.secureId, 'joined'))
          );
          actionContainer.appendChild(
            createButton('Reject', 'border border-slate-300 hover:bg-slate-100 text-slate-700', 
              () => handleUpdateStatus(member.secureId, 'left'))
          );
        } else if (member.status === 'joined') {
          actionContainer.appendChild(
            createButton('Kick', 'text-red-600 hover:bg-red-50 border border-red-200', 
              () => handleKick(member.secureId))
          );
        }
      }

      membersList.appendChild(row);
    });
  }

  // ===== Invite Modal Functions =====
  function renderSuggestions() {
    inviteSuggestions.innerHTML = '';
    
    // Filter out already invited/joined members
    const existingMemberEmails = tripMembers.map((m: any) => m.email);
    const availableSuggestions = MOCK_SUGGESTIONS.filter(
      user => !existingMemberEmails.includes(user.email)
    );

    availableSuggestions.forEach(user => {
      inviteSuggestions.appendChild(createUserItem(user, true));
    });
  }

  function createUserItem(user: any, showRelation = false) {
    const div = document.createElement('div');
    const isSelected = selectedUsers.has(user.id);
    
    div.className = `flex items-center justify-between p-3 hover:bg-slate-50 cursor-pointer transition-colors ${isSelected ? 'bg-blue-50' : ''}`;
    div.innerHTML = `
      <div class="flex items-center gap-3 flex-1">
        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-semibold text-sm flex-shrink-0">
          ${user.avatar}
        </div>
        <div class="flex-1 min-w-0">
          <div class="text-sm font-medium text-slate-800 truncate">${user.name}</div>
          <div class="text-xs text-slate-500 truncate">${user.email}</div>
          ${showRelation && user.relation ? `<div class="text-xs text-slate-400 mt-0.5 truncate">${user.relation}</div>` : ''}
        </div>
      </div>
      <div class="checkbox-container flex-shrink-0">
        <input type="checkbox" ${isSelected ? 'checked' : ''} class="w-5 h-5 text-blue-600 rounded border-slate-300 focus:ring-blue-500">
      </div>
    `;

    div.addEventListener('click', () => toggleUserSelection(user, div));
    return div;
  }

  function toggleUserSelection(user: any, element: HTMLDivElement) {
    const checkbox = element.querySelector('input[type="checkbox"]') as HTMLInputElement;
    
    if (selectedUsers.has(user.id)) {
      selectedUsers.delete(user.id);
      checkbox.checked = false;
      element.classList.remove('bg-blue-50');
    } else {
      selectedUsers.add(user.id);
      checkbox.checked = true;
      element.classList.add('bg-blue-50');
    }
    
    updateSelectedDisplay();
  }

  function updateSelectedDisplay() {
    selectedUsersContainer.innerHTML = '';
    selectedCountSpan.textContent = selectedUsers.size.toString();
    sendInviteBtn.disabled = selectedUsers.size === 0;

    selectedUsers.forEach(userId => {
      const user = [...MOCK_SUGGESTIONS, ...MOCK_SEARCHABLE_USERS].find(u => u.id === userId);
      if (!user) return;

      const pill = document.createElement('div');
      pill.className = 'inline-flex items-center gap-2 px-3 py-1.5 bg-blue-100 text-blue-800 rounded-full text-sm';
      pill.innerHTML = `
        <span class="font-medium">${user.name}</span>
        <button class="hover:bg-blue-200 rounded-full p-0.5 transition-colors" data-user-id="${user.id}">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      `;

      const removeBtn = pill.querySelector('button') as HTMLButtonElement;
      removeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        selectedUsers.delete(userId);
        updateSelectedDisplay();
        renderSuggestions();
      });

      selectedUsersContainer.appendChild(pill);
    });
  }

  function handleSearch(query: string) {
    if (!query.trim()) {
      inviteSearchResults.innerHTML = '';
      inviteSearchResults.classList.add('hidden');
      inviteSuggestions.classList.remove('hidden');
      return;
    }

    // Simulate search
    const results = MOCK_SEARCHABLE_USERS.filter(user => 
      user.name.toLowerCase().includes(query.toLowerCase()) ||
      user.email.toLowerCase().includes(query.toLowerCase())
    );

    inviteSuggestions.classList.add('hidden');
    inviteSearchResults.classList.remove('hidden');
    inviteSearchResults.innerHTML = '';

    if (results.length === 0) {
      inviteSearchResults.innerHTML = `
        <div class="p-8 text-center text-slate-500">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 mx-auto mb-3 text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <p class="text-sm">No users found</p>
          <p class="text-xs mt-1">Try a different search term</p>
        </div>
      `;
    } else {
      results.forEach(user => {
        inviteSearchResults.appendChild(createUserItem(user, false));
      });
    }
  }

  async function sendInvitations() {
    const selectedUsersList = Array.from(selectedUsers).map(userId => {
      return [...MOCK_SUGGESTIONS, ...MOCK_SEARCHABLE_USERS].find(u => u.id === userId);
    }).filter(Boolean);

    console.log('Sending invitations to:', selectedUsersList);

    // TODO: Replace with actual API call
    // const response = await fetch('/api/trip/send-invitations', {
    //   method: 'POST',
    //   headers: { 'Content-Type': 'application/json' },
    //   body: JSON.stringify({ 
    //     tripId: 'current-trip-id',
    //     invitees: selectedUsersList.map(u => ({ id: u.id, email: u.email }))
    //   })
    // });

    // Simulate success
    alert(`Invitations sent to ${selectedUsersList.length} people!`);
    
    // Reset and close
    selectedUsers.clear();
    updateSelectedDisplay();
    inviteSearch.value = '';
    handleSearch('');
    closeInviteModal();
  }

  function openInviteModal() {
    inviteModal.classList.remove('hidden');
    inviteModal.classList.add('flex');
    selectedUsers.clear();
    updateSelectedDisplay();
    renderSuggestions();
    inviteSearch.focus();
  }

  function closeInviteModal() {
    inviteModal.classList.add('hidden');
    inviteModal.classList.remove('flex');
    inviteSearch.value = '';
    handleSearch('');
  }

  // ===== Action Handlers =====
  async function handleUpdateStatus(secureId: string, status: string) {
    try {
      const userId = deobfuscate(secureId);
      
      // TODO: Replace with actual API call
      const member = tripMembers.find((m: any) => m.secureId === secureId);
      if (member) {
        member.status = status;
        renderMembers();
      }
    } catch (error) {
      console.error('Failed to update member status:', error);
      alert('Failed to update member status. Please try again.');
    }
  }

  async function handleKick(secureId: string) {
    if (!confirm("Are you sure you want to remove this member from the trip?")) return;
    
    try {
      const userId = deobfuscate(secureId);
      
      // TODO: Replace with actual API call
      tripMembers = tripMembers.filter((m: any) => m.secureId !== secureId);
      renderMembers();
    } catch (error) {
      console.error('Failed to remove member:', error);
      alert('Failed to remove member. Please try again.');
    }
  }

  // ===== Utility Functions =====
  function createButton(text: string, classes: string, onClick: () => void) {
    const btn = document.createElement('button');
    btn.className = `text-xs px-3 py-1.5 rounded-md font-semibold transition-all ${classes}`;
    btn.textContent = text;
    btn.onclick = onClick;
    return btn;
  }

  // ===== Event Listeners =====
  
  // Members modal
  document.getElementById('member-btn')?.addEventListener('click', () => {
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    setupTableStructure();
    renderMembers();
  });

  [document.getElementById('close-modal'), document.getElementById('close-modal-btn')].forEach(btn => {
    btn?.addEventListener('click', () => {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    });
  });

  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }
  });

  // Invite modal triggers
  document.getElementById('invite-btn')?.addEventListener('click', openInviteModal);

  [document.getElementById('close-invite-modal'), document.getElementById('cancel-invite-btn')].forEach(btn => {
    btn?.addEventListener('click', closeInviteModal);
  });

  inviteModal.addEventListener('click', (e) => {
    if (e.target === inviteModal) closeInviteModal();
  });

  // Search functionality
  let searchTimeout: any;
  inviteSearch?.addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      handleSearch((e.target as HTMLInputElement).value);
    }, 300);
  });

  // Send invitations
  sendInviteBtn?.addEventListener('click', sendInvitations);

  // Close modals on Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (!inviteModal.classList.contains('hidden')) {
        closeInviteModal();
      } else if (!modal.classList.contains('hidden')) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
    }
  });
</script>