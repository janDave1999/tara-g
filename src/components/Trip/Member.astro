---
interface Props {
  tripId: string;
}
const { tripId } = Astro.props;
---

<div id="members-data-container" data-trip-id={tripId}></div>

<!-- Members Modal -->
<div 
  id="members-modal" 
  class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm"
>
  <div class="bg-white w-full max-w-3xl rounded-xl shadow-2xl overflow-hidden flex flex-col animate-in fade-in zoom-in duration-200">
    
    <!-- Header -->
    <div class="px-6 py-4 border-b border-slate-100 flex items-center justify-between bg-slate-50/50">
      <div>
        <h3 class="text-lg font-bold text-slate-800">Trip Members</h3>
        <p id="members-summary" class="text-xs text-slate-500"></p>
      </div>
      <button 
        id="close-modal" 
        class="text-slate-400 hover:text-slate-600 transition-colors p-2 hover:bg-slate-100 rounded-full"
        aria-label="Close modal"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <!-- Loading State -->
    <div id="members-loading" class="p-8 text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
      <p class="text-sm text-slate-500 mt-3">Loading members...</p>
    </div>

    <!-- Tabs -->
    <div id="members-tabs" class="hidden border-b border-slate-200 px-6">
      <div class="flex gap-4">
        <button class="tab-btn active" data-tab="members">
          Members <span id="members-count" class="ml-1 text-xs"></span>
        </button>
        <button class="tab-btn hidden" data-tab="requests" id="requests-tab">
          Requests <span id="requests-count" class="ml-1 text-xs bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full hidden"></span>
        </button>
        <button class="tab-btn hidden" data-tab="invitations" id="invitations-tab">
          Invited <span id="invitations-count" class="ml-1 text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full hidden"></span>
        </button>
      </div>
    </div>

    <!-- Content -->
    <div class="overflow-y-auto max-h-[500px]">
      <!-- Members Tab -->
      <div id="tab-members" class="tab-content">
        <table class="w-full text-left">
          <thead class="sticky top-0 bg-white border-b border-slate-200">
            <tr>
              <th class="px-6 py-3 text-xs font-semibold uppercase tracking-wider text-slate-500">Member</th>
              <th class="px-6 py-3 text-xs font-semibold uppercase tracking-wider text-slate-500">Role</th>
              <th class="px-6 py-3 text-xs font-semibold uppercase tracking-wider text-slate-500">Status</th>
              <th class="px-6 py-3 text-xs font-semibold uppercase tracking-wider text-slate-500 text-right">Actions</th>
            </tr>
          </thead>
          <tbody id="members-list" class="divide-y divide-slate-100"></tbody>
        </table>
      </div>

      <!-- Requests Tab -->
      <div id="tab-requests" class="tab-content hidden">
        <div id="requests-list" class="divide-y divide-slate-100"></div>
        <div id="requests-empty" class="p-8 text-center text-slate-500 hidden">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 mx-auto mb-3 text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          <p class="text-sm">No pending requests</p>
        </div>
      </div>

      <!-- Invitations Tab -->
      <div id="tab-invitations" class="tab-content hidden">
        <div id="invitations-list" class="divide-y divide-slate-100"></div>
        <div id="invitations-empty" class="p-8 text-center text-slate-500 hidden">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 mx-auto mb-3 text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
          </svg>
          <p class="text-sm">No pending invitations</p>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="px-6 py-4 border-t border-slate-100 bg-slate-50/50 flex justify-between items-center">
      <div id="available-spots" class="text-xs text-slate-600"></div>
      <div class="flex gap-2">
        <button id="invite-btn" class="px-4 py-2 text-sm font-semibold text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors hidden">
          Invite Members
        </button>
        <button 
          id="close-modal-btn" 
          class="px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-200 rounded-lg transition-colors"
        >
          Close
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Invite Modal -->
<div 
  id="invite-modal" 
  class="fixed inset-0 z-[60] hidden items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm"
>
  <div class="bg-white w-full max-w-lg rounded-xl shadow-2xl overflow-hidden flex flex-col">
    <div class="px-6 py-4 border-b border-slate-100 flex items-center justify-between bg-slate-50/50">
      <div>
        <h3 class="text-lg font-bold text-slate-800">Invite to Trip</h3>
        <p class="text-xs text-slate-500">Search by name or email</p>
      </div>
      <button id="close-invite-modal" class="text-slate-400 hover:text-slate-600 transition-colors p-2 hover:bg-slate-100 rounded-full">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <div class="px-6 py-4 border-b border-slate-100">
      <div class="relative">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <input 
          type="text" 
          id="invite-search"
          placeholder="Search people by name or email..."
          class="w-full pl-10 pr-4 py-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
        />
      </div>
      <div id="selected-users" class="mt-3 flex flex-wrap gap-2 empty:hidden"></div>
    </div>

    <div class="px-6 py-3 bg-slate-50/50">
      <h4 class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">Suggestions</h4>
    </div>

    <div class="overflow-y-auto max-h-[300px] px-2">
      <div id="invite-suggestions" class="divide-y divide-slate-100">
        <div id="suggestions-loading" class="p-8 text-center">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
          <p class="text-sm text-slate-500 mt-2">Loading suggestions...</p>
        </div>
      </div>
      <div id="invite-search-results" class="divide-y divide-slate-100 hidden"></div>
    </div>

    <div class="px-6 py-4 border-t border-slate-100 bg-slate-50/50 flex items-center justify-between">
      <div class="text-sm text-slate-600">
        <span id="selected-count">0</span> selected
      </div>
      <div class="flex gap-2">
        <button 
          id="cancel-invite-btn" 
          class="px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-200 rounded-lg transition-colors"
        >
          Cancel
        </button>
        <button 
          id="send-invite-btn" 
          class="px-4 py-2 text-sm font-semibold bg-blue-600 text-white hover:bg-blue-700 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          disabled
        >
          Send Invitations
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  .tab-btn {
    padding: 0.75rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: rgb(71 85 105);
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
  }
  .tab-btn:hover {
    color: rgb(30 41 59);
    border-bottom-color: rgb(203 213 225);
  }
  .tab-btn.active {
    color: rgb(37 99 235);
    border-bottom-color: rgb(37 99 235);
  }
  .tab-content {
    display: block;
  }
  .tab-content.hidden {
    display: none;
  }
</style>

<script>
  import { actions } from "astro:actions";
  import { modal } from "@/scripts/NewModal";
  import { MemberRenderer, RequestRenderer, InvitationRenderer } from "./members/renderers";
  import { MemberActions } from "./members/actions";
  import { InviteManager } from "./members/inviteManager";
  import { getTripId, getElement, showElement, hideElement } from "@/utility/tripMembers";
  import type { MembersData } from "@/types/tripMembers";

  // ===== Initialize =====
  const tripId = getTripId();
  let membersData: MembersData | null = null;

  // ===== DOM Elements =====
  const modal_el = getElement<HTMLDivElement>('members-modal')!;
  const inviteModal = getElement<HTMLDivElement>('invite-modal')!;
  const membersLoading = getElement<HTMLDivElement>('members-loading')!;
  const membersTabs = getElement<HTMLDivElement>('members-tabs')!;
  const membersList = getElement<HTMLTableSectionElement>('members-list')!;
  const requestsList = getElement<HTMLDivElement>('requests-list')!;
  const requestsEmpty = getElement<HTMLDivElement>('requests-empty')!;
  const invitationsList = getElement<HTMLDivElement>('invitations-list')!;
  const invitationsEmpty = getElement<HTMLDivElement>('invitations-empty')!;
  const membersSummary = getElement<HTMLParagraphElement>('members-summary')!;
  const availableSpots = getElement<HTMLDivElement>('available-spots')!;
  const inviteBtn = getElement<HTMLButtonElement>('invite-btn')!;
  const membersCount = getElement<HTMLSpanElement>('members-count')!;
  const requestsCount = getElement<HTMLSpanElement>('requests-count')!;
  const invitationsCount = getElement<HTMLSpanElement>('invitations-count')!;
  const requestsTab = getElement<HTMLButtonElement>('requests-tab')!;
  const invitationsTab = getElement<HTMLButtonElement>('invitations-tab')!;

  // Invite modal elements
  const inviteSearch = getElement<HTMLInputElement>('invite-search')!;
  const inviteSuggestions = getElement<HTMLDivElement>('invite-suggestions')!;
  const inviteSearchResults = getElement<HTMLDivElement>('invite-search-results')!;
  const selectedUsersContainer = getElement<HTMLDivElement>('selected-users')!;
  const selectedCountSpan = getElement<HTMLSpanElement>('selected-count')!;
  const sendInviteBtn = getElement<HTMLButtonElement>('send-invite-btn')!;
  const suggestionsLoading = getElement<HTMLDivElement>('suggestions-loading')!;

  // ===== Initialize Managers =====
  const memberActions = new MemberActions(tripId, loadMembersData);

  const memberRenderer = new MemberRenderer(
    membersList,
    (id) => memberActions.removeMember(id),
    (id) => memberActions.approveRequest(id),
    (id) => memberActions.rejectRequest(id)
  );

  const requestRenderer = new RequestRenderer(
    requestsList,
    requestsEmpty,
    (id) => memberActions.approveRequest(id),
    (id) => memberActions.rejectRequest(id)
  );

  const invitationRenderer = new InvitationRenderer(
    invitationsList,
    invitationsEmpty,
    (id) => memberActions.cancelInvitation(id)
  );

  const inviteManager = new InviteManager(
    tripId,
    inviteModal,
    inviteSearch,
    inviteSuggestions,
    inviteSearchResults,
    selectedUsersContainer,
    selectedCountSpan,
    sendInviteBtn,
    suggestionsLoading,
    (selectedUsers, onSuccess) => memberActions.sendInvitations(selectedUsers, onSuccess)
  );

  // ===== Load Members Data =====
  async function loadMembersData(): Promise<void> {
    if (!tripId) {
      console.error('No trip ID found');
      return;
    }

    try {
      showElement(membersLoading);
      hideElement(membersTabs);

      const result = await actions.trip.getTripMembersComplete({ tripId });

      if (result.data?.data) {
        membersData = result.data.data;
        renderAllData();
      } else {
        console.error('Invalid data structure:', result);
        modal.showError('Failed to load members data');
      }
    } catch (error: any) {
      console.error('Failed to load members:', error);
      modal.showError('Failed to load trip members: ' + error.message);
    } finally {
      hideElement(membersLoading);
      showElement(membersTabs);
    }
  }

  // ===== Render All Data =====
  function renderAllData(): void {
    if (!membersData) return;

    const { members, pending_requests, pending_invitations, summary } = membersData;

    // Update summary
    membersSummary.textContent = `${summary.joined_members} of ${summary.max_participants} members â€¢ ${summary.user_role}`;
    availableSpots.textContent = `${summary.available_spots} spots available`;
    membersCount.textContent = `(${members.length})`;

    // Show invite button if permitted
    if (summary.can_invite) {
      showElement(inviteBtn);
    }

    // Render members
    memberRenderer.render(members, summary.user_role);

    // Handle requests tab
    if (pending_requests.length > 0 && (summary.user_role === 'owner' || summary.user_role === 'admin')) {
      showElement(requestsTab);
      requestsCount.textContent = pending_requests.length.toString();
      showElement(requestsCount);
      requestRenderer.render(pending_requests);
    }

    // Handle invitations tab
    if (pending_invitations.length > 0) {
      showElement(invitationsTab);
      invitationsCount.textContent = pending_invitations.length.toString();
      showElement(invitationsCount);
      invitationRenderer.render(pending_invitations);
    }

    // Default to members tab
    switchTab('members');
  }

  // ===== Tab Management =====
  function switchTab(tabName: string): void {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

    const selectedTab = getElement(`tab-${tabName}`);
    selectedTab?.classList.remove('hidden');

    const selectedButton = document.querySelector(`[data-tab="${tabName}"]`);
    selectedButton?.classList.add('active');
  }

  // ===== Modal Controls =====
  function openMembersModal(): void {
    showElement(modal_el);
    modal_el.classList.add('flex');
    loadMembersData();
  }

  function closeMembersModal(): void {
    hideElement(modal_el);
    modal_el.classList.remove('flex');
  }

  // ===== Event Listeners =====
  function setupEventListeners(): void {
    // Open members modal
    getElement('member-btn')?.addEventListener('click', openMembersModal);

    // Close members modal
    getElement('close-modal')?.addEventListener('click', closeMembersModal);
    getElement('close-modal-btn')?.addEventListener('click', closeMembersModal);
    modal_el.addEventListener('click', (e) => {
      if (e.target === modal_el) closeMembersModal();
    });

    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;
        const tabName = target.getAttribute('data-tab');
        if (tabName) switchTab(tabName);
      });
    });

    // Invite modal
    inviteBtn.addEventListener('click', () => inviteManager.open());
    getElement('close-invite-modal')?.addEventListener('click', () => inviteManager.close());
    getElement('cancel-invite-btn')?.addEventListener('click', () => inviteManager.close());
    inviteModal.addEventListener('click', (e) => {
      if (e.target === inviteModal) inviteManager.close();
    });

    // Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (!inviteModal.classList.contains('hidden')) {
          inviteManager.close();
        } else if (!modal_el.classList.contains('hidden')) {
          closeMembersModal();
        }
      }
    });
  }

  setupEventListeners();
</script>