---
import { MapPin, Calendar, Users, UserCheck, HandCoins } from '@lucide/astro';
import DestinationModal from './modal/DestinationModal.astro';
import DatesModal from './modal/DatesModal.astro';
import PreferencesModal from './modal/PreferenceModal.astro';
import BudgetModal from './modal/BudgetModal.astro';
import DescriptionModal from './modal/DescriptionModal.astro';

const {
  destination,
  tripStart,
  tripEnd,
  currentPax,
  maxPax,
  genderPref,
  costSharing,
  description,
  userRole,
  tripId,
  tripStatus,
  joinedBy,
  estimatedBudget,
  tags,
  title
} = Astro.props;

const isOwner = userRole === 'owner';
const isCompleted = tripStatus === 'completed';
const canEdit = isOwner && !isCompleted;
const paxPercentage = Math.min((currentPax / maxPax) * 100, 100);

const fmt = (d: string | null | undefined): string => {
  if (!d) return 'Not set';
  const date = new Date(d);
  if (isNaN(date.getTime())) return 'Invalid date';
  return new Intl.DateTimeFormat('en-US', { year: 'numeric', month: 'short', day: 'numeric' }).format(date);
};
---

<!-- Shared row styles for editable vs static -->
<div class="divide-y divide-gray-100">

  <!-- About this trip -->
  <div
    class={`px-6 py-5 transition-colors ${canEdit ? 'cursor-pointer hover:bg-gray-50 group' : ''}`}
    data-edit="description"
    data-editable={canEdit}
  >
    <div class="flex items-center justify-between mb-2">
      <p class="text-sm font-semibold text-gray-700">About this trip</p>
      {canEdit && (
        <svg class="w-4 h-4 text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
        </svg>
      )}
    </div>
    {description ? (
      <p class="text-sm text-gray-700 leading-relaxed whitespace-pre-line">{description}</p>
    ) : (
      <p class="text-sm text-gray-400 italic">No description yet.</p>
    )}
  </div>

  <!-- Destination -->
  <div
    class={`flex items-center gap-4 px-6 py-4 transition-colors ${canEdit ? 'cursor-pointer hover:bg-gray-50 group' : ''}`}
    data-edit="destination"
    data-editable={canEdit}
  >
    <div class="w-9 h-9 rounded-xl bg-blue-50 flex items-center justify-center shrink-0">
      <MapPin class="w-4 h-4 text-blue-600" />
    </div>
    <div class="flex-1 min-w-0">
      <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-0.5">Destination</p>
      <p class="text-sm font-semibold text-gray-900">{destination}</p>
    </div>
    {canEdit && (
      <svg class="w-4 h-4 text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
      </svg>
    )}
  </div>

  <!-- Trip Dates -->
  <div
    class={`flex items-center gap-4 px-6 py-4 transition-colors ${canEdit ? 'cursor-pointer hover:bg-gray-50 group' : ''}`}
    data-edit="dates"
    data-editable={canEdit}
  >
    <div class="w-9 h-9 rounded-xl bg-blue-50 flex items-center justify-center shrink-0">
      <Calendar class="w-4 h-4 text-blue-600" />
    </div>
    <div class="flex-1 min-w-0">
      <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-0.5">Trip Dates</p>
      {(tripStart || tripEnd) ? (
        <p class="text-sm font-semibold text-gray-900">
          {tripStart ? fmt(tripStart) : '?'} – {tripEnd ? fmt(tripEnd) : '?'}
        </p>
      ) : (
        <p class="text-sm text-gray-400 italic">Not set</p>
      )}
      {joinedBy && (
        <p class="text-xs text-gray-400 mt-0.5">Join by {fmt(joinedBy)}</p>
      )}
    </div>
    {canEdit && (
      <svg class="w-4 h-4 text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
      </svg>
    )}
  </div>

  <!-- Members (opens modal) -->
  <div
    class="flex items-center gap-4 px-6 py-4 cursor-pointer hover:bg-gray-50 transition-colors group"
    id="member-btn"
  >
    <div class="w-9 h-9 rounded-xl bg-blue-50 flex items-center justify-center shrink-0">
      <Users class="w-4 h-4 text-blue-600" />
    </div>
    <div class="flex-1 min-w-0">
      <div class="flex items-center justify-between mb-1.5">
        <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Members</p>
        <span class="text-xs font-semibold text-gray-700">{currentPax} / {maxPax}</span>
      </div>
      <div class="w-full bg-gray-100 rounded-full h-1.5 overflow-hidden">
        <div
          class="h-full bg-blue-500 rounded-full transition-all duration-500"
          style={`width: ${paxPercentage}%`}
        ></div>
      </div>
    </div>
    <svg class="w-4 h-4 text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
    </svg>
  </div>

  <!-- Preferences -->
  <div
    class={`flex items-center gap-4 px-6 py-4 transition-colors ${canEdit ? 'cursor-pointer hover:bg-gray-50 group' : ''}`}
    data-edit="preferences"
    data-editable={canEdit}
  >
    <div class="w-9 h-9 rounded-xl bg-blue-50 flex items-center justify-center shrink-0">
      <UserCheck class="w-4 h-4 text-blue-600" />
    </div>
    <div class="flex-1 min-w-0">
      <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-0.5">Preferences</p>
      <p class="text-sm font-semibold text-gray-900 capitalize">{genderPref || 'Any gender'}</p>
      <p class="text-xs text-gray-500 mt-0.5">Max {maxPax} people</p>
    </div>
    {canEdit && (
      <svg class="w-4 h-4 text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
      </svg>
    )}
  </div>

  <!-- Cost Sharing / Budget -->
  <div
    class={`flex items-center gap-4 px-6 py-4 transition-colors ${canEdit ? 'cursor-pointer hover:bg-gray-50 group' : ''}`}
    data-edit="budget"
    data-editable={canEdit}
  >
    <div class="w-9 h-9 rounded-xl bg-orange-50 flex items-center justify-center shrink-0">
      <HandCoins class="w-4 h-4 text-orange-500" />
    </div>
    <div class="flex-1 min-w-0">
      <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-0.5">Cost Sharing</p>
      <p class="text-sm font-semibold text-gray-900 capitalize">
        {String(costSharing).replace(/_/g, ' ')}
      </p>
      {estimatedBudget && (
        <p class="text-xs text-gray-500 mt-0.5">Est. ₱{estimatedBudget.toLocaleString()}</p>
      )}
    </div>
    {canEdit && (
      <svg class="w-4 h-4 text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
      </svg>
    )}
  </div>


</div>

<!-- Modals (Only render for owners) -->
{canEdit && (
  <>
    <DestinationModal destination={destination} tripId={tripId} />
    <DatesModal tripStart={tripStart} tripEnd={tripEnd} joinedBy={joinedBy} tripId={tripId} />
    <PreferencesModal genderPref={genderPref} maxPax={maxPax} currentPax={currentPax} tripId={tripId} />
    <BudgetModal costSharing={costSharing} estimatedBudget={estimatedBudget} tripId={tripId} />
    <DescriptionModal title={title} description={description} tags={tags} tripId={tripId} />
  </>
)}

<script>
  const editableCards = document.querySelectorAll('[data-editable="true"]');

  editableCards.forEach(card => {
    card.addEventListener('click', () => {
      const editType = card.getAttribute('data-edit');
      const modal = document.getElementById(`edit-${editType}-modal`) as HTMLDialogElement;
      if (modal) {
        modal.showModal();
      }
    });
  });
</script>
