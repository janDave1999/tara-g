---
import { MapPin, Calendar, Users, LucideVenusAndMars, HandCoins } from '@lucide/astro';
import EditableCard from './EditableCard.astro';
import DestinationModal from './modal/DestinationModal.astro';
import DatesModal from './modal/DatesModal.astro';
import PreferencesModal from './modal/PreferenceModal.astro';
import BudgetModal from './modal/BudgetModal.astro';
import DescriptionModal from './modal/DescriptionModal.astro';

const {
  destination,
  tripStart,
  tripEnd,
  currentPax,
  maxPax,
  genderPref,
  costSharing,
  description,
  userRole,
  tripId,
  tripStatus,
  joinedBy,
  estimatedBudget,
  tags,
  title
} = Astro.props;

const isOwner = userRole === 'owner';
const isCompleted = tripStatus === 'completed';
const canEdit = isOwner && !isCompleted;

const paxPercentage = Math.min((currentPax / maxPax) * 100, 100);
---

<div class="p-6 md:p-8">
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    
    <!-- Destination Card -->
    <EditableCard
      editType="destination"
      icon={MapPin}
      label="Destination"
      isEditable={canEdit}
      colorScheme="green"
    >
      <p class="font-semibold text-gray-900 text-lg">{destination}</p>
    </EditableCard>

    <!-- Trip Dates Card -->
    <EditableCard
      editType="dates"
      icon={Calendar}
      label="Trip Dates"
      isEditable={canEdit}
      colorScheme="emerald"
    >
      <div class="flex flex-col gap-0.5">
        <span class="font-medium text-gray-900 text-sm">
          {new Intl.DateTimeFormat('en-US', {year: 'numeric', month: 'short', day: 'numeric'}).format(new Date(tripStart))}
        </span>
        <span class="text-gray-400 text-xs">to</span>
        <span class="font-medium text-gray-900 text-sm">
          {new Intl.DateTimeFormat('en-US', {year: 'numeric', month: 'short', day: 'numeric'}).format(new Date(tripEnd))}
        </span>
      </div>
    </EditableCard>

    <!-- Members Card (Not Editable) -->
    <div class="flex items-start gap-4 p-4 rounded-xl bg-gradient-to-br from-teal-50 to-transparent hover:shadow-md transition-shadow" id="member-btn">
      <div class="flex-shrink-0 p-3 bg-gradient-to-br from-teal-500 to-teal-600 rounded-xl shadow-lg shadow-teal-500/30">
        <Users class="w-5 h-5 text-white" />
      </div>
      <div class="flex-1 w-full">
        <div class="flex justify-between items-center mb-2">
          <p class="text-xs font-bold text-gray-500 uppercase tracking-wider">Members</p>
          <span class="text-sm font-bold text-gray-900">
            {currentPax} <span class="text-gray-400 font-normal">/ {maxPax}</span>
          </span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
          <div 
            class="h-full bg-gradient-to-r from-teal-500 to-teal-600 rounded-full transition-all duration-500" 
            style={`width: ${paxPercentage}%`}
          ></div>
        </div>
      </div>
    </div>

    <!-- Gender & Max Pax Card -->
    <EditableCard
      editType="preferences"
      icon={LucideVenusAndMars}
      label="Preferences"
      isEditable={canEdit}
      colorScheme="lime"
    >
      <p class="font-semibold text-gray-900 capitalize">{genderPref || "Any"}</p>
      <p class="text-xs text-gray-500 mt-1">Max: {maxPax} people</p>
    </EditableCard>

    <!-- Cost Sharing Card -->
    <EditableCard
      editType="budget"
      icon={HandCoins}
      label="Cost Sharing"
      isEditable={canEdit}
      colorScheme="amber"
    >
      <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-amber-100 text-amber-700 mt-1">
        {String(costSharing).toUpperCase().replace(/_/g, ' ')}
      </span>
      {estimatedBudget && (
        <p class="text-xs text-gray-600 mt-2">â‚±{estimatedBudget.toLocaleString()}</p>
      )}
    </EditableCard>
  </div>

  <!-- Description Section -->
  <div 
    class={`mt-8 p-6 rounded-xl bg-gradient-to-br from-green-50 to-white border border-gray-100 transition-all ${canEdit ? 'cursor-pointer hover:shadow-lg hover:border-green-200 group' : ''}`}
    data-edit="description"
    data-editable={canEdit}
  >
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2">
        <span class="w-1 h-5 bg-gradient-to-b from-green-500 to-emerald-500 rounded-full"></span>
        About this trip
      </h3>
      {canEdit && (
        <div class="opacity-0 group-hover:opacity-100 transition-opacity">
          <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
          </svg>
        </div>
      )}
    </div>
    <p class="text-gray-700 leading-relaxed whitespace-pre-line">
      {description}
    </p>
  </div>
</div>

<!-- Modals (Only render for owners) -->
{canEdit && (
  <>
    <DestinationModal destination={destination} tripId={tripId} client:visible />
    <DatesModal tripStart={tripStart} tripEnd={tripEnd} joinedBy={joinedBy} tripId={tripId} client:visible />
    <PreferencesModal genderPref={genderPref} maxPax={maxPax} currentPax={currentPax} tripId={tripId} client:visible />
    <BudgetModal costSharing={costSharing} estimatedBudget={estimatedBudget} tripId={tripId} client:visible />
    <DescriptionModal title={title} description={description} tags={tags} tripId={tripId} client:visible />
  </>
)}

<script>
  const editableCards = document.querySelectorAll('[data-editable="true"]');

  editableCards.forEach(card => {
    card.addEventListener('click', () => {
      const editType = card.getAttribute('data-edit');
      const modal = document.getElementById(`edit-${editType}-modal`) as HTMLDialogElement;
      if (modal) {
        modal.showModal();
      }
    });
  });
</script>