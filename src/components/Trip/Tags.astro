---
const {
  name = "tags",
  label = "Tags",
  helperText = "Select or create custom tags to describe your trip",
  maxTags = 10,
  predefined = [
    "beach", "mountains", "waterfalls", "food", "culture",
    "adventure", "relaxation", "nightlife", "museums",
    "gigs", "festivals", "camping", "hiking", "diving",
    "surfing", "photography", "wildlife", "road-trip"
  ]
} = Astro.props;
---

<div class="tag-component-wrapper">
  <label class="font-medium mb-2 block text-slate-700">
    {label}
    <span class="text-xs text-slate-500 ml-1 font-normal">({maxTags} max)</span>
  </label>

  <!-- Predefined Tags -->
  <div class="mb-3">
    <p class="text-xs text-slate-600 mb-2">Quick select:</p>
    <div class="flex flex-wrap gap-2">
      {predefined.map((tag: string) => (
        <button
          type="button"
          class="predefined-tag px-3 py-1.5 rounded-full border border-slate-300 text-sm hover:bg-slate-50 transition-all duration-200 hover:scale-105"
          data-value={tag}
        >
          {tag}
        </button>
      ))}
    </div>
  </div>

  <!-- Custom Tag Input -->
  <div>
    <p class="text-xs text-slate-600 mb-2">Or create custom:</p>
    <div
      id="input-wrapper"
      class="flex flex-wrap items-center gap-2 w-full border border-gray-300 rounded-lg px-3 py-2 bg-white focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-transparent transition-all cursor-text min-h-[42px]"
    >
      <input
        id="tag-input"
        type="text"
        placeholder="Type and press Enter or Space..."
        class="flex-grow border-0 outline-none bg-transparent text-sm min-w-[180px]"
        autocomplete="off"
      />
    </div>
    <p class="text-xs text-slate-500 mt-1">
      <span id="tag-count">0</span>/{maxTags} tags â€¢ Press Enter or Space to add
    </p>
  </div>

  <!-- Hidden input for form submission -->
  <input type="hidden" name={name} id="tags-hidden" />

  <!-- Max tags warning -->
  <div id="max-tags-warning" class="hidden mt-2 text-sm text-amber-600 flex items-center gap-1">
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
    </svg>
    <span>Maximum {maxTags} tags reached</span>
  </div>
</div>

<style>
  /* Selected tag pills */
  :global(.selected-pill) {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    color: #1e40af;
    border: 1px solid #93c5fd;
    border-radius: 9999px;
    padding: 4px 10px;
    font-size: 0.875rem;
    user-select: none;
    animation: slideIn 0.2s ease-out;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: scale(0.8);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  :global(.selected-pill button) {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 16px;
    height: 16px;
    color: #1e40af;
    cursor: pointer;
    font-weight: bold;
    line-height: 1;
    border-radius: 50%;
    transition: all 0.2s;
    background: transparent;
  }
  
  :global(.selected-pill button:hover) {
    color: #ef4444;
    background: rgba(239, 68, 68, 0.1);
    transform: rotate(90deg);
  }

  /* Active predefined buttons */
  .predefined-tag.active {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    border-color: #3b82f6;
    color: #1e40af;
    font-weight: 500;
    transform: scale(1);
    box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
  }

  .predefined-tag:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Input wrapper states */
  #input-wrapper.has-tags {
    padding-top: 8px;
    padding-bottom: 8px;
  }

  #input-wrapper.error {
    border-color: #ef4444;
  }
</style>

<script is:inline define:vars={{ maxTags }}>
  (function() {
    let tags = new Set();
    
    const wrapper = document.getElementById("input-wrapper");
    const input = document.getElementById("tag-input");
    const hiddenInput = document.getElementById("tags-hidden");
    const tagCount = document.getElementById("tag-count");
    const maxWarning = document.getElementById("max-tags-warning");
    const suggestionButtons = document.querySelectorAll(".predefined-tag");

    // Validation
    function validateTag(tag) {
      const cleaned = tag.trim().toLowerCase();
      
      if (!cleaned) return { valid: false, message: "" };
      if (cleaned.length < 2) return { valid: false, message: "Tag too short (min 2 characters)" };
      if (cleaned.length > 20) return { valid: false, message: "Tag too long (max 20 characters)" };
      if (!/^[a-z0-9-]+$/.test(cleaned)) return { valid: false, message: "Only letters, numbers, and hyphens allowed" };
      if (tags.has(cleaned)) return { valid: false, message: "Tag already added" };
      if (tags.size >= maxTags) return { valid: false, message: `Maximum ${maxTags} tags allowed` };
      
      return { valid: true, cleaned };
    }

    function showInputError(message) {
      wrapper.classList.add("error");
      input.placeholder = message;
      setTimeout(() => {
        wrapper.classList.remove("error");
        input.placeholder = "Type and press Enter or Space...";
      }, 2000);
    }

    function addTag(tag) {
      const validation = validateTag(tag);
      
      if (!validation.valid) {
        if (validation.message) showInputError(validation.message);
        return false;
      }
      
      tags.add(validation.cleaned);
      renderTags();
      input.value = "";
      syncHidden();
      updateUI();
      return true;
    }

    function removeTag(tag) {
      tags.delete(tag);
      renderTags();
      syncHidden();
      updateUI();
    }

    function renderTags() {
      const existingPills = wrapper.querySelectorAll('.selected-pill');
      existingPills.forEach(el => el.remove());

      const tagsArray = Array.from(tags);
      
      tagsArray.forEach(tag => {
        const pill = document.createElement("span");
        pill.className = "selected-pill";
        pill.innerHTML = `
          <span>${tag}</span>
          <button type="button" data-remove="${tag}" aria-label="Remove ${tag}">&times;</button>
        `;
        wrapper.insertBefore(pill, input);
      });

      // Update predefined button states
      suggestionButtons.forEach(btn => {
        const isActive = tags.has(btn.dataset.value);
        const isDisabled = tags.size >= maxTags && !isActive;
        
        btn.classList.toggle("active", isActive);
        btn.disabled = isDisabled;
      });

      // Update wrapper class
      wrapper.classList.toggle("has-tags", tags.size > 0);
    }

    function syncHidden() {
      hiddenInput.value = Array.from(tags).join(",");
    }

    function updateUI() {
      tagCount.textContent = tags.size;
      
      // Show/hide max warning
      if (tags.size >= maxTags) {
        maxWarning.classList.remove("hidden");
        input.disabled = true;
        input.placeholder = `Maximum ${maxTags} tags reached`;
      } else {
        maxWarning.classList.add("hidden");
        input.disabled = false;
        input.placeholder = "Type and press Enter or Space...";
      }
    }

    // Event Listeners
    wrapper.addEventListener("click", (e) => {
      if (e.target === wrapper && !input.disabled) {
        input.focus();
      }
      
      if (e.target.tagName === "BUTTON" && e.target.dataset.remove) {
        removeTag(e.target.dataset.remove);
        input.focus();
      }
    });

    input.addEventListener("keydown", (e) => {
      const value = input.value.trim();

      if (e.key === " " || e.key === "Enter") {
        e.preventDefault();
        if (value) addTag(value);
      }

      if (e.key === "Backspace" && value === "" && tags.size > 0) {
        const tagsArray = Array.from(tags);
        removeTag(tagsArray[tagsArray.length - 1]);
      }

      // Prevent typing if max reached
      if (tags.size >= maxTags && e.key !== "Backspace" && e.key !== "Delete") {
        e.preventDefault();
      }
    });

    // Paste support
    input.addEventListener("paste", (e) => {
      e.preventDefault();
      const pastedText = (e.clipboardData || window.clipboardData).getData('text');
      const pastedTags = pastedText.split(/[,\s]+/).filter(t => t.trim());
      
      let addedCount = 0;
      pastedTags.forEach(tag => {
        if (addTag(tag)) addedCount++;
      });
      
      if (addedCount > 0) {
        input.value = "";
      }
    });

    suggestionButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const val = btn.dataset.value;
        if (tags.has(val)) {
          removeTag(val);
        } else {
          addTag(val);
        }
        input.focus();
      });
    });

    // Initialize
    updateUI();

    // Load from hidden input if pre-populated
    if (hiddenInput.value) {
      const initialTags = hiddenInput.value.split(",").filter(t => t.trim());
      initialTags.forEach(tag => addTag(tag));
    }
  })();
</script>