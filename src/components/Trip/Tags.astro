---
const {
  name = "tags",
  label = "Tags",
  predefined = [
    "beach", "mountains", "waterfalls", "food", "culture",
    "adventure", "relaxation", "nightlife", "museums",
    "gigs", "festivals", "camping"
  ]
} = Astro.props;
---

<div class="tag-component-wrapper">
  <label class="font-medium mt-4 mb-2 block">{label}</label>

  <div class="flex flex-wrap gap-2 mb-3">
    {predefined.map((tag: string) => (
      <button
        type="button"
        class="predefined-tag px-3 py-1 rounded-full border text-sm hover:bg-gray-50 transition-colors"
        data-value={tag}
      >
        + {tag}
      </button>
    ))}
  </div>

  <div
    id="input-wrapper"
    class="flex flex-wrap items-center gap-2 w-full border rounded px-3 py-2 bg-white focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-blue-500 transition-all cursor-text"
  >
    <input
      id="tag-input"
      type="text"
      placeholder="Type and press Space..."
      class="flex-grow border-0 border:focus-none outline-none bg-transparent text-sm min-w-[120px]"
      autocomplete="off"
    />
  </div>

  <input type="hidden" name={name} id="tags-hidden" />
</div>

<style>
  /* Styles for the dynamic tags inside the input */
  :global(.selected-pill) {
    display: inline-flex;
    align-items: center;
    background-color: #eff6ff; /* blue-50 */
    color: #1d4ed8; /* blue-700 */
    border: 1px solid #bfdbfe; /* blue-200 */
    border-radius: 9999px;
    padding: 2px 10px;
    font-size: 0.875rem;
    user-select: none;
  }

  :global(.selected-pill button) {
    margin-left: 6px;
    color: #1e40af;
    cursor: pointer;
    font-weight: bold;
    line-height: 1;
  }
  
  :global(.selected-pill button:hover) {
    color: #ef4444; /* red-500 */
  }

  /* Style for active predefined buttons */
  .predefined-tag.active {
    background-color: #dbeafe; /* blue-100 */
    border-color: #2563eb;
    color: #1e40af;
  }
</style>

<script is:inline>
  // using IIFE to avoid global namespace pollution
  (function() {
    let tags = new Set(); // Stores unique tags
    
    const wrapper = document.getElementById("input-wrapper");
    const input = document.getElementById("tag-input");
    const hiddenInput = document.getElementById("tags-hidden");
    const suggestionButtons = document.querySelectorAll(".predefined-tag");

    // 1. Core Logic: Add a tag
    function addTag(tag) {
      const cleanedTag = tag.trim().toLowerCase();
      if (!cleanedTag) return;
      
      tags.add(cleanedTag);
      renderTags();
      input.value = "";
      syncHidden();
    }

    // 2. Core Logic: Remove a tag
    function removeTag(tag) {
      tags.delete(tag);
      renderTags();
      syncHidden();
    }

    // 3. Render the pills inside the input wrapper
    function renderTags() {
      // Clear current pills (keep the input at the end)
      const existingPills = wrapper.querySelectorAll('.selected-pill');
      existingPills.forEach(el => el.remove());

      // Create new pills
      const reversedTags = Array.from(tags); // Maintain order logic if needed
      
      reversedTags.forEach(tag => {
        const pill = document.createElement("span");
        pill.className = "selected-pill";
        pill.innerHTML = `
          ${tag}
          <button type="button" data-remove="${tag}">&times;</button>
        `;
        // Insert before the input box
        wrapper.insertBefore(pill, input);
      });

      // Update styling of predefined buttons
      suggestionButtons.forEach(btn => {
        if (tags.has(btn.dataset.value)) {
          btn.classList.add("active");
        } else {
          btn.classList.remove("active");
        }
      });
    }

    // 4. Sync to hidden input for form submission
    function syncHidden() {
      hiddenInput.value = Array.from(tags).join(",");
    }

    // --- EVENT LISTENERS ---

    // Focus input when clicking anywhere in the gray wrapper
    wrapper.addEventListener("click", (e) => {
      if (e.target === wrapper) input.focus();
      
      // Handle 'x' button clicks on pills
      if (e.target.tagName === "BUTTON" && e.target.dataset.remove) {
        removeTag(e.target.dataset.remove);
      }
    });

    // Handle typing (Space, Enter, Backspace)
    input.addEventListener("keydown", (e) => {
      const value = input.value;

      // Case: Space or Enter -> Create Tag
      if (e.key === " " || e.key === "Enter") {
        e.preventDefault(); // Stop space/enter from being added to text
        addTag(value);
      }

      // Case: Backspace -> Delete last tag if input is empty
      if (e.key === "Backspace" && value === "") {
        const tagsArray = Array.from(tags);
        if (tagsArray.length > 0) {
          const lastTag = tagsArray[tagsArray.length - 1];
          removeTag(lastTag);
        }
      }
    });

    // Handle predefined suggestion clicks
    suggestionButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const val = btn.dataset.value;
        if (tags.has(val)) {
          removeTag(val);
        } else {
          addTag(val);
        }
        input.focus(); // Keep focus for smooth flow
      });
    });

  })();
</script>