---
import { Share2Icon, MapPin } from '@lucide/astro';
import TripStatusBadge from './TripStatusBadge.astro';
import VisibilityModal from './modal/VisibilityModal.astro';
import StatusModal from './modal/StatusModal.astro';

const {
  title,
  visibility,
  tags,
  userRole,
  tripId,
  tripStatus,
  destination,
  currentPax,
  maxPax,
  isInvited = false,
} = Astro.props;

let tagsArray: string[] = [];
if (Array.isArray(tags)) {
  tagsArray = tags;
} else if (typeof tags === 'string') {
  const cleaned = tags.trim();
  if (cleaned.startsWith('[') && cleaned.endsWith(']')) {
    try {
      tagsArray = JSON.parse(cleaned);
    } catch {
      tagsArray = cleaned.split(',').map((t) => t.trim()).filter(Boolean);
    }
  }
}

const isOwner = userRole === 'owner';
const isFull = (currentPax ?? 0) >= (maxPax ?? 1);

const visibilityIcon: Record<string, string> = {
  private: 'üîí',
  public: 'üåê',
  friends: 'üë•',
};

const statusBadgeClass: Record<string, string> = {
  active:    'bg-emerald-50 text-emerald-700 ring-emerald-600/20',
  draft:     'bg-amber-50   text-amber-700   ring-amber-600/20',
  completed: 'bg-blue-50    text-blue-700    ring-blue-600/20',
  cancelled: 'bg-red-50     text-red-600     ring-red-500/20',
  archived:  'bg-gray-100   text-gray-600    ring-gray-400/20',
};
---

<div class="px-6 md:px-8 py-6 md:py-7">
  <div class="flex items-start justify-between gap-4">

    <!-- Left: Trip info -->
    <div class="flex-1 min-w-0 space-y-2.5">

      <!-- Title -->
      <h1 class="text-2xl md:text-3xl font-bold text-gray-900 tracking-tight leading-snug">
        {title}
      </h1>

      <!-- Meta row -->
      <div class="flex flex-wrap items-center gap-2">
        {destination && (
          <span class="flex items-center gap-1.5 text-sm text-gray-500">
            <MapPin class="w-3.5 h-3.5 text-gray-400 shrink-0" />
            {destination}
          </span>
        )}

        <!-- Status: owner gets clickable TripStatusBadge, non-owner gets static chip -->
        {isOwner && tripStatus ? (
          <TripStatusBadge status={tripStatus} tripId={tripId} />
        ) : tripStatus && (
          <span class={`inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-semibold ring-1 ring-inset ${statusBadgeClass[tripStatus] ?? statusBadgeClass.draft}`}>
            {tripStatus.charAt(0).toUpperCase() + tripStatus.slice(1)}
          </span>
        )}

        <!-- Visibility: owner gets clickable, non-owner gets static -->
        {visibility && (isOwner ? (
          <button
            id="open-visibility-modal"
            type="button"
            class="inline-flex items-center gap-1 rounded-full px-2.5 py-0.5 text-xs font-medium bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors cursor-pointer"
            title="Click to change visibility"
          >
            {visibilityIcon[visibility]} {visibility.charAt(0).toUpperCase() + visibility.slice(1)}
          </button>
        ) : (
          <span class="inline-flex items-center gap-1 rounded-full px-2.5 py-0.5 text-xs font-medium bg-gray-100 text-gray-600">
            {visibilityIcon[visibility]} {visibility.charAt(0).toUpperCase() + visibility.slice(1)}
          </span>
        ))}

        {!isOwner && userRole === 'member' && (
          <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-semibold bg-blue-50 text-blue-700 ring-1 ring-inset ring-blue-600/20">
            ‚úì Member
          </span>
        )}
        {!isOwner && userRole === 'pending' && (
          <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-semibold bg-amber-50 text-amber-700 ring-1 ring-inset ring-amber-600/20">
            ‚è≥ Pending
          </span>
        )}
      </div>

      <!-- Tags -->
      {tagsArray.length > 0 && (
        <div class="flex flex-wrap gap-1.5">
          {tagsArray.map((tag: string) => (
            <span class="px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors">
              {tag}
            </span>
          ))}
        </div>
      )}
    </div>

    <!-- Right: Action buttons -->
    <div class="flex items-center gap-2 shrink-0 pt-0.5">
      <button
        id="share-trip-btn"
        class="p-2 rounded-lg text-gray-400 hover:text-gray-700 hover:bg-gray-100 transition-all focus:ring-2 focus:ring-gray-300 focus:outline-none"
        aria-label="Share trip"
      >
        <Share2Icon class="w-5 h-5" />
      </button>

      {userRole === 'visitor' && !isInvited && !isFull && tripStatus === 'active' && (
        <button
          id="join-btn"
          class="px-5 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold shadow-sm shadow-blue-500/20 transition-colors focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 focus:outline-none"
        >
          Request to Join
        </button>
      )}

      {userRole === 'visitor' && !isInvited && isFull && (
        <span class="px-5 py-2 rounded-xl bg-gray-100 text-gray-400 text-sm font-medium cursor-not-allowed select-none">
          Trip Full
        </span>
      )}

      {userRole === 'pending' && (
        <button
          id="cancel-req-btn"
          class="px-4 py-2 rounded-xl border border-gray-200 text-gray-600 text-sm font-medium hover:bg-gray-50 transition-colors focus:ring-2 focus:ring-gray-300 focus:outline-none"
        >
          Cancel Request
        </button>
      )}

      {userRole === 'member' && (
        <button
          id="leave-trip-btn"
          class="px-4 py-2 rounded-xl border border-gray-200 text-red-500 text-sm font-medium hover:bg-red-50 hover:border-red-200 transition-colors focus:ring-2 focus:ring-red-300 focus:outline-none"
        >
          Leave Trip
        </button>
      )}
    </div>
  </div>
</div>

{isOwner && <VisibilityModal tripId={tripId} currentVisibility={visibility ?? 'private'} />}
{isOwner && tripStatus && <StatusModal tripId={tripId} currentStatus={tripStatus} />}

<script>
  document.getElementById('open-visibility-modal')?.addEventListener('click', () => {
    (document.getElementById('edit-visibility-modal') as HTMLDialogElement)?.showModal();
  });

  const shareBtn = document.getElementById('share-trip-btn');
  shareBtn?.addEventListener('click', async () => {
    const url = window.location.href;
    if (navigator.share) {
      try { await navigator.share({ title: document.title, url }); } catch {}
    } else {
      try { await navigator.clipboard.writeText(url); } catch {}
    }
  });
</script>
