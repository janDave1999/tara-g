---
import { Share2Icon, MapPin } from '@lucide/astro';
import TripStatusBadge from './TripStatusBadge.astro';
import VisibilityModal from './modal/VisibilityModal.astro';
import StatusModal from './modal/StatusModal.astro';
import { PUBLIC_R2_URL } from 'astro:env/client';

const {
  title,
  visibility,
  tags,
  userRole,
  tripId,
  tripStatus,
  destination,
  currentPax,
  maxPax,
  isInvited = false,
  pendingRequests = [],
  pendingInvitations = [],
} = Astro.props;

let tagsArray: string[] = [];
if (Array.isArray(tags)) {
  tagsArray = tags;
} else if (typeof tags === 'string') {
  const cleaned = tags.trim();
  if (cleaned.startsWith('[') && cleaned.endsWith(']')) {
    try {
      tagsArray = JSON.parse(cleaned);
    } catch {
      tagsArray = cleaned.split(',').map((t: string) => t.trim()).filter(Boolean);
    }
  }
}

const isOwner = userRole === 'owner';
const isFull = (currentPax ?? 0) >= (maxPax ?? 1);

const pendingRequestsCount = Array.isArray(pendingRequests) ? pendingRequests.length : 0;
const pendingInvitationsCount = Array.isArray(pendingInvitations) ? pendingInvitations.length : 0;

function getAvatarUrl(url: string | null | undefined): string {
  if (!url) return '';
  return url.startsWith('http') ? url : `${PUBLIC_R2_URL}${url}`;
}

const visibilityIcon: Record<string, string> = {
  private: 'üîí',
  public: 'üåê',
  friends: 'üë•',
};

const statusBadgeClass: Record<string, string> = {
  active:    'bg-emerald-50 text-emerald-700 ring-emerald-600/20',
  draft:     'bg-amber-50   text-amber-700   ring-amber-600/20',
  completed: 'bg-blue-50    text-blue-700    ring-blue-600/20',
  cancelled: 'bg-red-50     text-red-600     ring-red-500/20',
  archived:  'bg-gray-100   text-gray-600    ring-gray-400/20',
};
---

<div class="px-6 md:px-8 py-6 md:py-7">
  <div class="flex items-start justify-between gap-4">

    <!-- Left: Trip info -->
    <div class="flex-1 min-w-0 space-y-2.5">

      <!-- Title -->
      <h1 class="text-2xl md:text-3xl font-bold text-gray-900 tracking-tight leading-snug">
        {title}
      </h1>

      <!-- Meta row -->
      <div class="flex flex-wrap items-center gap-2">
        {destination && (
          <span class="flex items-center gap-1.5 text-sm text-gray-500">
            <MapPin class="w-3.5 h-3.5 text-gray-400 shrink-0" />
            {destination}
          </span>
        )}

        <!-- Status: owner gets clickable TripStatusBadge, non-owner gets static chip -->
        {isOwner && tripStatus ? (
          <TripStatusBadge status={tripStatus} tripId={tripId} />
        ) : tripStatus && (
          <span class={`inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-semibold ring-1 ring-inset ${statusBadgeClass[tripStatus] ?? statusBadgeClass.draft}`}>
            {tripStatus.charAt(0).toUpperCase() + tripStatus.slice(1)}
          </span>
        )}

        <!-- Visibility: owner gets clickable, non-owner gets static -->
        {visibility && (isOwner ? (
          <button
            id="open-visibility-modal"
            type="button"
            class="inline-flex items-center gap-1 rounded-full px-2.5 py-0.5 text-xs font-medium bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors cursor-pointer"
            title="Click to change visibility"
          >
            {visibilityIcon[visibility]} {visibility.charAt(0).toUpperCase() + visibility.slice(1)}
          </button>
        ) : (
          <span class="inline-flex items-center gap-1 rounded-full px-2.5 py-0.5 text-xs font-medium bg-gray-100 text-gray-600">
            {visibilityIcon[visibility]} {visibility.charAt(0).toUpperCase() + visibility.slice(1)}
          </span>
        ))}

        {!isOwner && userRole === 'member' && (
          <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-semibold bg-blue-50 text-blue-700 ring-1 ring-inset ring-blue-600/20">
            ‚úì Member
          </span>
        )}
        {!isOwner && userRole === 'pending' && (
          <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-semibold bg-amber-50 text-amber-700 ring-1 ring-inset ring-amber-600/20">
            ‚è≥ Pending
          </span>
        )}
      </div>

      <!-- Tags -->
      {tagsArray.length > 0 && (
        <div class="flex flex-wrap gap-1.5">
          {tagsArray.map((tag: string) => (
            <span class="px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors">
              {tag}
            </span>
          ))}
        </div>
      )}
    </div>

    <!-- Right: Share button (mobile) + Action buttons (desktop) -->
    <div class="flex items-center gap-2 shrink-0 pt-0.5">
      <!-- Desktop: Action buttons next to share -->
      {userRole === 'visitor' && !isInvited && !isFull && tripStatus === 'active' && (
        <button
          id="join-btn"
          class="hidden md:block px-5 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold shadow-sm shadow-blue-500/20 transition-colors focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 focus:outline-none"
        >
          Request to Join
        </button>
      )}

      {userRole === 'visitor' && !isInvited && isFull && (
        <span class="hidden md:block px-5 py-2 rounded-xl bg-gray-100 text-gray-400 text-sm font-medium cursor-not-allowed select-none">
          Trip Full
        </span>
      )}

      {userRole === 'pending' && (
        <button
          id="cancel-req-btn"
          class="hidden md:block px-4 py-2 rounded-xl border border-gray-200 text-gray-600 text-sm font-medium hover:bg-gray-50 transition-colors focus:ring-2 focus:ring-gray-300 focus:outline-none"
        >
          Cancel Request
        </button>
      )}

      {userRole === 'member' && (
        <button
          id="leave-trip-btn"
          class="hidden md:block px-4 py-2 rounded-xl border border-gray-200 text-red-500 text-sm font-medium hover:bg-red-50 hover:border-red-200 transition-colors focus:ring-2 focus:ring-red-300 focus:outline-none"
        >
          Leave Trip
        </button>
      )}

      {userRole === 'owner' && (
        <button
          id="delete-trip-btn"
          class="hidden md:block px-4 py-2 rounded-xl border border-gray-200 text-red-600 text-sm font-medium hover:bg-red-50 hover:border-red-300 transition-colors focus:ring-2 focus:ring-red-300 focus:outline-none"
        >
          Delete Trip
        </button>
      )}

      <!-- Share button (visible on all sizes) -->
      <button
        id="share-trip-btn"
        class="p-2 rounded-lg text-gray-400 hover:text-gray-700 hover:bg-gray-100 transition-all focus:ring-2 focus:ring-gray-300 focus:outline-none"
        aria-label="Share trip"
      >
        <Share2Icon class="w-5 h-5" />
      </button>
    </div>
  </div>
</div>

<!-- Sticky Action Footer (Mobile) -->
<div class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-4 py-3 z-40 shadow-lg">
  <!-- Pending Requests/Invitations Banner (for owner) -->
  {isOwner && (pendingRequestsCount > 0 || pendingInvitationsCount > 0) && (
    <div class="flex items-center justify-center gap-3 mb-3 pb-3 border-b border-gray-100">
      <!-- Request avatars -->
      {pendingRequestsCount > 0 && (
        <div class="flex items-center gap-2">
          <div class="flex -space-x-2">
            {pendingRequests.slice(0, 3).map((request: any) => (
              request.avatar_url ? (
                <img 
                  src={getAvatarUrl(request.avatar_url)} 
                  alt={request.username || ''}
                  title={request.full_name || request.username}
                  class="w-8 h-8 rounded-full border-2 border-white object-cover"
                />
              ) : (
                <div class="w-8 h-8 rounded-full border-2 border-white bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white text-xs font-bold">
                  {(request.username || request.full_name || '?').charAt(0).toUpperCase()}
                </div>
              )
            ))}
            {pendingRequestsCount > 3 && (
              <div class="w-8 h-8 rounded-full border-2 border-white bg-gray-100 flex items-center justify-center text-xs font-medium text-gray-600">
                +{pendingRequestsCount - 3}
              </div>
            )}
          </div>
          <span class="text-sm font-medium text-gray-700">
            {pendingRequestsCount} request{pendingRequestsCount !== 1 ? 's' : ''}
          </span>
        </div>
      )}
      
      <!-- Invitation avatars -->
      {pendingInvitationsCount > 0 && (
        <div class="flex items-center gap-2">
          {pendingRequestsCount > 0 && <span class="text-gray-300">‚Ä¢</span>}
          <div class="flex -space-x-2">
            {pendingInvitations.slice(0, 3).map((inv: any) => (
              inv.invitee_avatar ? (
                <img 
                  src={getAvatarUrl(inv.invitee_avatar)} 
                  alt={inv.invitee_username || ''}
                  title={inv.invitee_name || inv.invitee_username}
                  class="w-8 h-8 rounded-full border-2 border-white object-cover"
                />
              ) : (
                <div class="w-8 h-8 rounded-full border-2 border-white bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center text-white text-xs font-bold">
                  {(inv.invitee_name || inv.invitee_username || '?').charAt(0).toUpperCase()}
                </div>
              )
            ))}
            {pendingInvitationsCount > 3 && (
              <div class="w-8 h-8 rounded-full border-2 border-white bg-blue-100 flex items-center justify-center text-xs font-medium text-blue-600">
                +{pendingInvitationsCount - 3}
              </div>
            )}
          </div>
          <span class="text-sm font-medium text-blue-600 ml-1">
            {pendingInvitationsCount} invite{pendingInvitationsCount !== 1 ? 's' : ''}
          </span>
        </div>
      )}
    </div>
  )}
  
  <div class="flex items-center gap-2 justify-center">
    {userRole === 'visitor' && !isInvited && !isFull && tripStatus === 'active' && (
      <button
        id="join-btn"
        class="flex-1 px-5 py-3 rounded-xl bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold shadow-sm shadow-blue-500/20 transition-colors focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 focus:outline-none"
      >
        Request to Join
      </button>
    )}

    {userRole === 'visitor' && !isInvited && isFull && (
      <span class="flex-1 px-5 py-3 rounded-xl bg-gray-100 text-gray-400 text-sm font-medium text-center cursor-not-allowed select-none">
        Trip Full
      </span>
    )}

    {userRole === 'pending' && (
      <button
        id="cancel-req-btn"
        class="flex-1 px-4 py-3 rounded-xl border border-gray-200 text-gray-600 text-sm font-medium hover:bg-gray-50 transition-colors focus:ring-2 focus:ring-gray-300 focus:outline-none"
      >
        Cancel Request
      </button>
    )}

    {userRole === 'member' && (
      <button
        id="leave-trip-btn"
        class="flex-1 px-4 py-3 rounded-xl border border-gray-200 text-red-500 text-sm font-medium hover:bg-red-50 hover:border-red-200 transition-colors focus:ring-2 focus:ring-red-300 focus:outline-none"
      >
        Leave Trip
      </button>
    )}

    {userRole === 'owner' && (
      <>
        <button
          id="delete-trip-btn"
          class="flex-1 px-4 py-3 rounded-xl border border-red-200 text-red-600 text-sm font-medium hover:bg-red-50 hover:border-red-300 transition-colors focus:ring-2 focus:ring-red-300 focus:outline-none"
        >
          Delete Trip
        </button>
      </>
    )}
  </div>
</div>

<!-- Desktop: Owner sees request/invitation count -->
{isOwner && (pendingRequestsCount > 0 || pendingInvitationsCount > 0) && (
  <div class="hidden md:flex items-center justify-center gap-4 mt-3 pt-3 border-t border-gray-100">
    {pendingRequestsCount > 0 && (
      <div class="flex items-center gap-2">
        <div class="flex -space-x-2">
          {pendingRequests.slice(0, 3).map((request: any) => (
            request.avatar_url ? (
              <img 
                src={getAvatarUrl(request.avatar_url)} 
                alt={request.username || ''}
                title={request.full_name || request.username}
                class="w-7 h-7 rounded-full border-2 border-white object-cover"
              />
            ) : (
              <div class="w-7 h-7 rounded-full border-2 border-white bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white text-xs font-bold">
                {(request.username || request.full_name || '?').charAt(0).toUpperCase()}
              </div>
            )
          ))}
          {pendingRequestsCount > 3 && (
            <div class="w-7 h-7 rounded-full border-2 border-white bg-gray-100 flex items-center justify-center text-xs font-medium text-gray-600">
              +{pendingRequestsCount - 3}
            </div>
          )}
        </div>
        <span class="text-sm font-medium text-gray-700">
          {pendingRequestsCount} pending request{pendingRequestsCount !== 1 ? 's' : ''}
        </span>
      </div>
    )}
    
    {pendingInvitationsCount > 0 && (
      <div class="flex items-center gap-2">
        {pendingRequestsCount > 0 && <span class="text-gray-300">‚Ä¢</span>}
        <div class="flex -space-x-2">
          {pendingInvitations.slice(0, 3).map((inv: any) => (
            inv.invitee_avatar ? (
              <img 
                src={getAvatarUrl(inv.invitee_avatar)} 
                alt={inv.invitee_username || ''}
                title={inv.invitee_name || inv.invitee_username}
                class="w-7 h-7 rounded-full border-2 border-white object-cover"
              />
            ) : (
              <div class="w-7 h-7 rounded-full border-2 border-white bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center text-white text-xs font-bold">
                {(inv.invitee_name || inv.invitee_username || '?').charAt(0).toUpperCase()}
              </div>
            )
          ))}
          {pendingInvitationsCount > 3 && (
            <div class="w-7 h-7 rounded-full border-2 border-white bg-blue-100 flex items-center justify-center text-xs font-medium text-blue-600">
              +{pendingInvitationsCount - 3}
            </div>
          )}
        </div>
        <span class="text-sm font-medium text-blue-600">
          {pendingInvitationsCount} pending invite{pendingInvitationsCount !== 1 ? 's' : ''}
        </span>
      </div>
    )}
    
    <!-- View Requests Button -->
    <button
      id="view-requests-btn"
      class="ml-2 px-3 py-1.5 text-xs font-medium text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors"
    >
      View All
    </button>
  </div>
)}

{isOwner && <VisibilityModal tripId={tripId} currentVisibility={visibility ?? 'private'} />}
{isOwner && tripStatus && <StatusModal tripId={tripId} currentStatus={tripStatus} />}

<script>
  document.getElementById('open-visibility-modal')?.addEventListener('click', () => {
    (document.getElementById('edit-visibility-modal') as HTMLDialogElement)?.showModal();
  });

  const shareBtn = document.getElementById('share-trip-btn');
  shareBtn?.addEventListener('click', async () => {
    const url = window.location.href;
    if (navigator.share) {
      try { await navigator.share({ title: document.title, url }); } catch {}
    } else {
      try { await navigator.clipboard.writeText(url); } catch {}
    }
  });

  // View All requests button - triggers member modal
  document.getElementById('view-requests-btn')?.addEventListener('click', () => {
    const memberBtn = document.getElementById('member-btn') as HTMLButtonElement | null;
    memberBtn?.click();
  });
</script>
