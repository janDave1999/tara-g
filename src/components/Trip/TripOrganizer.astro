---
import { MapPin, Globe } from '@lucide/astro';
import { PUBLIC_R2_URL } from 'astro:env/client';

interface Props {
  owner: {
    user_id: string;
    username: string;
    full_name: string;
    avatar_url: string | null;
  };
  info?: {
    location_country?: string | null;
    location_city?: string | null;
  } | null;
  prefs?: {
    travel_style?: string[] | null;
    languages_spoken?: string[] | null;
  } | null;
  stats?: {
    total: number;
    completed: number;
  };
}

const { owner, info, prefs, stats } = Astro.props;

const avatarUrl = owner.avatar_url
  ? (owner.avatar_url.startsWith('http') ? owner.avatar_url : `${PUBLIC_R2_URL}${owner.avatar_url}`)
  : null;

const location = [info?.location_city, info?.location_country].filter(Boolean).join(', ');
const languages = (prefs?.languages_spoken ?? []).filter(Boolean);
const travelStyle = (prefs?.travel_style ?? []).filter(Boolean);
const showStats = stats && stats.total > 0;

const formatLabel = (s: string) =>
  s.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
---

<div class="rounded-2xl overflow-hidden border border-gray-100 shadow-sm bg-white">

  <!-- Header -->
  <div class="px-6 py-5 border-b border-gray-100">
    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Organizer</p>
  </div>

  <!-- Organizer identity row -->
  <div class="flex items-center gap-4 px-6 py-5">
    <!-- Avatar -->
    <a href={`/profile/${owner.username}`} class="shrink-0">
      {avatarUrl ? (
        <img
          src={avatarUrl}
          alt={owner.full_name}
          class="w-14 h-14 rounded-full object-cover border border-gray-200"
          loading="lazy"
        />
      ) : (
        <div class="w-14 h-14 rounded-full bg-blue-50 border border-gray-200 flex items-center justify-center">
          <span class="text-xl font-bold text-blue-400">
            {(owner.full_name || owner.username || '?')[0].toUpperCase()}
          </span>
        </div>
      )}
    </a>

    <!-- Name + username + stats -->
    <div class="flex-1 min-w-0">
      <a
        href={`/profile/${owner.username}`}
        class="text-base font-semibold text-gray-900 hover:text-blue-600 transition-colors truncate block"
      >
        {owner.full_name || owner.username}
      </a>
      <p class="text-sm text-gray-500 truncate">@{owner.username}</p>
      {showStats && (
        <div class="flex items-center gap-3 mt-1.5">
          <span class="text-xs text-gray-500">
            <span class="font-semibold text-gray-800">{stats!.total}</span> trip{stats!.total !== 1 ? 's' : ''} created
          </span>
          {stats!.completed > 0 && (
            <>
              <span class="text-gray-300">Â·</span>
              <span class="text-xs text-gray-500">
                <span class="font-semibold text-green-700">{stats!.completed}</span> completed
              </span>
            </>
          )}
        </div>
      )}
    </div>

    <!-- Profile link arrow -->
    <a
      href={`/profile/${owner.username}`}
      class="shrink-0 w-9 h-9 rounded-xl bg-gray-50 border border-gray-200 flex items-center justify-center hover:bg-blue-50 hover:border-blue-200 transition-colors"
      aria-label="View profile"
    >
      <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
      </svg>
    </a>
  </div>

  <!-- Location (if set) -->
  {location && (
    <div class="flex items-center gap-4 px-6 py-3 border-t border-gray-100">
      <div class="w-9 h-9 rounded-xl bg-blue-50 flex items-center justify-center shrink-0">
        <MapPin class="w-4 h-4 text-blue-600" />
      </div>
      <div class="flex-1 min-w-0">
        <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-0.5">Based in</p>
        <p class="text-sm font-semibold text-gray-900">{location}</p>
      </div>
    </div>
  )}

  <!-- Languages (if set) -->
  {languages.length > 0 && (
    <div class="flex items-start gap-4 px-6 py-4 border-t border-gray-100">
      <div class="w-9 h-9 rounded-xl bg-blue-50 flex items-center justify-center shrink-0 mt-0.5">
        <Globe class="w-4 h-4 text-blue-600" />
      </div>
      <div class="flex-1 min-w-0">
        <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Languages</p>
        <div class="flex flex-wrap gap-1.5">
          {languages.map(lang => (
            <span class="text-xs px-2.5 py-1 rounded-full bg-gray-100 text-gray-700 font-medium">
              {formatLabel(lang)}
            </span>
          ))}
        </div>
      </div>
    </div>
  )}

  <!-- Travel style (if set) -->
  {travelStyle.length > 0 && (
    <div class="px-6 py-4 border-t border-gray-100">
      <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Travel style</p>
      <div class="flex flex-wrap gap-1.5">
        {travelStyle.map(style => (
          <span class="text-xs px-2.5 py-1 rounded-full bg-blue-50 text-blue-700 font-medium border border-blue-100">
            {formatLabel(style)}
          </span>
        ))}
      </div>
    </div>
  )}

</div>
