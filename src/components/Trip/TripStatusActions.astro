---
const { status, tripId } = Astro.props;

const isCompleted = status === 'completed';
const isDraft = status === 'draft';
const isActive = status === 'active';
const isArchived = status === 'archived';
---

{!isCompleted && (
  <div class="flex gap-2" id="trip-status-actions">
    {isDraft && (
      <button 
        id="publish-trip-btn"
        data-trip-id={tripId}
        class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-all text-sm font-medium shadow-sm flex items-center gap-2"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
        Publish Trip
      </button>
    )}

    {isActive && (
      <button 
        id="archive-trip-btn"
        data-trip-id={tripId}
        class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-all text-sm font-medium shadow-sm flex items-center gap-2"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path>
        </svg>
        Archive Trip
      </button>
    )}

    {isArchived && (
      <button 
        id="restore-trip-btn"
        data-trip-id={tripId}
        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all text-sm font-medium shadow-sm flex items-center gap-2"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
        </svg>
        Restore Trip
      </button>
    )}
  </div>
)}

<script>
  import { showToast } from '@/scripts/Toast';
  import { actions, ActionError } from 'astro:actions';
  import { createConfirmModal } from '@/scripts/Modal';

  const publishBtn = document.getElementById('publish-trip-btn');
  const archiveBtn = document.getElementById('archive-trip-btn');
  const restoreBtn = document.getElementById('restore-trip-btn');

  async function updateTripStatus(tripId: string, newStatus: any, confirmMessage: string, successMessage: string) {
    createConfirmModal({
      message: confirmMessage,
      confirmText: 'Yes, proceed',
      onConfirm: async () => {
        const { data, error } = await actions.trip.updateTripStatus({ 
          trip_id: tripId, 
          status: newStatus 
        });
        
        if (error instanceof ActionError) {
          showToast({ message: error.message, type: 'error' });
        } else {
          showToast({ message: successMessage, type: 'success' });
          setTimeout(() => window.location.reload(), 1500);
        }
      }
    });
  }

  if (publishBtn) {
    publishBtn.addEventListener('click', async () => {
      const tripId = publishBtn.dataset.tripId!;
      await updateTripStatus(
        tripId,
        'active',
        'Publish this trip? It will become visible and joinable.',
        'Trip published successfully!'
      );
    });
  }

  if (archiveBtn) {
    archiveBtn.addEventListener('click', async () => {
      const tripId = archiveBtn.dataset.tripId!;
      await updateTripStatus(
        tripId,
        'archived',
        'Archive this trip? You can restore it later.',
        'Trip archived successfully!'
      );
    });
  }

  if (restoreBtn) {
    restoreBtn.addEventListener('click', async () => {
      const tripId = restoreBtn.dataset.tripId!;
      await updateTripStatus(
        tripId,
        'active',
        'Restore this trip to active status?',
        'Trip restored successfully!'
      );
    });
  }
</script>
