---
import EditModal from '../EditModal.astro';

const { genderPref, maxPax, currentPax, tripId } = Astro.props;
---

<EditModal modalId="edit-preferences-modal" title="Edit Preferences" colorScheme="lime">
  <form id="edit-preferences-form" class="space-y-4">
    <div>
      <label class="label">
        <span class="label-text font-medium">Gender Preference</span>
      </label>
      <select id="gender-input" name="gender_pref" class="select select-bordered w-full" required>
        <option value="any" selected={genderPref === 'any'}>Any</option>
        <option value="male" selected={genderPref === 'male'}>Male Only</option>
        <option value="female" selected={genderPref === 'female'}>Female Only</option>
      </select>
    </div>
    <div>
      <label class="label">
        <span class="label-text font-medium">Maximum Participants</span>
      </label>
      <input 
        type="number" 
        id="max-pax-input"
        name="max_pax"
        value={maxPax}
        min={currentPax}
        max="50"
        class="input input-bordered w-full" 
        required
      />
      <label class="label">
        <span class="label-text-alt text-gray-500">Cannot be less than current members ({currentPax})</span>
      </label>
    </div>
    <div class="modal-action">
      <button type="button" class="btn" onclick="document.getElementById('edit-preferences-modal').close()">Cancel</button>
      <button type="submit" class="btn btn-primary">Save Changes</button>
    </div>
  </form>
</EditModal>

<script>
  import { showToast } from '@/scripts/Toast';
  import { actions, ActionError } from 'astro:actions';

  const form = document.getElementById('edit-preferences-form') as HTMLFormElement;

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(form);
    const tripId = new URLSearchParams(window.location.search).get('id') || 
                   window.location.pathname.split('/').pop();

    const { data, error } = await actions.trip.updateTripPreferences({
      trip_id: tripId!,
      gender_pref: formData.get('gender_pref') as string,
      max_pax: parseInt(formData.get('max_pax') as string)
    });

    if (error instanceof ActionError) {
      showToast({ message: error.message, type: 'error' });
    } else {
      showToast({ message: 'Preferences updated successfully!', type: 'success' });
      setTimeout(() => window.location.reload(), 1500);
    }
  });
</script>
