---
import { Home, Navigation2, Map, Move, User, Plus } from "@lucide/astro";

const { currentPath = "/" } = Astro.props;

const navItems = [
  { href: "/feeds", label: "Feed", icon: Home },
  // { href: "/discover", label: "Discover", icon: Navigation2 },
  { href: "/trips", label: "Trips", icon: Navigation2 },
  { href: "/maps", label: "Maps", icon: Map },
  { href: "/profile", label: "Profile", icon: User },
];
---
<style>
  #bottomNav {
    transform: translateY(100%);
    opacity: 0;
    pointer-events: none;
  }
  #bottomNav.visible {
    transform: translateY(0);
    opacity: 1;
    pointer-events: auto;
  }
  #assistBtn {
    transition: opacity .25s, transform .25s;
  }
</style>

<!-- Floating Assist Button (initial state) -->
<button
  id="assistBtn"
  class="fixed z-[45] w-14 h-14 rounded-full bg-black text-white shadow-md flex items-center justify-center 
         active:scale-95 opacity-80"
  style="bottom: 22px; right: 18px;"
  aria-label="Show navigation"
>
  <img
          src="https://pub-aa2991db87be444fbc5fcb09dbae09a3.r2.dev/ChatGPT%20Image%20Nov%204%2C%202025%2C%2002_47_13%20PM.png"
          alt="Logo" class="w-8 h-8 bg-amber-50" />
</button>

<!-- Bottom Navigation (hidden initially) -->
<nav
  id="bottomNav"
  class="fixed bottom-0 left-0 right-0 z-[40] bg-white border-t border-neutral-200 
         transition-all duration-300 ease-[cubic-bezier(.26,.11,.1,.97)] lg:hidden md:hidden"
  style="padding-bottom: env(safe-area-inset-bottom)"
>
  <ul class="flex justify-around items-center px-2">
    {navItems.map((i, idx) => (
      <>
        {idx === 2 && (
          <li class="-mt-1">
            <a
              href="/trips/create"
              class="flex flex-col items-center justify-center w-12 h-12 rounded-full 
                     bg-black text-white shadow-md transition active:scale-95"
              aria-label="Create trip"
            >
              <Plus class="w-6 h-6" />
            </a>
          </li>
        )}
        <li class="flex-1 text-center">
          <a
            href={i.href}
            class={`flex flex-col items-center gap-0.5 py-3 transition
              ${currentPath.startsWith(i.href) ? "text-black font-semibold" : "text-neutral-500"}`}
          >
            <i.icon class="w-5 h-5" />
            <span class="text-[0.70rem] leading-none">{i.label}</span>
          </a>
        </li>
      </>
    ))}
  </ul>
</nav>

  <script>
// Assist button + bottom nav UX controller
const bottomNav = document.getElementById("bottomNav") as HTMLUListElement;
const assistBtn = document.getElementById("assistBtn") as HTMLButtonElement;

// States
let dragging = false;
let moved = false;
let offsetX = 0;
let offsetY = 0;
let idleTimer: NodeJS.Timeout;

// =============== Helpers ===============
const showNav = () => {
  bottomNav.classList.add("visible");
  assistBtn.style.display = "none";
};

const hideNav = () => {
  bottomNav.classList.remove("visible");
  setTimeout(() => {
    assistBtn.style.display = "flex";
  }, 200);
};

const resetIdle = () => {
  clearTimeout(idleTimer);
  idleTimer = setTimeout(hideNav, 2600);
};

// Make sure button is positioned with left/top instead of right/bottom
function ensureAbsolute() {
  const rect = assistBtn.getBoundingClientRect();
  if (!assistBtn.style.left) {
    assistBtn.style.left = `${rect.left}px`;
    assistBtn.style.top = `${rect.top}px`;
    assistBtn.style.right = "auto";
    assistBtn.style.bottom = "auto";
  }
  assistBtn.style.position = "fixed";
  assistBtn.style.touchAction = "none";
}

// =============== Pointer Events ===============

// pointer down (start drag)
assistBtn.addEventListener("pointerdown", (e) => {
  e.preventDefault();
  ensureAbsolute();

  dragging = true;
  moved = false; // detect tap vs drag

  const rect = assistBtn.getBoundingClientRect();
  offsetX = e.clientX - rect.left;
  offsetY = e.clientY - rect.top;

  assistBtn.setPointerCapture?.(e.pointerId);
  assistBtn.style.opacity = "1";

  window.addEventListener("pointermove", onMove);
  window.addEventListener("pointerup", onUp, { once: true });
});

// pointer move (update dragging)
function onMove(e: PointerEvent) {
  if (!dragging) return;

  // detect if moved (threshold 6px)
  if (!moved) {
    const dx = Math.abs(e.clientX - offsetX - assistBtn.offsetLeft);
    const dy = Math.abs(e.clientY - offsetY - assistBtn.offsetTop);
    if (dx > 6 || dy > 6) moved = true;
  }

  // compute new coords
  let x = e.clientX - offsetX;
  let y = e.clientY - offsetY;

  // clamp inside viewport (8px margin)
  const m = 8;
  x = Math.max(m, Math.min(window.innerWidth - assistBtn.offsetWidth - m, x));
  y = Math.max(m, Math.min(window.innerHeight - assistBtn.offsetHeight - m, y));

  assistBtn.style.left = `${x}px`;
  assistBtn.style.top = `${y}px`;
}

// pointer up (drag end)
function onUp(e: PointerEvent) {
  dragging = false;
  assistBtn.releasePointerCapture?.(e.pointerId);

  window.removeEventListener("pointermove", onMove);

  // Snap to left or right
  const rect = assistBtn.getBoundingClientRect();
  const m = 8;
  const snapLeft =
    rect.left + rect.width / 2 < window.innerWidth / 2
      ? m
      : window.innerWidth - rect.width - m;
  assistBtn.style.left = `${snapLeft}px`;

  assistBtn.style.opacity = ".35"; // dim when idle

  resetIdle(); // restart idle timer
}

// =============== Tap to toggle ===============
assistBtn.addEventListener("click", () => {
  // Only open nav if user actually tapped (not dragged)
  if (!moved) {
    showNav();
    resetIdle();
  }
});

// =============== Page interaction triggers idle hide only when nav shown ===============
["scroll", "touchstart", "keydown", "mousemove"].forEach((evt) => {
  window.addEventListener(evt, () => {
    if (bottomNav.classList.contains("visible")) {
      resetIdle();
    }
  });
});

// =============== Initial state ===============
// Nav hidden on load. Assist visible and draggable.
assistBtn.style.display = "flex";
requestAnimationFrame(() => ensureAbsolute());

  </script>
