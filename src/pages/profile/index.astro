---
import PagePlate from "@/layouts/PagePlate.astro";
import { supabase } from "@/lib/supabase";
import { PUBLIC_R2_URL } from 'astro:env/client';

import EditProfileModal  from "@/components/Profile/EditProfileModal.astro";
import AvatarEditor      from "@/components/Profile/AvatarEditor.astro";
import ProfileHeader     from "@/components/Profile/ProfileHeader.astro";
import ProfileAbout      from "@/components/Profile/ProfileAbout.astro";
import ProfileInterests  from "@/components/Profile/ProfileInterest.astro";
import ProfileTripGrid   from "@/components/Profile/ProfileGrid.astro";
import ProfilePreferences from "@/components/Profile/ProfilePreference.astro";
import ProfileCompletion from "@/components/Profile/ProfileCompletion.astro";

// ── Auth ──────────────────────────────────────────────────────
const user_id = Astro.locals.user_id;
if (!user_id) return Astro.redirect("/signin");

// ── Data ──────────────────────────────────────────────────────
const [{ data: profileData }, { data: userStats }] = await Promise.all([
  supabase.rpc('get_user_profile_data', { p_user_id: user_id }),
  supabase.rpc('get_user_stats',        { p_user_id: user_id }),
]);

const userData:      Record<string, any> = profileData?.profile      || {};
const userInfo:      Record<string, any> = profileData?.information  || {};
const userPrefs:     Record<string, any> = profileData?.preferences  || {};
const userInterests: any[]               = profileData?.interests     || [];

// ── Avatar ────────────────────────────────────────────────────
const getAvatarUrl = (url?: string | null) =>
  !url ? null : url.startsWith('http') ? url : `${PUBLIC_R2_URL}${url}`;

const displayAvatarUrl = getAvatarUrl(userData.avatar_url);
const initials = (userData.full_name || userData.username || 'U').charAt(0).toUpperCase();

// ── Date ──────────────────────────────────────────────────────
const fmtDate = (d?: string | null) => {
  if (!d) return 'Unknown';
  const date = new Date(d);
  return isNaN(date.getTime()) ? 'Unknown'
    : new Intl.DateTimeFormat('en-US', { month: 'long', year: 'numeric' }).format(date);
};
const memberSince = fmtDate(userData.created_at);

// ── Ring ──────────────────────────────────────────────────────
const completion    = Number(userInfo.profile_completion_percentage) || 0;
const circumference = 2 * Math.PI * 52;
const dashOffset    = circumference - (completion / 100) * circumference;
const ringColor     = completion < 50 ? '#F97316' : completion < 80 ? '#3B82F6' : '#10B981';

// ── Project 82 ────────────────────────────────────────────────
const bucketCount = userStats?.bucket_count ?? userStats?.provinces_visited ?? 0;

// ── Checklist ─────────────────────────────────────────────────
const completionItems = [
  { label: 'Add a profile photo',    done: !!userData.avatar_url,                                   modalId: 'avatar-editor-modal',    actionLabel: 'Add'    },
  { label: 'Write a bio',            done: (userData.bio?.length ?? 0) >= 20,                       event:   'profile:openBioEdit',     actionLabel: 'Add'    },
  { label: 'Set your location',      done: !!(userInfo.location_city || userInfo.location_country), modalId: 'edit-profile-modal',      actionLabel: 'Add'    },
  { label: 'Add 3+ interests',       done: userInterests.length >= 3,                               href:    '/onboarding/interests',   actionLabel: 'Add'    },
  { label: 'Set travel preferences', done: !!userPrefs.budget_range,                                href:    '/onboarding/preferences', actionLabel: 'Set'    },
  { label: 'Create your first trip', done: (userStats?.trips_owned ?? 0) > 0,                       href:    '/trips/create',           actionLabel: 'Create' },
];
---

<PagePlate title="My Profile">
<div class="min-h-screen bg-gray-50 pb-24">
  <div class="max-w-4xl mx-auto px-4 pt-5 space-y-4">

    <ProfileHeader
      userData={userData}         userInfo={userInfo}
      userStats={userStats}       displayAvatarUrl={displayAvatarUrl}
      initials={initials}         memberSince={memberSince}
      ringColor={ringColor}       circumference={circumference}
      dashOffset={dashOffset}     bucketCount={bucketCount}
    />

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">

      <div class="lg:col-span-2 space-y-4 left-col">
        <ProfileAbout
          bio={userData.bio || ''}
          locationCity={userInfo.location_city || ''}
          locationCountry={userInfo.location_country || ''}
          memberSince={memberSince}
        />
        <ProfileInterests interests={userInterests} />
        <ProfileTripGrid />
      </div>

      <div class="space-y-4 right-col">
        <ProfilePreferences
          budget={userPrefs.budget_range          ?? null}
          pace={userPrefs.pace_preference         ?? null}
          languages={userPrefs.languages_spoken   ?? null}
          accommodation={userPrefs.accommodation_type ?? null}
          travelStyle={userPrefs.travel_style     ?? null}
        />
        <ProfileCompletion completion={completion} items={completionItems} />
      </div>

    </div>
  </div>
</div>

<EditProfileModal profile={{
  username: userData.username || '', full_name: userData.full_name || '',
  bio: userData.bio || '',           avatar_url: userData.avatar_url || '',
  location_city: userInfo.location_city || '',
  location_country: userInfo.location_country || '',
}} />
<AvatarEditor currentAvatarUrl={userData.avatar_url || ''} />

<div id="profileToast"
     role="status" aria-live="polite"
     class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-gray-900 text-white
            text-sm font-semibold px-4 py-2.5 rounded-xl shadow-xl opacity-0
            pointer-events-none transition-all duration-200 z-[200] translate-y-2">
</div>
</PagePlate>

<style>
  .left-col  > :global(.bg-white):nth-child(1) { animation: fadeUp 0.35s 0.07s ease both; }
  .left-col  > :global(.bg-white):nth-child(2) { animation: fadeUp 0.35s 0.13s ease both; }
  .left-col  > :global(.bg-white):nth-child(3) { animation: fadeUp 0.35s 0.19s ease both; }
  .right-col > :global(.bg-white):nth-child(1) { animation: fadeUp 0.35s 0.10s ease both; }
  .right-col > :global(.bg-white):nth-child(2) { animation: fadeUp 0.35s 0.16s ease both; }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(12px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  @media (prefers-reduced-motion: reduce) {
    .left-col  > :global(.bg-white),
    .right-col > :global(.bg-white) { animation: none; opacity: 1; }
  }

  #profileToast.show {
    opacity: 1 !important; pointer-events: auto;
    transform: translateX(-50%) translateY(0) !important;
  }
</style>

<script>
  const toast = document.getElementById('profileToast')!;
  let timer: ReturnType<typeof setTimeout>;
  document.addEventListener('profile:toast', (e: Event) => {
    toast.textContent = (e as CustomEvent<string>).detail;
    toast.classList.add('show');
    clearTimeout(timer);
    timer = setTimeout(() => toast.classList.remove('show'), 2200);
  });
</script>