---
import AuthLayout from "@/layouts/AuthLayout.astro";
import { PUBLIC_R2_URL } from "astro:env/client";

const { cookies, redirect } = Astro;

const accessToken = cookies.get("sb-access-token");
const refreshToken = cookies.get("sb-refresh-token");

if (accessToken && refreshToken) {
  return redirect("/feeds");
}
---

<AuthLayout title="Sign in to Tara G!" noIndex>
  <div class="bg-white shadow-xl rounded-2xl p-6 sm:p-8 space-y-6">
    <!-- Header -->
    <div class="text-center">
      <div class="flex justify-center mb-4">
        <img
          src=`${PUBLIC_R2_URL}ChatGPT%20Image%20Nov%204%2C%202025%2C%2002_47_13%20PM.png`
          alt="Tara G! Logo" 
          class="w-12 h-12 rounded-lg"
        />
      </div>
      <h1 class="text-2xl sm:text-3xl font-semibold text-gray-900">Welcome Back</h1>
      <p class="text-gray-600 mt-2 text-sm sm:text-base">
        New here? 
        <a href="/register" class="text-blue-600 font-medium hover:text-blue-700 transition-colors">Create an account</a>
      </p>
    </div>

    <!-- General Error Display -->
    <div id="generalError" class="hidden p-4 bg-red-50 border border-red-200 rounded-lg" role="alert">
      <div class="flex items-start gap-3">
        <svg class="w-5 h-5 text-red-500 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
        </svg>
        <div>
          <p class="text-sm font-medium text-red-800">Login failed</p>
          <p id="generalErrorText" class="text-sm text-red-600 mt-1"></p>
        </div>
      </div>
    </div>

    <!-- Sign In Form -->
    <form id="signinForm" class="space-y-6" novalidate>
      <!-- Email Field -->
      <div>
        <label for="email" id="email-label" class="block text-sm font-medium text-gray-700 mb-2">
          Email Address
        </label>
        <div class="relative">
          <input
            type="email"
            id="email"
            name="email"
            required
            aria-required="true"
            aria-describedby="email-help email-error"
            aria-invalid="false"
            autocomplete="email"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition pr-10 text-sm sm:text-base"
            placeholder="you@example.com"
          />
          <div id="emailError" class="hidden absolute right-3 top-1/2 transform -translate-y-1/2" aria-hidden="true">
            <svg class="w-5 h-5 text-red-500" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
            </svg>
          </div>
        </div>
        <div id="email-help" class="sr-only">Enter your email address</div>
        <p id="emailErrorText" class="mt-1 text-sm text-red-600 hidden"></p>
      </div>

      <!-- Password Field -->
      <div>
        <label for="password" id="password-label" class="block text-sm font-medium text-gray-700 mb-2">
          Password
        </label>
        <div class="relative">
          <input
            type="password"
            id="password"
            name="password"
            required
            aria-required="true"
            aria-describedby="password-help password-error"
            aria-invalid="false"
            autocomplete="current-password"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition pr-10 text-sm sm:text-base"
            placeholder="•••••••"
          />
          <div id="passwordError" class="hidden absolute right-3 top-1/2 transform -translate-y-1/2" aria-hidden="true">
            <svg class="w-5 h-5 text-red-500" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
            </svg>
          </div>
        </div>
        <div id="password-help" class="sr-only">Enter your password</div>
        <p id="passwordErrorText" class="mt-1 text-sm text-red-600 hidden"></p>
      </div>

      <!-- Remember me + Forgot password -->
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <label class="flex items-center cursor-pointer group">
          <input 
            type="checkbox" 
            id="remember" 
            class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 w-4 h-4"
          />
          <span class="ml-2 text-sm text-gray-600 group-hover:text-gray-700 transition-colors">Remember me</span>
        </label>
        <a href="/forgot-password" class="text-sm text-blue-600 hover:text-blue-700 transition-colors">
          Forgot password?
        </a>
      </div>

      <!-- Submit Button -->
      <button
        type="submit"
        id="signinButton"
        class="
          w-full py-3 bg-blue-600 text-white font-semibold rounded-lg 
          hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 transition-all 
          flex items-center justify-center gap-2 
          disabled:opacity-50 disabled:cursor-not-allowed
          min-h-[44px] sm:min-h-[48px]
          shadow-md hover:shadow-lg
        "
      >
        <span id="signinButtonText">Sign In</span>
        <div id="signinSpinner" class="hidden">
          <svg class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </div>
      </button>
    </form>

    <!-- Social Login -->
    <div class="mt-6">
      <div class="flex items-center my-6">
        <hr class="flex-grow border-gray-300" />
        <span class="px-3 text-gray-500 text-sm whitespace-nowrap">or continue with</span>
        <hr class="flex-grow border-gray-300" />
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <button
          id="googleSignIn"
          type="button"
          class="
            flex items-center justify-center gap-2 border border-gray-300 rounded-lg py-3 
            hover:bg-gray-50 focus:ring-4 focus:ring-gray-200 transition 
            disabled:opacity-50 disabled:cursor-not-allowed
            min-h-[44px] sm:min-h-[48px]
          "
          aria-label="Sign in with Google"
        >
          <img src=`${PUBLIC_R2_URL}icons8-google-48.png` alt="Google" class="w-5 h-5" />
          <span>Google</span> 
        </button>

        <button
          id="facebookSignIn"
          type="button"
          class="
            flex items-center justify-center gap-2 border border-gray-300 rounded-lg py-3 
            hover:bg-gray-50 focus:ring-4 focus:ring-gray-200 transition 
            disabled:opacity-50 disabled:cursor-not-allowed
            min-h-[44px] sm:min-h-[48px]
          "
          aria-label="Sign in with Facebook"
        >
          <img src=`${PUBLIC_R2_URL}icons8-facebook-48.png` alt="Facebook" class="w-5 h-5" />
          <span>Facebook</span>
        </button>
      </div>
    </div>

    <!-- Footer Links -->
    <div class="text-center pt-4 border-t border-gray-100">
      <p class="text-xs text-gray-500">
        By signing in, you agree to our 
        <a href="/legals/terms-and-conditions" class="text-blue-600 hover:text-blue-700 transition-colors">Terms</a> 
        and 
        <a href="/legals/privacy-policy" class="text-blue-600 hover:text-blue-700 transition-colors">Privacy Policy</a>
      </p>
    </div>
  </div>
</AuthLayout>

<script >
  import { showToast } from "@/scripts/Toast";
  import { clientSchemas, FormValidator } from "@/lib/clientValidation";
  import { getPendingTripShare, clearPendingTripShare } from "@/lib/tripShare";
  
  const getRedirectUrl = (): string => {
    // Priority 1: ?next= param set by middleware when redirecting an unauthenticated user
    const urlParams = new URLSearchParams(window.location.search);
    const next = urlParams.get('next');
    if (next && next.startsWith('/')) {
      return next;
    }
    // Priority 2: pending trip share cookie (invitation links)
    const pending = getPendingTripShare();
    if (pending) {
      clearPendingTripShare();
      return `/trips/${pending.tripId}`;
    }
    return '/feeds';
  };

  class SignInForm {
    private formValidator: FormValidator;
    private elements = {
      form: null as HTMLFormElement | null,
      emailInput: null as HTMLInputElement | null,
      emailError: null as HTMLElement | null,
      emailErrorText: null as HTMLElement | null,
      passwordInput: null as HTMLInputElement | null,
      passwordError: null as HTMLElement | null,
      passwordErrorText: null as HTMLElement | null,
      submitButton: null as HTMLButtonElement | null,
      submitButtonText: null as HTMLElement | null,
      submitSpinner: null as HTMLElement | null,
      generalError: null as HTMLElement | null,
      generalErrorText: null as HTMLElement | null,
      googleButton: null as HTMLButtonElement | null,
      facebookButton: null as HTMLButtonElement | null,
    };

    private isInCooldown = false;
    private cooldownInterval: NodeJS.Timeout | null = null;

    constructor() {
      this.formValidator = new FormValidator(clientSchemas.signIn);
      this.initializeElements();
      this.attachEventListeners();
    }

    private initializeElements() {
      this.elements.form = document.getElementById('signinForm') as HTMLFormElement;
      this.elements.emailInput = document.getElementById('email') as HTMLInputElement;
      this.elements.emailError = document.getElementById('emailError') as HTMLElement;
      this.elements.emailErrorText = document.getElementById('emailErrorText') as HTMLElement;
      this.elements.passwordInput = document.getElementById('password') as HTMLInputElement;
      this.elements.passwordError = document.getElementById('passwordError') as HTMLElement;
      this.elements.passwordErrorText = document.getElementById('passwordErrorText') as HTMLElement;
      this.elements.submitButton = document.getElementById('signinButton') as HTMLButtonElement;
      this.elements.submitButtonText = document.getElementById('signinButtonText') as HTMLElement;
      this.elements.submitSpinner = document.getElementById('signinSpinner') as HTMLElement;
      this.elements.generalError = document.getElementById('generalError') as HTMLElement;
      this.elements.generalErrorText = document.getElementById('generalErrorText') as HTMLElement;
      this.elements.googleButton = document.getElementById('googleSignIn') as HTMLButtonElement;
      this.elements.facebookButton = document.getElementById('facebookSignIn') as HTMLButtonElement;
    }

    private attachEventListeners() {
      const { form, emailInput, passwordInput, submitButton, googleButton, facebookButton } = this.elements;

      // Form submission
      form?.addEventListener('submit', this.handleSubmit.bind(this));

      // Real-time field validation
      emailInput?.addEventListener('blur', this.handleEmailBlur.bind(this));
      emailInput?.addEventListener('input', this.debounce(this.handleEmailInput.bind(this), 300));
      
      passwordInput?.addEventListener('blur', this.handlePasswordBlur.bind(this));
      passwordInput?.addEventListener('input', this.debounce(this.handlePasswordInput.bind(this), 300));

      // Clear errors on focus
      emailInput?.addEventListener('focus', () => this.hideFieldError('email'));
      passwordInput?.addEventListener('focus', () => this.hideFieldError('password'));

      // Social login
      googleButton?.addEventListener('click', this.handleGoogleSignIn.bind(this));
      facebookButton?.addEventListener('click', this.handleFacebookSignIn.bind(this));

      // Prevent form resubmission
      submitButton?.addEventListener('click', () => {
        if (submitButton?.disabled) {
          return false;
        }
      });
    }

    private debounce(func: Function, wait: number) {
      let timeout: NodeJS.Timeout;
      return (...args: any[]) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    private async handleSubmit(e: Event) {
      e.preventDefault();
      
      // Check if in cooldown
      if (this.isInCooldown) {
        return;
      }
      
      this.hideAllErrors();

      const { form, emailInput, passwordInput } = this.elements;
      
      if (!form || !emailInput || !passwordInput) return;

      const formData = new FormData(form);
      
      // Client-side validation
      if (!this.formValidator.validate(formData)) {
        const errors = this.formValidator.getErrors();
        
        if (errors.email) this.showFieldError('email', errors.email);
        if (errors.password) this.showFieldError('password', errors.password);
        if (errors._form) this.showGeneralError(errors._form);
        
        return;
      }

      this.setLoading(true);

      try {
        const response = await fetch('/api/auth/signin', {
          method: 'POST',
          body: formData,
          headers: {
            'Accept': 'application/json',
          },
          redirect: 'manual'
        });

        // Handle redirect manually
        if (response.type === 'opaqueredirect' || response.status === 302 || response.status === 301) {
          showToast({ 
            message: 'Login successful! Redirecting...', 
            type: 'success' 
          });
          const redirectUrl = getRedirectUrl();
          window.location.href = redirectUrl;
          return;
        }

        if (response.ok) {
          showToast({ 
            message: 'Login successful! Redirecting...', 
            type: 'success' 
          });
          
          // Server will handle redirect, but add fallback with pending trip check
          const redirectUrl = getRedirectUrl();
          setTimeout(() => {
            window.location.href = redirectUrl;
          }, 1500);
        } else if (response.status === 429) {
          // Handle rate limit (429 Too Many Requests)
          try {
            const errorData: any = await response.json();
            const remainingSeconds = errorData.details?.remaining_seconds || 60;
            this.showGeneralError(errorData.message || 'Too many login attempts. Please wait before trying again.');
            this.startCooldown(remainingSeconds);
          } catch {
            this.showGeneralError('Too many login attempts. Please wait before trying again.');
            this.startCooldown(60);
          }
        } else {
          const errorData: any = await response.json();
          
          // Handle rate limiting (login attempt cooldown)
          if (errorData.code === 'RATE_LIMITED') {
            const remainingSeconds = errorData.details?.remaining_seconds || 60;
            this.showGeneralError(errorData.message);
            this.startCooldown(remainingSeconds);
            return;
          }
          
          if (errorData.code === 'AUTHENTICATION_ERROR') {
            this.showGeneralError(errorData.message);
            // Focus on the problematic field
            if (errorData.message?.toLowerCase().includes('email')) {
              emailInput?.focus();
            } else {
              passwordInput?.focus();
            }
          } else if (errorData.code === 'VALIDATION_ERROR') {
            // Handle field-specific validation errors
            if (errorData.details?.email) {
              this.showFieldError('email', errorData.details.email);
            }
            if (errorData.details?.password) {
              this.showFieldError('password', errorData.details.password);
            }
            if (!errorData.details || Object.keys(errorData.details).length === 0) {
              this.showGeneralError(errorData.message);
            }
          } else {
            this.showGeneralError(errorData.message || 'Login failed. Please try again.');
          }
        }
      } catch (error) {
        console.error('Login error:', error);
        this.showGeneralError('Network error. Please check your connection and try again.');
        showToast({ 
          message: 'Network error. Please try again.', 
          type: 'error' 
        });
      } finally {
        this.setLoading(false);
      }
    }

    private handleEmailBlur() {
      const { emailInput } = this.elements;
      if (!emailInput?.value.trim()) return;

      const error = this.formValidator.validateField('email', emailInput.value.trim());
      if (error) {
        this.showFieldError('email', error);
      }
    }

    private handleEmailInput() {
      const { emailInput, emailError } = this.elements;
      if (emailError?.classList.contains('hidden') === false) {
        const error = this.formValidator.validateField('email', emailInput?.value.trim() || '');
        if (!error) {
          this.hideFieldError('email');
        }
      }
    }

    private handlePasswordBlur() {
      const { passwordInput } = this.elements;
      if (!passwordInput?.value) return;

      const error = this.formValidator.validateField('password', passwordInput.value);
      if (error) {
        this.showFieldError('password', error);
      }
    }

    private handlePasswordInput() {
      const { passwordInput, passwordError } = this.elements;
      if (passwordError?.classList.contains('hidden') === false) {
        const error = this.formValidator.validateField('password', passwordInput?.value || '');
        if (!error) {
          this.hideFieldError('password');
        }
      }
    }

    private async handleGoogleSignIn() {
      await this.handleSocialSignIn('google');
    }

    private async handleFacebookSignIn() {
      await this.handleSocialSignIn('facebook');
    }

    private handleSocialSignIn(provider: string) {
      this.setLoading(true);

      // Create a form and submit it to trigger the redirect properly
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '/api/auth/signin';
      form.style.display = 'none';

      const providerInput = document.createElement('input');
      providerInput.type = 'hidden';
      providerInput.name = 'provider';
      providerInput.value = provider;
      form.appendChild(providerInput);

      // Carry ?next= through OAuth so the callback can redirect back to the original page
      const next = new URLSearchParams(window.location.search).get('next');
      if (next && next.startsWith('/')) {
        const nextInput = document.createElement('input');
        nextInput.type = 'hidden';
        nextInput.name = 'next';
        nextInput.value = next;
        form.appendChild(nextInput);
      }

      document.body.appendChild(form);
      form.submit();
    }

    private setLoading(loading: boolean) {
      const { submitButton, submitButtonText, submitSpinner, googleButton, facebookButton } = this.elements;
      
      if (submitButton) submitButton.disabled = loading;
      if (googleButton) googleButton.disabled = loading;
      if (facebookButton) facebookButton.disabled = loading;
      
      if (loading) {
        submitButtonText?.classList.add('hidden');
        submitSpinner?.classList.remove('hidden');
      } else {
        submitButtonText?.classList.remove('hidden');
        submitSpinner?.classList.add('hidden');
      }
    }

    private showFieldError(fieldName: string, message: string) {
      const errorIcon = document.getElementById(`${fieldName}Error`);
      const errorText = document.getElementById(`${fieldName}ErrorText`);
      const input = document.getElementById(fieldName) as HTMLInputElement;
      
      errorIcon?.classList.remove('hidden');
      if (errorText) errorText.textContent = message;
      errorText?.classList.remove('hidden');
      
      if (input) {
        input.classList.add('border-red-500');
        input.classList.remove('border-gray-300');
        input.setAttribute('aria-invalid', 'true');
      }
    }

    private hideFieldError(fieldName: string) {
      const errorIcon = document.getElementById(`${fieldName}Error`);
      const errorText = document.getElementById(`${fieldName}ErrorText`);
      const input = document.getElementById(fieldName) as HTMLInputElement;
      
      errorIcon?.classList.add('hidden');
      errorText?.classList.add('hidden');
      
      if (input) {
        input.classList.remove('border-red-500');
        input.classList.add('border-gray-300');
        input.setAttribute('aria-invalid', 'false');
      }
    }

    private showGeneralError(message: string) {
      const { generalError, generalErrorText } = this.elements;
      
      if (generalErrorText) generalErrorText.textContent = message;
      if (generalError) generalError.classList.remove('hidden');
      
      // Scroll to error for accessibility
      generalError?.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    private hideAllErrors() {
      this.hideFieldError('email');
      this.hideFieldError('password');
      
      const { generalError } = this.elements;
      if (generalError) generalError.classList.add('hidden');
    }

    private startCooldown(seconds: number) {
      const { submitButton } = this.elements;
      
      // Set cooldown state
      this.isInCooldown = true;
      
      if (this.cooldownInterval) {
        clearInterval(this.cooldownInterval);
      }

      const updateButton = () => {
        if (seconds <= 0) {
          if (this.cooldownInterval) {
            clearInterval(this.cooldownInterval);
            this.cooldownInterval = null;
          }
          // Reset cooldown state
          this.isInCooldown = false;
          if (submitButton) {
            submitButton.textContent = 'Sign In';
            submitButton.removeAttribute('disabled');
            submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
          }
          return;
        }

        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        const timeStr = minutes > 0 
          ? `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`
          : `${remainingSeconds}s`;
        
        if (submitButton) {
          submitButton.textContent = `Try again in ${timeStr}`;
          submitButton.setAttribute('disabled', 'true');
          submitButton.classList.add('opacity-50', 'cursor-not-allowed');
        }
        
        seconds--;
      };

      updateButton();
      this.cooldownInterval = setInterval(updateButton, 1000);
    }
  }

  // Initialize form when DOM is ready
  document.addEventListener('DOMContentLoaded', () => {
    new SignInForm();
  });
</script>