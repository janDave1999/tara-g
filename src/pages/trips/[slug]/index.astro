---
import PagePlate from '@/layouts/PagePlate.astro';
import { actions } from 'astro:actions';
import Summary from '@/components/Trip/Summary.astro';
import Itinerary from '@/components/Trip/Itinerary.astro';
import Hero from '@/components/Trip/Hero.astro';
import { undefined } from 'astro:schema';
// import type { Trip } from '@/types/trip';

let userID = Astro.locals.user_id || "";
let slug = Astro.params.slug || "";

// Fetch trip data
let { data: tripDATA, error } = await Astro.callAction(actions.trip.getTripDetails, { slug });
if (error) throw error;

// Define Trip type for fetched data
type TripData = {
  trip_id: string;
  owner_id: string;
  title: string;
  description: string;
  status: string;
  trip_details?: Array<{
    join_by: string;
    start_date: string;
    end_date: string;
    gender_pref: string;
    cost_sharing: string;
    region: string;
    cover_image: string;
    tags: string[];
    max_pax: number;
  }>;
  trip_location?: Array<{
    start_time: string;
    end_time: string;
    waiting_time: number;
    type: string;
    locations?: Array<{
      name: string;
      lat: number;
      lng: number;
    }>;
  }>;
  trip_members?: Array<{ user_id: string }>;
  trip_pools?: Array<{ total_pool: number; currency: string }>;
  trip_pool_members?: Array<{ user_id: string; contribution: number; balance: number }>;
  trip_expenses?: Array<{ user_id: string; description: string; category: string; amount: number }>;
  trip_images?: Array<{ type: string; key_name: string; }>;
  trip_visibility?: Array<{ current_participants: number; max_participants: number, visibility: string }>;
};

if (!tripDATA) {
  return Astro.redirect("/trips");
}
let trip = tripDATA as TripData;
// Extract the first detail object
let trip_details = trip.trip_details?.[0];

// Keep other nested arrays
let trip_location = trip.trip_location;
let trip_members = trip.trip_members;
let trip_pools = trip.trip_pools;
let trip_pool_members = trip.trip_pool_members;
let trip_expenses = trip.trip_expenses;
let trip_images = trip.trip_images;
let trip_visibility = trip.trip_visibility;

let isOwner: boolean = false;

if (trip.owner_id === userID) {
  isOwner = true;
} else {
  isOwner = false;
}
---

<PagePlate title={trip.title}>
  <Hero server:defer isOwner={isOwner} trip_images={trip_images}/>

  <Summary server:defer
      owner={trip.owner_id}
      userID={userID}
      status={trip.status}
      title={trip.title}
      joinBy={trip_details?.join_by}
      description={trip.description}
      destination={trip_details?.region}
      tripStart={trip_details?.start_date}
      tripEnd={trip_details?.end_date}
      genderPref={trip_details?.gender_pref}
      maxPax={trip_details?.max_pax}
      costSharing={trip_details?.cost_sharing}
      tags={trip_details?.tags}
      maxPax={trip_visibility?.[0].max_participants}
      currentPax={trip_visibility?.[0].current_participants}
      visibility={trip_visibility?.[0].visibility}
    />
  
<Itinerary 
  server:defer
  trip_location={(trip_location as any) || undefined}
  isOwner={isOwner} 
  tripId={trip.trip_id}
/>

  <!-- Members & Pools -->

  <!-- Expenses -->


  <!-- Blog Section When trip is complete -->
</PagePlate>
