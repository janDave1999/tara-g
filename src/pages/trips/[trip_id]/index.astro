---
import Layout from '@/layouts/PagePlate.astro';
import TripHeader from '@/components/Trip/TripHeader.astro';
import TripDetails from '@/components/Trip/Summary.astro';
import Member from '@/components/Trip/Member.astro';
import { supabaseAdmin } from '@/lib/supabase';
import Itinerary from '@/components/Trip/Itinerary/Itinerary.astro';
import Hero from '@/components/Trip/Hero.astro';

const slug = Astro.params.trip_id || '';
const user = Astro.locals.user_id;

// Get trip data
const { data: tripData, error } = await supabaseAdmin.rpc('get_trip_full_details', {
  p_trip_id: slug,
  p_current_user_id: user
});

if (error || !tripData) {
  return Astro.redirect('/404');
}


const trip = tripData;

const {
  trip_id,
  title,
  description,
  status,
  user_role,
  trip_details,
  trip_locations,
  trip_members,
  trip_visibility,
  trip_images,
} = trip;


// Get primary location (destination)
const primaryLocation = trip_locations?.find((loc: any) => loc.is_primary);
const destination = primaryLocation?.location?.name || primaryLocation?.location_name || 'No destination set';

// Load itinerary stops (exclude destination — shown in header)
// pickup and dropoff ARE included — they anchor the timeline with trip creation datetimes
const { data: itineraryStops } = await supabaseAdmin
  .from('trip_location')
  .select('*, location:locations(*), activities:stop_activities(*)')
  .eq('trip_id', trip_id)
  .not('location_type', 'in', '(destination)')
  .order('scheduled_start', { ascending: true, nullsFirst: false });

// Detect if the viewing user has a pending invitation — query trip_invitations directly
// (more reliable than checking trip_members which uses an INNER JOIN with public.users)
let pendingInvitationId: string | null = null;
if (user) {
  const { data: inv } = await supabaseAdmin
    .from('trip_invitations')
    .select('invitation_id')
    .eq('trip_id', trip_id)
    .eq('invitee_id', user)
    .eq('status', 'pending')
    .gt('expires_at', new Date().toISOString())
    .maybeSingle();
  pendingInvitationId = inv?.invitation_id || null;
}
const isInvited = !!pendingInvitationId;

// Prepare props for components
const tripProps = {
  tripId: trip_id,
  title,
  description: trip_details?.description || description,
  tripStatus: status,
  userRole: user_role,
  visibility: trip_visibility?.visibility || 'private',
  
  // Trip Details
  destination,
  tripStart: trip_details?.start_date,
  tripEnd: trip_details?.end_date,
  joinedBy: trip_details?.join_by 
    ? `${trip_details.join_by}T${trip_details.join_by_time || '23:59:00'}`
    : null,
  
  // Members
  currentPax: trip_members?.filter((m: any) => m.member_status === 'joined').length || 0,
  maxPax: trip_details?.max_pax || 0,
  members: trip_members || [],
  
  // Preferences
  genderPref: trip_details?.gender_pref || 'any',
  costSharing: trip_details?.cost_sharing || 'split_evenly',
  estimatedBudget: trip_details?.estimated_budget,
  
  // Tags
  tags: trip_details?.tags || [],
  
  // Locations
  locations: trip_locations || [],

  // Invitation state
  isInvited,
};
---

<Layout title={`${title} | Tara G`}>
  <section class="max-w-5xl mx-auto mt-6 mb-20 px-4 space-y-5">

    <!-- Invitation Banner (only shown to invited users) -->
    {isInvited && pendingInvitationId && (
      <div class="rounded-2xl border border-amber-200 bg-amber-50 px-6 py-5 flex flex-col sm:flex-row sm:items-center gap-4">
        <div class="flex items-center gap-3 flex-1 min-w-0">
          <div class="w-10 h-10 rounded-xl bg-amber-100 flex items-center justify-center shrink-0">
            <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
            </svg>
          </div>
          <div>
            <p class="text-sm font-semibold text-amber-900">You've been invited to join this trip!</p>
            <p class="text-xs text-amber-700 mt-0.5">Accept to become a member and access the full itinerary.</p>
          </div>
        </div>
        <div class="flex items-center gap-2 shrink-0">
          <button
            id="accept-invite-btn"
            data-invitation-id={pendingInvitationId}
            class="px-5 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold transition-all disabled:opacity-50"
          >
            Accept Invitation
          </button>
          <button
            id="decline-invite-btn"
            data-invitation-id={pendingInvitationId}
            class="px-5 py-2 rounded-lg bg-white hover:bg-gray-50 border border-gray-200 text-gray-700 text-sm font-semibold transition-all disabled:opacity-50"
          >
            Decline
          </button>
        </div>
      </div>
    )}

    <!-- Card 1: Hero image + Trip title/meta -->
    <div class="rounded-2xl overflow-hidden border border-gray-200 shadow-sm bg-white">
      <Hero server:defer userRole={trip.user_role} trip_images={trip_images} />
      <TripHeader {...tripProps} />
    </div>

    <!-- Card 2: Trip details (destination, dates, members, preferences, budget, description) -->
    <div class="rounded-2xl overflow-hidden border border-gray-100 shadow-sm bg-white">
      <TripDetails {...tripProps} />
    </div>

    <Member tripId={trip_id} />
    <Itinerary
      initialData={itineraryStops || []}
      isOwner={trip.user_role === 'owner'}
      tripId={trip.trip_id}
      destination={destination}
    />

  </section>
</Layout>

<script>
  import { showToast } from '@/scripts/Toast';
  import { actions, ActionError } from 'astro:actions';
  import { createConfirmModal } from '@/scripts/Modal';

  const joinBtn = document.getElementById('join-btn') as HTMLButtonElement;
  const cancelRequestBtn = document.getElementById('cancel-req-btn') as HTMLButtonElement;
  const leaveTripBtn = document.getElementById('leave-trip-btn') as HTMLButtonElement;
  const acceptInviteBtn = document.getElementById('accept-invite-btn') as HTMLButtonElement | null;
  const declineInviteBtn = document.getElementById('decline-invite-btn') as HTMLButtonElement | null;

  const tripId = window.location.pathname.split('/').pop();

  if (acceptInviteBtn) {
    acceptInviteBtn.addEventListener('click', async () => {
      const invitationId = acceptInviteBtn.dataset.invitationId!;
      acceptInviteBtn.disabled = true;
      acceptInviteBtn.textContent = 'Accepting...';
      if (declineInviteBtn) declineInviteBtn.disabled = true;

      const { error } = await actions.trip.acceptTripInvitation({ invitationId });
      if (error instanceof ActionError) {
        showToast({ message: error.message, type: 'error' });
        acceptInviteBtn.disabled = false;
        acceptInviteBtn.textContent = 'Accept Invitation';
        if (declineInviteBtn) declineInviteBtn.disabled = false;
      } else {
        showToast({ message: 'Invitation accepted! Welcome to the trip.', type: 'success' });
        setTimeout(() => window.location.reload(), 1200);
      }
    });
  }

  if (declineInviteBtn) {
    declineInviteBtn.addEventListener('click', async () => {
      const invitationId = declineInviteBtn.dataset.invitationId!;
      declineInviteBtn.disabled = true;
      declineInviteBtn.textContent = 'Declining...';
      if (acceptInviteBtn) acceptInviteBtn.disabled = true;

      const { error } = await actions.trip.declineTripInvitation({ invitationId });
      if (error instanceof ActionError) {
        showToast({ message: error.message, type: 'error' });
        declineInviteBtn.disabled = false;
        declineInviteBtn.textContent = 'Decline';
        if (acceptInviteBtn) acceptInviteBtn.disabled = false;
      } else {
        showToast({ message: 'Invitation declined.', type: 'info' });
        setTimeout(() => window.location.href = '/trips', 1200);
      }
    });
  }

  if (joinBtn) {
    joinBtn.addEventListener('click', async () => {
      createConfirmModal({
        message: 'Are you sure you want to join this trip?',
        confirmText: 'Join',
        onConfirm: async () => {
          const { error } = await actions.trip.joinTrip({ trip_id: tripId! });
          if (error instanceof ActionError) {
            showToast({ message: error.message, type: 'error' });
          } else {
            showToast({ message: 'Joined trip successfully!', type: 'success' });
            setTimeout(() => window.location.reload(), 1500);
          }
        },
      });
    });
  }

  if (cancelRequestBtn) {
    cancelRequestBtn.addEventListener('click', async () => {
      createConfirmModal({
        message: 'Are you sure you want to cancel your request to join this trip?',
        confirmText: 'Yes, cancel request',
        onConfirm: async () => {
          const { error } = await actions.trip.cancelJoinRequest({ trip_id: tripId! });
          if (error instanceof ActionError) {
            showToast({ message: error.message, type: 'error' });
          } else {
            showToast({ message: 'Canceled trip request successfully!', type: 'success' });
            setTimeout(() => window.location.reload(), 1500);
          }
        },
      });
    });
  }

  if (leaveTripBtn) {
    leaveTripBtn.addEventListener('click', async () => {
      createConfirmModal({
        message: 'Are you sure you want to leave this trip?',
        confirmText: 'Yes, leave trip',
        onConfirm: async () => {
          const { error } = await actions.trip.leaveTrip({ trip_id: tripId! });
          if (error instanceof ActionError) {
            showToast({ message: error.message, type: 'error' });
          } else {
            showToast({ message: 'Left trip successfully!', type: 'success' });
            setTimeout(() => (window.location.href = '/trips'), 1500);
          }
        },
      });
    });
  }
</script>