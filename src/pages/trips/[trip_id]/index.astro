---
import Layout from '@/layouts/PagePlate.astro';
import TripHeader from '@/components/Trip/TripHeader.astro';
import TripDetails from '@/components/Trip/Summary.astro';
import Member from '@/components/Trip/Member.astro';
import { supabaseAdmin } from '@/lib/supabase';
import Itinerary2 from '@/components/Trip/Itinerary/Itinerary2.astro';
import Hero from '@/components/Trip/Hero.astro';
import type { CompleteStop } from '@/types/itinerary';

const slug = Astro.params.trip_id || '';
const user = Astro.locals.user_id;

// Get trip data
const { data: tripData, error } = await supabaseAdmin.rpc('get_trip_full_details', {
  p_trip_id: slug,
  p_current_user_id: user
});

if (error || !tripData) {
  return Astro.redirect('/404');
}


const trip = tripData;

const {
  trip_id,
  title,
  description,
  status,
  user_role,
  trip_details,
  trip_locations,
  trip_members,
  trip_visibility,
  trip_images,
} = trip;

// Get primary location (destination)
const primaryLocation = trip_locations?.find((loc: any) => loc.is_primary);
const destination = primaryLocation?.location?.name || 'No destination set';

// Prepare props for components
const tripProps = {
  tripId: trip_id,
  title,
  description: trip_details?.description || description,
  tripStatus: status,
  userRole: user_role,
  visibility: trip_visibility?.visibility || 'private',
  
  // Trip Details
  destination,
  tripStart: trip_details?.start_date,
  tripEnd: trip_details?.end_date,
  joinedBy: trip_details?.join_by 
    ? `${trip_details.join_by}T${trip_details.join_by_time || '23:59:00'}`
    : null,
  
  // Members
  currentPax: trip_members?.length || 0,
  maxPax: trip_details?.max_pax || 0,
  members: trip_members || [],
  
  // Preferences
  genderPref: trip_details?.gender_pref || 'any',
  costSharing: trip_details?.cost_sharing || 'split_evenly',
  estimatedBudget: trip_details?.estimated_budget,
  
  // Tags
  tags: trip_details?.tags || [],
  
  // Locations
  locations: trip_locations || []
};
---

<Layout title={`${title} | Tara G`}>
  <section class="max-w-5xl mx-auto mt-8 mb-16 px-4">
    <div class="bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden">
      <Hero server:defer userRole={trip.user_role} trip_images={trip_images}/>
      <TripHeader client:visible {...tripProps} />
      <TripDetails {...tripProps} />
    </div>

    {/* Action Buttons for Join/Leave */}
    {user_role !== 'owner' && (
      <div class="mt-6 flex justify-end gap-3">
        {user_role === 'visitor' && trip_members.length < trip_details.max_pax && status === 'active' && (
          <button 
            id="join-btn" 
            class="btn btn-lg bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white border-none shadow-lg shadow-green-500/30"
          >
            Request to Join
          </button>
        )}
        
        {user_role === 'visitor' && trip_members.length >= trip_details.max_pax && (
          <button class="btn btn-lg bg-gray-100 text-gray-400 cursor-not-allowed" disabled>
            Trip Full
          </button>
        )}
        
        {user_role === 'pending' && (
          <button 
            id="cancel-req-btn" 
            class="btn btn-lg bg-amber-50 hover:bg-amber-100 text-amber-700 border border-amber-200"
          >
            Cancel Request
          </button>
        )}
        
        {user_role === 'member' && (
          <button 
            id="leave-trip-btn"
            class="btn btn-lg bg-red-50 hover:bg-red-100 text-red-600 border border-red-200"
          >
            Leave Trip
          </button>
        )}
      </div>
    )}

    {/* Members */}
    {(user_role === 'owner' || user_role === 'member') && (
      <div class="mt-6">
        <div class="flex items-center justify-between mb-2">
          <p class="text-sm text-gray-500">
            {trip_members.length} of {trip_details?.max_pax || 0} members joined
          </p>
          <button
            id="member-btn"
            class="btn btn-sm bg-white border border-gray-200 hover:bg-gray-50 gap-2 shadow-sm"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
            {user_role === 'owner' ? 'Manage Members' : 'View Members'}
          </button>
        </div>
        <Member tripId={trip_id} />
      </div>
    )}
    <Itinerary2
      client:visible
      initialData={(trip_locations as CompleteStop[]) || undefined}
      isOwner={trip.user_role === 'owner'}
      tripId={trip.trip_id}
      destination={destination}
    />

  </section>
</Layout>

<script>
  import { showToast } from '@/scripts/Toast';
  import { actions, ActionError } from 'astro:actions';
  import { createConfirmModal } from '@/scripts/Modal';

  const joinBtn = document.getElementById('join-btn') as HTMLButtonElement;
  const cancelRequestBtn = document.getElementById('cancel-req-btn') as HTMLButtonElement;
  const leaveTripBtn = document.getElementById('leave-trip-btn') as HTMLButtonElement;
  
  const tripId = window.location.pathname.split('/').pop();

  if (joinBtn) {
    joinBtn.addEventListener('click', async () => {
      createConfirmModal({
        message: 'Are you sure you want to join this trip?',
        confirmText: 'Join',
        onConfirm: async () => {
          const { error } = await actions.trip.joinTrip({ trip_id: tripId! });
          if (error instanceof ActionError) {
            showToast({ message: error.message, type: 'error' });
          } else {
            showToast({ message: 'Joined trip successfully!', type: 'success' });
            setTimeout(() => window.location.reload(), 1500);
          }
        },
      });
    });
  }

  if (cancelRequestBtn) {
    cancelRequestBtn.addEventListener('click', async () => {
      createConfirmModal({
        message: 'Are you sure you want to cancel your request to join this trip?',
        confirmText: 'Yes, cancel request',
        onConfirm: async () => {
          const { error } = await actions.trip.cancelJoinRequest({ trip_id: tripId! });
          if (error instanceof ActionError) {
            showToast({ message: error.message, type: 'error' });
          } else {
            showToast({ message: 'Canceled trip request successfully!', type: 'success' });
            setTimeout(() => window.location.reload(), 1500);
          }
        },
      });
    });
  }

  if (leaveTripBtn) {
    leaveTripBtn.addEventListener('click', async () => {
      createConfirmModal({
        message: 'Are you sure you want to leave this trip?',
        confirmText: 'Yes, leave trip',
        onConfirm: async () => {
          const { error } = await actions.trip.leaveTrip({ trip_id: tripId! });
          if (error instanceof ActionError) {
            showToast({ message: error.message, type: 'error' });
          } else {
            showToast({ message: 'Left trip successfully!', type: 'success' });
            setTimeout(() => (window.location.href = '/trips'), 1500);
          }
        },
      });
    });
  }
</script>