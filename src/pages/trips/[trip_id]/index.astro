---
import Layout from '@/layouts/PagePlate.astro';
import TripHeader from '@/components/Trip/TripHeader.astro';
import TripDetails from '@/components/Trip/Summary.astro';
import Member from '@/components/Trip/Member.astro';
import { supabaseAdmin } from '@/lib/supabase';
import Itinerary from '@/components/Trip/Itinerary/Itinerary.astro';
import Hero from '@/components/Trip/Hero.astro';
import TripOrganizer from '@/components/Trip/TripOrganizer.astro';
import { PUBLIC_R2_URL } from 'astro:env/client';
const slug = Astro.params.trip_id || '';
const user = Astro.locals.user_id;

// Pass share code so private trips grant access to users with a valid invite link
const shareCode = Astro.url.searchParams.get('invite');

// Build RPC args — only include p_share_code when present (old DB pre-047 has 2 params only)
const rpcArgs: Record<string, unknown> = {
  p_trip_id: slug,
  p_current_user_id: user ?? null,
};
if (shareCode) rpcArgs.p_share_code = shareCode;

// Get trip data
const { data: tripData, error } = await supabaseAdmin.rpc('get_trip_full_details', rpcArgs as any);

if (error || !tripData) {
  return Astro.redirect('/404');
}


const trip = tripData;

const {
  trip_id,
  title,
  description,
  status,
  user_role,
  trip_details,
  trip_locations,
  trip_members,
  trip_visibility,
  trip_images,
} = trip;

const isVisitor = user_role === 'visitor';
const isPublicTrip = trip_visibility?.visibility === 'public';

if (isVisitor && !isPublicTrip) {
  return Astro.redirect('/404');
}

const canShowItinerary = user_role === 'owner' || user_role === 'member' || trip_visibility?.itinerary_public;


// Get primary location (destination)
const primaryLocation = trip_locations?.find((loc: any) => loc.is_primary);
const destination = primaryLocation?.location?.name || primaryLocation?.location_name || 'No destination set';

// Load itinerary stops (exclude destination — shown in header)
// pickup and dropoff ARE included — they anchor the timeline with trip creation datetimes
const { data: itineraryStops } = await supabaseAdmin
  .from('trip_location')
  .select('*, location:locations(*), activities:stop_activities(*)')
  .eq('trip_id', trip_id)
  .not('location_type', 'in', '(destination)')
  .order('scheduled_start', { ascending: true, nullsFirst: false });

// Detect if the viewing user has a pending invitation — query trip_invitations directly
// (more reliable than checking trip_members which uses an INNER JOIN with public.users)
let pendingInvitationId: string | null = null;
if (user) {
  const { data: inv } = await supabaseAdmin
    .from('trip_invitations')
    .select('invitation_id')
    .eq('trip_id', trip_id)
    .eq('invitee_id', user)
    .eq('status', 'pending')
    .gt('expires_at', new Date().toISOString())
    .maybeSingle();
  pendingInvitationId = inv?.invitation_id || null;
}
const isInvited = !!pendingInvitationId;

// Get pending invitations (only for owner)
let pendingInvitationsList: any[] = [];
if (user && user_role === 'owner') {
  const { data: invData } = await supabaseAdmin.rpc('get_trip_pending_invitations', {
    p_trip_id: trip_id,
    p_user_id: user
  });
  pendingInvitationsList = invData || [];
}

// Fetch organizer profile details + trip stats
const ownerUserId = trip.owner?.user_id;
const ownerAuthId = trip.owner_id; // auth_id used in trips.owner_id
let organizerInfo: any = null;
let organizerPrefs: any = null;
let organizerStats = { total: 0, completed: 0 };
if (ownerUserId) {
  const [infoRes, prefsRes, tripsRes] = await Promise.all([
    supabaseAdmin
      .from('user_information')
      .select('location_country, location_city')
      .eq('user_id', ownerUserId)
      .maybeSingle(),
    supabaseAdmin
      .from('user_travel_preferences')
      .select('travel_style, languages_spoken')
      .eq('user_id', ownerUserId)
      .maybeSingle(),
    supabaseAdmin
      .from('trips')
      .select('status')
      .eq('owner_id', ownerAuthId),
  ]);
  organizerInfo = infoRes.data;
  organizerPrefs = prefsRes.data;
  const ownerTrips = tripsRes.data ?? [];
  organizerStats.total = ownerTrips.length;
  organizerStats.completed = ownerTrips.filter((t: any) => t.status === 'completed').length;
}

// Prepare props for components
const tripProps = {
  tripId: trip_id,
  title,
  description: trip_details?.description || description,
  tripStatus: status,
  userRole: user_role,
  visibility: trip_visibility?.visibility || 'private',
  
  // Trip Details
  destination,
  tripStart: trip_details?.start_date,
  tripEnd: trip_details?.end_date,
  joinedBy: trip_details?.join_by 
    ? `${trip_details.join_by}T${trip_details.join_by_time || '23:59:00'}`
    : null,
  
  // Members
  currentPax: trip_members?.filter((m: any) => m.member_status === 'joined').length || 0,
  maxPax: trip_details?.max_pax || 0,
  members: trip_members || [],
  
  // Pending join requests (for owner)
  pendingRequests: trip_members?.filter((m: any) => m.member_status === 'pending').map((m: any) => ({
    id: m.id,
    user_id: m.user_id,
    username: m.username,
    full_name: m.full_name,
    avatar_url: m.avatar_url,
    requested_at: m.joined_at,
  })) || [],
  
  // Pending invitations (for owner)
  pendingInvitations: pendingInvitationsList,
  
  // Preferences
  genderPref: trip_details?.gender_pref || 'any',
  costSharing: trip_details?.cost_sharing || 'split_evenly',
  estimatedBudget: trip_details?.estimated_budget,
  
  // Tags
  tags: trip_details?.tags || [],
  
  // Locations
  locations: trip_locations || [],

  // Invitation state
  isInvited,
  isVisitor,
};

// ─── SEO / Social preview ───────────────────────────────────────────────────
const coverImage = trip_images?.find((img: any) => img.is_cover) ?? trip_images?.[0];
const seoImage = coverImage?.image_url
  ? (coverImage.image_url.startsWith('http')
      ? coverImage.image_url
      : `${PUBLIC_R2_URL}${coverImage.image_url}`)
  : undefined;

const rawDesc = (trip_details?.description || description || '').trim();
const destinationSuffix = destination !== 'No destination set' ? ` · ${destination}` : '';
const seoDescription = (rawDesc + destinationSuffix).slice(0, 155) || `Plan a trip to ${destination} with Tara G!`;
const tripStartDate = trip_details?.start_date || null;
---

<Layout
  title={`${title} | Tara G`}
  description={{
    title: `${title} | Tara G`,
    containsArticle: true,
    description: seoDescription,
    previewImage: seoImage,
    author: trip.owner?.full_name || trip.owner?.username,
    authorIs: 'Person',
    datePublished: trip?.created_at,
    dateModified: trip?.updated_at,
    topics: tripProps.tags?.map((t: any) => t.tag_name),
    breadCrumb: [
      { name: 'Trips', url: '/trips' },
      { name: title, url: Astro.url.pathname },
    ],
  }}
>
  <section class="max-w-5xl mx-auto mt-6 px-4 space-y-5 md:mb-20 pb-24 md:pb-20">

    <!-- Invitation Banner (only shown to invited users) -->
    {isInvited && pendingInvitationId && (
      <div class="rounded-2xl border border-amber-200 bg-amber-50 px-6 py-5 flex flex-col sm:flex-row sm:items-center gap-4">
        <div class="flex items-center gap-3 flex-1 min-w-0">
          <div class="w-10 h-10 rounded-xl bg-amber-100 flex items-center justify-center shrink-0">
            <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
            </svg>
          </div>
          <div>
            <p class="text-sm font-semibold text-amber-900">You've been invited to join this trip!</p>
            <p class="text-xs text-amber-700 mt-0.5">Accept to become a member and access the full itinerary.</p>
          </div>
        </div>
        <div class="flex items-center gap-2 shrink-0">
          <button
            id="accept-invite-btn"
            data-invitation-id={pendingInvitationId}
            class="px-5 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold transition-all disabled:opacity-50"
          >
            Accept Invitation
          </button>
          <button
            id="decline-invite-btn"
            data-invitation-id={pendingInvitationId}
            class="px-5 py-2 rounded-lg bg-white hover:bg-gray-50 border border-gray-200 text-gray-700 text-sm font-semibold transition-all disabled:opacity-50"
          >
            Decline
          </button>
        </div>
      </div>
    )}

    <!-- Card 1: Hero image + Trip title/meta -->
    <div class="rounded-2xl overflow-hidden border border-gray-200 shadow-sm bg-white">
      <Hero server:defer userRole={trip.user_role} trip_images={trip_images} />
      <TripHeader {...tripProps} />
    </div>

    <!-- Card 2: Trip details (destination, dates, members, preferences, budget, description) -->
    <div class="rounded-2xl overflow-hidden border border-gray-100 shadow-sm bg-white">
      <TripDetails {...tripProps} isVisitor={isVisitor} />
    </div>

    <!-- Organizer card -->
    {trip.owner && (
      <TripOrganizer
        owner={trip.owner}
        info={organizerInfo}
        prefs={organizerPrefs}
        stats={organizerStats}
      />
    )}

    {(user_role === 'owner' || user_role === 'member') && <Member tripId={trip_id} />}
    
    {isVisitor && isPublicTrip && (
      <div class="rounded-2xl border border-gray-200 shadow-sm bg-white p-6 text-center">
        <p class="text-gray-600 mb-4">Join this trip to see the full itinerary and connect with travelers!</p>
        <a
          href={`/signin?redirect=${Astro.url.pathname}`}
          class="inline-flex items-center gap-2 px-6 py-3 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-semibold transition-all"
        >
          Sign in to Join
        </a>
      </div>
    )}
    
    {canShowItinerary && (
      <Itinerary
        initialData={itineraryStops || []}
        isOwner={trip.user_role === 'owner'}
        tripId={trip.trip_id}
        destination={destination}
        itineraryPublic={trip_visibility?.itinerary_public ?? false}
      />
    )}

  </section>
</Layout>

<script>
  import { showToast } from '@/scripts/Toast';
  import { actions, ActionError } from 'astro:actions';
  import { createConfirmModal } from '@/scripts/Modal';
  import { setPendingTripShare, getPendingTripShare, clearPendingTripShare } from '@/lib/tripShare';

  const joinBtns = document.querySelectorAll('.join-btn') as NodeListOf<HTMLButtonElement>;
  const cancelRequestBtns = document.querySelectorAll('.cancel-req-btn') as NodeListOf<HTMLButtonElement>;
  const leaveTripBtns = document.querySelectorAll('.leave-trip-btn') as NodeListOf<HTMLButtonElement>;
  const deleteTripBtns = document.querySelectorAll('.delete-trip-btn') as NodeListOf<HTMLButtonElement>;
  const acceptInviteBtn = document.getElementById('accept-invite-btn') as HTMLButtonElement | null;
  const declineInviteBtn = document.getElementById('decline-invite-btn') as HTMLButtonElement | null;

  const tripId = window.location.pathname.split('/').pop();

  // Store trip share data if invite param exists
  const urlParams = new URLSearchParams(window.location.search);
  const inviteCode = urlParams.get('invite');
  if (inviteCode && tripId) {
    // We'll store just the tripId here, the invite code validation happens server-side
    // Actually, we need to look up the invitation_id from the share_code
    // For now, store the code and we'll resolve it on join
    setPendingTripShare(tripId, inviteCode);
  }

  // Get pending trip share for join action
  const pendingTrip = getPendingTripShare();
  const pendingShareCode = pendingTrip?.shareCode;

  // Join button handler - works for both desktop and mobile
  joinBtns.forEach(joinBtn => {
    joinBtn.addEventListener('click', async () => {
      createConfirmModal({
        message: 'Are you sure you want to join this trip?',
        confirmText: 'Join',
        onConfirm: async () => {
          const joinData: { trip_id: string; share_code?: string } = { trip_id: tripId! };
          
          // Pass share_code if available from pending trip
          if (pendingShareCode) {
            joinData.share_code = pendingShareCode;
          }
          
          const { error } = await actions.trip.joinTrip(joinData);
          
          if (error instanceof ActionError) {
            // Check if not authenticated error
            if (error.message?.includes('must be logged in') || error.message?.includes('unauthorized') || error.code === 'UNAUTHORIZED') {
              // Redirect to sign in, preserving the share code
              window.location.href = '/signin';
              return;
            }
            showToast({ message: error.message, type: 'error' });
          } else {
            showToast({ message: 'Joined trip successfully!', type: 'success' });
            clearPendingTripShare();
            setTimeout(() => window.location.reload(), 1500);
          }
        },
      });
    });
  });

  // Cancel request button handler
  cancelRequestBtns.forEach(cancelRequestBtn => {
    cancelRequestBtn.addEventListener('click', async () => {
      createConfirmModal({
        message: 'Are you sure you want to cancel your request to join this trip?',
        confirmText: 'Yes, cancel request',
        onConfirm: async () => {
          const { error } = await actions.trip.cancelJoinRequest({ trip_id: tripId! });
          if (error instanceof ActionError) {
            showToast({ message: error.message, type: 'error' });
          } else {
            showToast({ message: 'Request cancelled.', type: 'info' });
            setTimeout(() => window.location.reload(), 1200);
          }
        },
      });
    });
  });

  // Leave trip button handler
  leaveTripBtns.forEach(leaveTripBtn => {
    leaveTripBtn.addEventListener('click', async () => {
      createConfirmModal({
        message: 'Are you sure you want to leave this trip?',
        confirmText: 'Yes, leave trip',
        onConfirm: async () => {
          const { error } = await actions.trip.leaveTrip({ trip_id: tripId! });
          if (error instanceof ActionError) {
            showToast({ message: error.message, type: 'error' });
          } else {
            showToast({ message: 'Left trip successfully!', type: 'success' });
            setTimeout(() => (window.location.href = '/trips'), 1500);
          }
        },
      });
    });
  });

  // Delete trip button handler
  deleteTripBtns.forEach(deleteTripBtn => {
    deleteTripBtn.addEventListener('click', async () => {
      (createConfirmModal as any)({
        message: 'Are you sure you want to delete this trip? This action cannot be undone.',
        confirmText: 'Yes, delete trip',
        confirmClass: 'bg-red-600 hover:bg-red-700 text-white',
        onConfirm: async () => {
          const { error } = await (actions.trip as any).deleteTrip({ trip_id: tripId! });
          if (error instanceof ActionError) {
            showToast({ message: error.message, type: 'error' });
          } else {
            showToast({ message: 'Trip deleted successfully!', type: 'success' });
            setTimeout(() => (window.location.href = '/trips'), 1500);
          }
        },
      });
    });
  });

  // Accept/decline invitation handlers
  if (acceptInviteBtn) {
    acceptInviteBtn.addEventListener('click', async () => {
      const invitationId = acceptInviteBtn.dataset.invitationId!;
      acceptInviteBtn.disabled = true;
      acceptInviteBtn.textContent = 'Accepting...';
      if (declineInviteBtn) declineInviteBtn.disabled = true;

      const { error } = await actions.trip.acceptTripInvitation({ invitationId });
      if (error instanceof ActionError) {
        showToast({ message: error.message, type: 'error' });
        acceptInviteBtn.disabled = false;
        acceptInviteBtn.textContent = 'Accept Invitation';
        if (declineInviteBtn) declineInviteBtn.disabled = false;
      } else {
        showToast({ message: 'Invitation accepted! Welcome to the trip.', type: 'success' });
        setTimeout(() => window.location.reload(), 1200);
      }
    });
  }

  if (declineInviteBtn) {
    declineInviteBtn.addEventListener('click', async () => {
      const invitationId = declineInviteBtn.dataset.invitationId!;
      declineInviteBtn.disabled = true;
      declineInviteBtn.textContent = 'Declining...';
      if (acceptInviteBtn) acceptInviteBtn.disabled = true;

      const { error } = await actions.trip.declineTripInvitation({ invitationId });
      if (error instanceof ActionError) {
        showToast({ message: error.message, type: 'error' });
        declineInviteBtn.disabled = false;
        declineInviteBtn.textContent = 'Decline';
        if (acceptInviteBtn) acceptInviteBtn.disabled = false;
      } else {
        showToast({ message: 'Invitation declined.', type: 'info' });
        setTimeout(() => window.location.href = '/trips', 1200);
      }
    });
  }
</script>