---
import Layout from '@/layouts/PagePlate.astro';
import TripHeader from '@/components/Trip/TripHeader.astro';
import TripDetails from '@/components/Trip/Summary.astro';
import Member from '@/components/Trip/Member.astro';
import { supabaseAdmin } from '@/lib/supabase';
import Itinerary from '@/components/Trip/Itinerary/Itinerary.astro';
import Hero from '@/components/Trip/Hero.astro';

const slug = Astro.params.trip_id || '';
const user = Astro.locals.user_id;

// Get trip data
const { data: tripData, error } = await supabaseAdmin.rpc('get_trip_full_details', {
  p_trip_id: slug,
  p_current_user_id: user
});

if (error || !tripData) {
  return Astro.redirect('/404');
}


const trip = tripData;

const {
  trip_id,
  title,
  description,
  status,
  user_role,
  trip_details,
  trip_locations,
  trip_members,
  trip_visibility,
  trip_images,
} = trip;

// Get primary location (destination)
const primaryLocation = trip_locations?.find((loc: any) => loc.is_primary);
const destination = primaryLocation?.location?.name || primaryLocation?.location_name || 'No destination set';

// Load itinerary stops (exclude destination — shown in header)
// pickup and dropoff ARE included — they anchor the timeline with trip creation datetimes
const { data: itineraryStops } = await supabaseAdmin
  .from('trip_location')
  .select('*, location:locations(*), activities:stop_activities(*)')
  .eq('trip_id', trip_id)
  .not('location_type', 'in', '(destination)')
  .order('scheduled_start', { ascending: true, nullsFirst: false });

// Prepare props for components
const tripProps = {
  tripId: trip_id,
  title,
  description: trip_details?.description || description,
  tripStatus: status,
  userRole: user_role,
  visibility: trip_visibility?.visibility || 'private',
  
  // Trip Details
  destination,
  tripStart: trip_details?.start_date,
  tripEnd: trip_details?.end_date,
  joinedBy: trip_details?.join_by 
    ? `${trip_details.join_by}T${trip_details.join_by_time || '23:59:00'}`
    : null,
  
  // Members
  currentPax: trip_members?.length || 0,
  maxPax: trip_details?.max_pax || 0,
  members: trip_members || [],
  
  // Preferences
  genderPref: trip_details?.gender_pref || 'any',
  costSharing: trip_details?.cost_sharing || 'split_evenly',
  estimatedBudget: trip_details?.estimated_budget,
  
  // Tags
  tags: trip_details?.tags || [],
  
  // Locations
  locations: trip_locations || []
};

console.log(itineraryStops);
---

<Layout title={`${title} | Tara G`}>
  <section class="max-w-5xl mx-auto mt-6 mb-20 px-4 space-y-5">

    <!-- Card 1: Hero image + Trip title/meta -->
    <div class="rounded-2xl overflow-hidden border border-gray-200 shadow-sm bg-white">
      <Hero server:defer userRole={trip.user_role} trip_images={trip_images} />
      <TripHeader {...tripProps} />
    </div>

    <!-- Card 2: Trip details (destination, dates, members, preferences, budget, description) -->
    <div class="rounded-2xl overflow-hidden border border-gray-100 shadow-sm bg-white">
      <TripDetails {...tripProps} />
    </div>

    <Member tripId={trip_id} />
    <Itinerary
      initialData={itineraryStops || []}
      isOwner={trip.user_role === 'owner'}
      tripId={trip.trip_id}
      destination={destination}
    />

  </section>
</Layout>

<script>
  import { showToast } from '@/scripts/Toast';
  import { actions, ActionError } from 'astro:actions';
  import { createConfirmModal } from '@/scripts/Modal';

  const joinBtn = document.getElementById('join-btn') as HTMLButtonElement;
  const cancelRequestBtn = document.getElementById('cancel-req-btn') as HTMLButtonElement;
  const leaveTripBtn = document.getElementById('leave-trip-btn') as HTMLButtonElement;
  
  const tripId = window.location.pathname.split('/').pop();

  if (joinBtn) {
    joinBtn.addEventListener('click', async () => {
      createConfirmModal({
        message: 'Are you sure you want to join this trip?',
        confirmText: 'Join',
        onConfirm: async () => {
          const { error } = await actions.trip.joinTrip({ trip_id: tripId! });
          if (error instanceof ActionError) {
            showToast({ message: error.message, type: 'error' });
          } else {
            showToast({ message: 'Joined trip successfully!', type: 'success' });
            setTimeout(() => window.location.reload(), 1500);
          }
        },
      });
    });
  }

  if (cancelRequestBtn) {
    cancelRequestBtn.addEventListener('click', async () => {
      createConfirmModal({
        message: 'Are you sure you want to cancel your request to join this trip?',
        confirmText: 'Yes, cancel request',
        onConfirm: async () => {
          const { error } = await actions.trip.cancelJoinRequest({ trip_id: tripId! });
          if (error instanceof ActionError) {
            showToast({ message: error.message, type: 'error' });
          } else {
            showToast({ message: 'Canceled trip request successfully!', type: 'success' });
            setTimeout(() => window.location.reload(), 1500);
          }
        },
      });
    });
  }

  if (leaveTripBtn) {
    leaveTripBtn.addEventListener('click', async () => {
      createConfirmModal({
        message: 'Are you sure you want to leave this trip?',
        confirmText: 'Yes, leave trip',
        onConfirm: async () => {
          const { error } = await actions.trip.leaveTrip({ trip_id: tripId! });
          if (error instanceof ActionError) {
            showToast({ message: error.message, type: 'error' });
          } else {
            showToast({ message: 'Left trip successfully!', type: 'success' });
            setTimeout(() => (window.location.href = '/trips'), 1500);
          }
        },
      });
    });
  }
</script>