---
import Layout from "@/layouts/PagePlate.astro";
import DatePicker from "@/components/DatePicker.astro";
import MapPickerModal from "@/components/MapPickerModal.astro";
import { Plane, CalendarDays, MapPin, Users, Clock, DollarSign, AlertCircle, Info, CheckCircle } from "@lucide/astro";
import Tags from "@/components/Trip/Tags.astro";
---

<Layout title="Create Trip | Tara G">
  <section class="max-w-3xl mx-auto py-10 px-4 sm:px-8">
    <!-- HEADER -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold mb-2 bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">Plan Your Adventure</h1>
      <p class="text-slate-600">Create an unforgettable journey in just a few steps</p>
    </div>

    <!-- STEP PROGRESS BAR -->
    <div class="relative mb-10 mt-4">
      <div class="h-1 bg-slate-200 rounded-full"></div>
      <div id="progressBar" class="absolute top-0 h-1 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full transition-all duration-500 ease-out w-[20%]"></div>
      <div class="flex justify-between text-xs mt-2 font-medium">
        <span data-step="1" class="step-label text-blue-600 transition-all duration-300">Schedule</span>
        <span data-step="2" class="step-label text-slate-400 transition-all duration-300">Details</span>
        <span data-step="3" class="step-label text-slate-400 transition-all duration-300">Budget</span>
        <span data-step="4" class="step-label text-slate-400 transition-all duration-300">Logistics</span>
        <span data-step="5" class="step-label text-slate-400 transition-all duration-300">Confirm</span>
      </div>
    </div>

    <!-- FORM CARD -->
    <form id="tripStepperForm" novalidate class="backdrop-blur-md bg-white/70 border border-white/60 shadow-xl rounded-2xl p-6 space-y-6 transition-all duration-300">

      <!-- STEP 1: SCHEDULE -->
      <div class="step transition-opacity duration-300" data-step="1">
        <div class="flex items-center gap-2 mb-6">
          <div class="p-2 bg-blue-50 rounded-lg">
            <CalendarDays class="w-5 h-5 text-blue-500" />
          </div>
          <h2 class="font-semibold text-lg">When & Where</h2>
        </div>

        <div class="space-y-5">
          <!-- Trip Date Range -->
          <DatePicker
            label="Trip Dates"
            nameFrom="start_date"
            nameTo="end_date"
            required={true}
            helperText="When does your adventure begin and end?"
            id="tripDates"
          />

          <!-- Destination -->
          <div>
            <label class="font-medium mb-2 block text-slate-700">
              Destination
              <span class="text-red-500 ml-1">*</span>
            </label>
            <div class="flex gap-2">
              <div class="relative group flex-1">
                <MapPin class="absolute left-3 top-3 w-4 h-4 text-blue-500 group-focus-within:text-purple-500 transition-colors" />
                <input 
                  type="text" 
                  name="region_address"
                  class="border border-gray-300 rounded-lg w-full pl-10 pr-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" 
                  id="regionInput"
                  placeholder="Where are you headed?"
                  required
                />
                <input type="hidden" name="region_coordinates" id="regionCoordinates" />
              </div>
              <button 
                type="button"
                id="region-pick-map-btn"
                class="px-4 py-2.5 border border-gray-300 rounded-lg bg-white hover:bg-gray-50 transition-colors flex items-center gap-2 whitespace-nowrap"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                </svg>
                <span class="hidden sm:inline">Pick on Map</span>
              </button>
            </div>
          </div>

          <!-- Join Deadline with Time -->
          <DatePicker
            label="Join Deadline"
            name="joined_by"
            id="joinedBy"
            mode="single"
            enableTime={true}
            defaultTime="23:59"
            required={true}
            helperText="Last moment for participants to join (allows last-minute joiners!)"
          />
        </div>
      </div>

      <!-- STEP 2: DETAILS -->
      <div class="step hidden transition-opacity duration-300" data-step="2">
        <div class="flex items-center gap-2 mb-6">
          <div class="p-2 bg-blue-50 rounded-lg">
            <Plane class="w-5 h-5 text-blue-500" />
          </div>
          <h2 class="font-semibold text-lg">Trip Details</h2>
        </div>

        <div class="space-y-4">
          <div>
            <label class="font-medium mb-2 block text-slate-700" for="title">
              Trip Title
              <span class="text-red-500 ml-1">*</span>
            </label>
            <input 
              type="text" 
              name="title" 
              id="tripTitle"
              class="border border-gray-300 rounded-lg w-full px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" 
              placeholder="e.g. Siargao Surf Trip 2025"
              required
              maxlength="100"
            />
            <div class="text-xs text-slate-500 mt-1 text-right">
              <span id="titleCount">0</span>/100
            </div>
          </div>

          <div>
            <label class="font-medium mb-2 block text-slate-700" for="description">
              About the Trip
              <span class="text-red-500 ml-1">*</span>
            </label>
            <textarea 
              name="description" 
              id="tripDescription"
              class="border border-gray-300 rounded-lg w-full px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" 
              rows="4" 
              placeholder="What's the vibe? What are you hoping to explore?"
              required
              maxlength="500"
            ></textarea>
            <div class="text-xs text-slate-500 mt-1 text-right">
              <span id="descCount">0</span>/500
            </div>
          </div>

          <Tags />
        </div>
      </div>

      <!-- STEP 3: BUDGET & RULES -->
      <div class="step hidden transition-opacity duration-300" data-step="3">
        <div class="flex items-center gap-2 mb-6">
          <div class="p-2 bg-blue-50 rounded-lg">
            <Users class="w-5 h-5 text-blue-500" />
          </div>
          <h2 class="font-semibold text-lg">Budget & Participants</h2>
        </div>

        <div class="space-y-4">
          <!-- Cost Sharing Method -->
          <div>
            <label class="font-medium mb-2 block text-slate-700">
              Cost Sharing Method
              <span class="text-red-500 ml-1">*</span>
            </label>
            <select 
              name="cost_sharing" 
              id="costSharing"
              class="border border-gray-300 rounded-lg w-full px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
              required
            >
              <option value="">Select cost sharing method</option>
              <option value="split_evenly">Split Evenly</option>
              <option value="organizer_shoulders_cost">Organizer Shoulders All Costs</option>
              <option value="pay_own_expenses">Everyone Pays Own Expenses</option>
              <option value="custom_split">Custom Split (decide later)</option>
            </select>
            <p class="text-xs text-slate-500 mt-1" id="costSharingHelper">Choose how expenses will be handled</p>
          </div>

          <!-- Dynamic Budget Field -->
          <div id="budgetWrapper" class="hidden">
            <label for="estimated_budget" class="font-medium mb-2 block text-slate-700">
              <span id="budgetLabel">Estimated Budget</span>
              <span class="text-xs text-slate-500 ml-1" id="budgetContext">(recommended)</span>
            </label>
            <div class="relative">
              <DollarSign class="absolute left-3 top-3 w-4 h-4 text-blue-500" />
              <input 
                type="number" 
                name="estimated_budget" 
                id="estimatedBudget"
                class="border border-gray-300 rounded-lg w-full pl-10 pr-4 py-2.5 transition-all"
                placeholder="e.g. 5000"
                min="0"
                step="100"
              />
            </div>
            <p class="text-xs text-slate-500 mt-1" id="budgetHelper">This helps participants prepare financially</p>
          </div>

          <!-- Gender Preference -->
          <div>
            <label class="font-medium mb-2 block text-slate-700">
              Gender Preference
              <span class="text-red-500 ml-1">*</span>
            </label>
            <select 
              name="gender_preference" 
              id="genderPreference"
              class="border border-gray-300 rounded-lg w-full px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
              required
            >
              <option value="">Select gender preference</option>
              <option value="any">Any</option>
              <option value="male">Male Only</option>
              <option value="female">Female Only</option>
            </select>
          </div>

          <!-- Maximum Participants -->
          <div>
            <label for="max_pax" class="font-medium mb-2 block text-slate-700">
              Maximum Participants
              <span class="text-red-500 ml-1">*</span>
            </label>
            <input 
              type="number" 
              name="max_pax" 
              id="maxPax"
              class="border border-gray-300 rounded-lg w-full px-4 py-2.5  transition-all" 
              min="2"
              max="50"
              placeholder="e.g. 8"
              required
            />
            <p class="text-xs text-slate-500 mt-1">Minimum 2, maximum 50 participants</p>
          </div>
        </div>
      </div>

      <!-- STEP 4: LOGISTICS -->
      <div class="step hidden transition-opacity duration-300" data-step="4">
        <div class="flex items-center gap-2 mb-6">
          <div class="p-2 bg-blue-50 rounded-lg">
            <MapPin class="w-5 h-5 text-blue-500" />
          </div>
          <h2 class="font-semibold text-lg">Meetup & Transport</h2>
        </div>

        <div class="space-y-5">
          <!-- Meeting Time -->
          <DatePicker
            label="Meeting Date & Time"
            name="pickup_dates"
            id="pickupDates"
            mode="single"
            enableTime={true}
            defaultTime="06:00"
            required={true}
            helperText="When should everyone gather?"
          />

          <!-- Pickup Point -->
          <div>
            <label class="font-medium mb-2 block text-slate-700">
              Pickup Point
              <span class="text-red-500 ml-1">*</span>
            </label>
            <div class="flex gap-2">
              <div class="relative flex-1">
                <MapPin class="absolute left-3 top-3 w-4 h-4 text-green-500" />
                <input 
                  type="text"
                  name="pickup_address"
                  class="border border-gray-300 rounded-lg w-full pl-10 pr-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" 
                  id="pickupInput" 
                  placeholder="e.g. MOA Globe, Ayala Cebu Terminal"
                  required
                />
                <input type="hidden" name="pickup_coordinates" id="pickupCoordinates" />
              </div>
              <button 
                type="button"
                id="pickup-pick-map-btn"
                class="px-4 py-2.5 border border-gray-300 rounded-lg bg-white hover:bg-gray-50 transition-colors flex items-center gap-2 whitespace-nowrap"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                </svg>
                <span class="hidden sm:inline">Pick on Map</span>
              </button>
            </div>
          </div>

          <!-- Waiting Time / Grace Period -->
          <div>
            <label class="font-medium mb-2 block text-slate-700">Grace Period (minutes)</label>
            <div class="relative">
              <Clock class="absolute left-3 top-3 w-4 h-4 text-blue-500" />
              <input 
                type="number" 
                name="waiting_time" 
                id="waitingTime"
                min="0"
                max="60"
                placeholder="e.g. 15" 
                class="border border-gray-300 rounded-lg w-full pl-10 pr-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                value="15"
              />
            </div>
            <p class="text-xs text-slate-500 mt-1">How long will you wait for late participants?</p>
          </div>

          <!-- Same Location Checkbox -->
          <div class="flex items-start gap-3 p-4 bg-blue-50 rounded-lg border border-blue-100">
            <input 
              type="checkbox" 
              id="sameLocation" 
              class="mt-0.5 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
            />
            <label for="sameLocation" class="text-sm text-slate-700 cursor-pointer">
              <span class="font-medium">Drop-off at same location as pickup</span>
              <p class="text-xs text-slate-600 mt-1">Uncheck if the trip ends at a different location</p>
            </label>
          </div>

          <!-- Drop-off Location (conditional ‚Äî hidden when same location as pickup) -->
          <div id="dropoffWrapper" class="hidden border-t border-slate-200 pt-4">
            <h3 class="font-medium text-slate-700 mb-4 flex items-center gap-2">
              <MapPin class="w-4 h-4 text-red-500" />
              Drop-off Location
            </h3>
            <div class="mb-4">
              <label class="font-medium mb-2 block text-slate-700">
                Drop-off Point
                <span class="text-red-500 ml-1">*</span>
              </label>
              <div class="flex gap-2">
                <div class="relative flex-1">
                  <MapPin class="absolute left-3 top-3 w-4 h-4 text-red-500" />
                  <input
                    type="text"
                    name="dropoff_address"
                    class="border border-gray-300 rounded-lg w-full pl-10 pr-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                    id="dropoffInput"
                    placeholder="Where will the trip end?"
                  />
                  <input type="hidden" name="dropoff_coordinates" id="dropoffCoordinates" />
                </div>
                <button
                  type="button"
                  id="dropoff-pick-map-btn"
                  class="px-4 py-2.5 border border-gray-300 rounded-lg bg-white hover:bg-gray-50 transition-colors flex items-center gap-2 whitespace-nowrap"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                  </svg>
                  <span class="hidden sm:inline">Pick on Map</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Drop-off Date & Time (always required) -->
          <div class="border-t border-slate-200 pt-4">
            <DatePicker
              label="Drop-off Date & Time (Estimated)"
              name="dropoff_dates"
              id="dropoffDates"
              mode="single"
              enableTime={true}
              defaultTime="18:00"
              helperText="When do you expect to arrive at the drop-off point?"
            />
          </div>

          <!-- Info Box -->
          <div class="flex items-start gap-3 p-4 bg-amber-50 rounded-lg border border-amber-100">
            <Info class="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5" />
            <div class="text-sm text-amber-900">
              <p class="font-medium mb-1">Additional Stops & Itinerary</p>
              <p class="text-xs text-amber-800">After creating your trip, you can add more pickup/drop-off points and finalize your complete itinerary in the trip dashboard.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- STEP 5: CONFIRM -->
      <div class="step hidden transition-opacity duration-300" data-step="5">
        <div class="flex items-center gap-2 mb-6">
          <div class="p-2 bg-green-50 rounded-lg">
            <CheckCircle class="w-5 h-5 text-green-500" />
          </div>
          <h2 class="font-semibold text-lg">Confirm Your Trip</h2>
        </div>

        <div class="space-y-6">
          <!-- Trip Summary -->
          <div class="bg-gray-50 rounded-xl p-5 space-y-4">
            <h3 class="font-semibold text-gray-900">Trip Overview</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
              <div>
                <p class="text-gray-500">Trip Title</p>
                <p id="confirm-title" class="font-medium text-gray-900">-</p>
              </div>
              <div>
                <p class="text-gray-500">Dates</p>
                <p id="confirm-dates" class="font-medium text-gray-900">-</p>
              </div>
              <div>
                <p class="text-gray-500">Destination</p>
                <p id="confirm-destination" class="font-medium text-gray-900">-</p>
              </div>
              <div>
                <p class="text-gray-500">Max Participants</p>
                <p id="confirm-pax" class="font-medium text-gray-900">-</p>
              </div>
              <div>
                <p class="text-gray-500">Budget</p>
                <p id="confirm-budget" class="font-medium text-gray-900">-</p>
              </div>
              <div>
                <p class="text-gray-500">Cost Sharing</p>
                <p id="confirm-costsharing" class="font-medium text-gray-900">-</p>
              </div>
            </div>
          </div>

          <!-- Map Preview -->
          <div class="bg-gray-50 rounded-xl p-5">
            <h3 class="font-semibold text-gray-900 mb-4">Location Preview</h3>
            <div id="confirm-map" class="w-full h-64 rounded-lg overflow-hidden bg-gray-200">
              <div class="w-full h-full flex items-center justify-center text-gray-500">
                <div class="text-center">
                  <MapPin class="w-8 h-8 mx-auto mb-2" />
                  <p class="text-sm">Map will appear here</p>
                </div>
              </div>
            </div>
            <div class="mt-3 grid grid-cols-3 gap-2 text-xs">
              <div class="flex items-center gap-1">
                <span class="w-3 h-3 rounded-full bg-red-500"></span>
                <span class="text-gray-600">Destination</span>
              </div>
              <div class="flex items-center gap-1">
                <span class="w-3 h-3 rounded-full bg-green-500"></span>
                <span class="text-gray-600">Pickup</span>
              </div>
              <div class="flex items-center gap-1">
                <span class="w-3 h-3 rounded-full bg-blue-500"></span>
                <span class="text-gray-600">Dropoff</span>
              </div>
            </div>
          </div>

          <!-- Quick Edit Links -->
          <div class="flex flex-wrap gap-2">
            <button type="button" class="text-sm text-blue-600 hover:underline" data-goto-step="1">
              Edit Schedule
            </button>
            <span class="text-gray-300">|</span>
            <button type="button" class="text-sm text-blue-600 hover:underline" data-goto-step="2">
              Edit Details
            </button>
            <span class="text-gray-300">|</span>
            <button type="button" class="text-sm text-blue-600 hover:underline" data-goto-step="3">
              Edit Budget
            </button>
            <span class="text-gray-300">|</span>
            <button type="button" class="text-sm text-blue-600 hover:underline" data-goto-step="4">
              Edit Logistics
            </button>
          </div>
        </div>
      </div>

      <!-- CONTROLS -->
      <div class="flex justify-between pt-6 border-t border-slate-200">
        <button 
          type="button" 
          id="stepPrev" 
          class="px-6 py-2.5 rounded-lg font-medium text-slate-600 hover:bg-slate-100 transition-all duration-200 hidden"
        >
          ‚Üê Back
        </button>
        <button 
          type="button" 
          id="stepNext" 
          class="px-6 py-2.5 rounded-lg font-medium bg-gradient-to-r from-blue-500 to-purple-500 text-white hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-200 ml-auto"
        >
          Next ‚Üí
        </button>
        <button 
          type="submit" 
          id="stepSubmit" 
          class="px-6 py-2.5 rounded-lg font-medium bg-gradient-to-r from-green-500 to-emerald-500 text-white hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-200 ml-auto hidden"
        >
          Create Trip ‚ú®
        </button>
      </div>
    </form>

    <!-- Map Picker Modals -->
    <MapPickerModal fieldId="region" fieldLabel="Destination" />
    <MapPickerModal fieldId="pickup" fieldLabel="Pickup Point" />
    <MapPickerModal fieldId="dropoff" fieldLabel="Drop-off Point" />

    <!-- Tips Section -->
    <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-100">
      <h3 class="font-semibold text-sm text-blue-900 mb-2">üí° Pro Tips</h3>
      <ul class="text-xs text-blue-800 space-y-1">
        <li>‚Ä¢ Join deadline includes time - perfect for last-minute joiners!</li>
        <li>‚Ä¢ Budget field changes based on your cost sharing method</li>
        <li>‚Ä¢ Set join deadline a few hours before meeting time for better planning</li>
        <li>‚Ä¢ You can add more stops and finalize itinerary after creating the trip</li>
        <li>‚Ä¢ A 15-minute grace period is usually ideal</li>
      </ul>
    </div>

  </section>

  <!-- CONSOLIDATED SCRIPT - ALL LOGIC IN ONE PLACE -->
  <script>
    import { createMapboxSearchBox } from "../../scripts/mapBoxSearch.js";
    import { actions } from "astro:actions";
    import type { TripFormData } from "@/types/trip";
    import { slugify } from "@/scripts/Slugify";
    import { showToast } from "@/scripts/Toast";
    import { showLoading, hideLoading } from "@/lib/loading";

    // ==================== GLOBAL STATE ====================
    let currentStep = 1;
    const totalSteps = 5;

    // ==================== DOM ELEMENTS ====================
    const steps = document.querySelectorAll(".step");
    const progressBar = document.getElementById("progressBar");
    const labels = document.querySelectorAll(".step-label");
    const nextBtn = document.getElementById("stepNext");
    const prevBtn = document.getElementById("stepPrev");
    const submitBtn = document.getElementById("stepSubmit");
    const form = document.getElementById("tripStepperForm") as HTMLFormElement;

    // Character counters
    const titleInput = document.getElementById("tripTitle") as HTMLInputElement;
    const descInput = document.getElementById("tripDescription") as HTMLTextAreaElement;
    const titleCount = document.getElementById("titleCount");
    const descCount = document.getElementById("descCount");

    // Cost Sharing Elements
    const costSharing = document.getElementById("costSharing") as any;
    const budgetWrapper = document.getElementById("budgetWrapper");
    const budgetLabel = document.getElementById("budgetLabel");
    const budgetContext = document.getElementById("budgetContext");
    const budgetHelper = document.getElementById("budgetHelper");
    const estimatedBudget = document.getElementById("estimatedBudget") as HTMLInputElement;
    const costSharingHelper = document.getElementById("costSharingHelper");

    // Same Location Elements
    const sameLocationCheckbox = document.getElementById("sameLocation") as HTMLInputElement;
    const dropoffWrapper = document.getElementById("dropoffWrapper");
    const dropoffInput = document.getElementById("dropoffInput") as HTMLInputElement;

    // ==================== UTILITY FUNCTIONS ====================
    
    /**
     * Parse date string as local time (not UTC)
     * This ensures dates like "2025-02-20 23:59" are interpreted in local timezone
     */
    function parseLocalDate(dateStr: string): Date | null {
      if (!dateStr) return null;
      
      // Handle both date-only and datetime formats
      const [datePart, timePart] = dateStr.split(' ');
      const [year, month, day] = datePart.split('-').map(Number);
      
      let hour = 0, minute = 0;
      if (timePart) {
        [hour, minute] = timePart.split(':').map(Number);
      }
      
      // Create date in local timezone
      return new Date(year, month - 1, day, hour, minute);
    }

    /**
     * Get date/time value from various input types
     * Handles both single date pickers and date ranges
     */
    function getDateTimeValue(id: string) {
      if (id === 'tripDates') {
        // For range picker - try multiple possible input name patterns
        const fromInput = document.querySelector(`input[name="start_date"]`) as HTMLInputElement;
        const toInput = document.querySelector(`input[name="end_date"]`) as HTMLInputElement;
        
        if (!fromInput || !toInput) {
          console.warn(`Date range inputs not found for ${id}`);
          return { start: null, end: null };
        }
        
        return {
          start: fromInput.value || null,
          end: toInput.value || null
        };
      } else {
        // For single date pickers - try the actual input name first
        const directInput = document.querySelector(`input[name="${id.replace(/([A-Z])/g, '_$1').toLowerCase()}"]`) as HTMLInputElement;
        if (directInput?.value) {
          return directInput.value;
        }
        
        // Fallback to looking for hidden input
        const hiddenInput = document.getElementById(`${id}-hidden`) as HTMLInputElement;
        if (hiddenInput?.value) {
          return hiddenInput.value;
        }
        
        // Last resort - try the display input
        const displayInput = document.getElementById(id) as HTMLInputElement;
        if (displayInput?.value) {
          return displayInput.value;
        }
        
        console.warn(`No value found for date picker: ${id}`);
        return null;
      }
    }

    /**
     * Show error message for date/time picker
     */
    function showDateTimeError(id: string, message: string) {
      const errorDiv = document.querySelector(`[data-error="${id}"]`);
      const errorText = document.querySelector(`[data-error-text="${id}"]`);
      const pickerInput = document.getElementById(id);
      
      if (errorDiv && errorText) {
        errorText.textContent = message;
        errorDiv.classList.remove('hidden');
      }
      
      if (pickerInput) {
        pickerInput.classList.add('border-red-300');
      }
    }

    /**
     * Hide error message for date/time picker
     */
    function hideDateTimeError(id: string) {
      const errorDiv = document.querySelector(`[data-error="${id}"]`);
      const pickerInput = document.getElementById(id);
      
      if (errorDiv) {
        errorDiv.classList.add('hidden');
      }
      
      if (pickerInput) {
        pickerInput.classList.remove('border-red-300');
      }
    }

    // ==================== VALIDATION FUNCTIONS ====================

    /**
     * Validate trip dates and join deadline
     */
    function validateDates(): boolean {
      const tripDates = getDateTimeValue('tripDates') as any;
      const joinedByDateTime = getDateTimeValue('joinedBy') as any;
      
      let isValid = true;
      const now = new Date();
      
      // Clear previous errors
      hideDateTimeError('tripDates');
      hideDateTimeError('joinedBy');
      
      // If fields are empty, let HTML5 validation handle it
      if (!tripDates.start || !tripDates.end || !joinedByDateTime) {
        return true;
      }
      
      // Parse as local time to avoid UTC conversion issues
      const start = parseLocalDate(tripDates.start);
      const end = parseLocalDate(tripDates.end);
      const joinBy = parseLocalDate(joinedByDateTime);
      
      if (!start || !end || !joinBy) return true;
      
      // Trip cannot start in the past (compare dates only, not time)
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const startDateOnly = new Date(start.getFullYear(), start.getMonth(), start.getDate());
      if (startDateOnly < today) {
        showDateTimeError('tripDates', 'Trip cannot start in the past');
        isValid = false;
      }
      
      // End date must be after start date
      if (end < start) {
        showDateTimeError('tripDates', 'End date must be after start date');
        isValid = false;
      }
      
      // Join deadline validations - compare date+time
      if (joinBy <= now) {
        showDateTimeError('joinedBy', 'Join deadline cannot be in the past');
        isValid = false;
      } else if (joinBy >= start) {
        showDateTimeError('joinedBy', 'Join deadline must be before trip start');
        isValid = false;
      }
      
      return isValid;
    }

    /**
     * Validate meeting/pickup time
     */
    function validateMeetingTime(): boolean {
      const pickupDateTime = getDateTimeValue('pickupDates') as any;
      const tripDates = getDateTimeValue('tripDates') as any;
      
      let isValid = true;
      const now = new Date();
      
      hideDateTimeError('pickupDates');
      
      if (!pickupDateTime) {
        return true; // Let HTML5 validation handle empty required fields
      }
      
      const meetingTime = parseLocalDate(pickupDateTime);
      if (!meetingTime) return true;
      
      // Meeting time cannot be in the past (compare date+time)
      if (meetingTime <= now) {
        showDateTimeError('pickupDates', 'Meeting time cannot be in the past');
        isValid = false;
      }
      
      // Meeting should be on or before trip start
      if (tripDates.start) {
        const tripStart = parseLocalDate(tripDates.start);
        if (tripStart && meetingTime > tripStart) {
          showDateTimeError('pickupDates', 'Meeting time should be on or before trip start');
          isValid = false;
        }
      }
      
      return isValid;
    }

    function toDateOnly(value: string | Date): DateOnlyString {
      let d: Date;
      if (typeof value === 'string') {
        // Parse as local date to avoid UTC issues
        const parsed = parseLocalDate(value);
        d = parsed || new Date();
      } else {
        d = value;
      }
      // Format as YYYY-MM-DD in local timezone
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}` as DateOnlyString;
    }

    /**
     * Validate drop-off time
     */
    function validateDropoffTime(): boolean {
      const dropoffDateTime = getDateTimeValue('dropoffDates') as any;
      const pickupDateTime = getDateTimeValue('pickupDates') as any;
      const tripDates = getDateTimeValue('tripDates') as any;

      let isValid = true;
      hideDateTimeError('dropoffDates');

      // Validate dropoff time whenever a value is set
      if (dropoffDateTime) {
        const dropoffTime = parseLocalDate(dropoffDateTime);
        if (!dropoffTime) return true;

        // Drop-off must be after pickup
        if (pickupDateTime) {
          const pickupTime = parseLocalDate(pickupDateTime);
          if (pickupTime && dropoffTime <= pickupTime) {
            showDateTimeError('dropoffDates', 'Drop-off time must be after pickup time');
            isValid = false;
          }
        }

        // Drop-off should be within reasonable range of trip end
        if (tripDates.end) {
          const tripEnd = parseLocalDate(tripDates.end);
          if (tripEnd) {
            const maxDropoff = new Date(tripEnd);
            maxDropoff.setDate(maxDropoff.getDate() + 1); // Allow 1 day buffer

            if (dropoffTime > maxDropoff) {
              showDateTimeError('dropoffDates', 'Drop-off should be within trip duration (plus 1 day)');
              isValid = false;
            }
          }
        }
      }

      return isValid;
    }

    /**
     * Validate the current step
     */
    function validateCurrentStep(): boolean {
      const currentStepElement = document.querySelector(`.step[data-step="${currentStep}"]`);
      if (!currentStepElement) return false;
      
      const requiredInputs = currentStepElement.querySelectorAll('[required]') as NodeListOf<HTMLInputElement>;
      let hasEmptyFields = false;
      
      requiredInputs.forEach((input: HTMLInputElement) => {
        // Skip validation for hidden fields
        const isInHiddenWrapper = input.offsetParent === null;
        
        if (!isInHiddenWrapper) {
          const isEmpty = !input.value || (input.tagName === 'SELECT' && input.value === '');
          
          if (isEmpty) {
            input.classList.add('border-red-300');
            hasEmptyFields = true;
          } else {
            input.classList.remove('border-red-300');
          }
        }
      });
      
      if (hasEmptyFields) {
        showToast({
          message: 'Please fill in all required fields',
          type: 'error'
        });
        return false;
      }
      
      // Step-specific validation
      if (currentStep === 1) {
        return validateDates();
      }
      
      if (currentStep === 4) {
        return validateMeetingTime() && validateDropoffTime();
      }
      
      return true;
    }

    // ==================== DATE CONSTRAINT UPDATES ====================
    type DateOnlyString = `${number}-${number}-${number}`;

interface DateRange {
  start?: string;
  end?: string;
}

interface DatePickerConstraint {
  setMinDate(date: DateOnlyString): void;
  setMaxDate(date: DateOnlyString): void;
}

type DatePickerMap = Record<string, DatePickerConstraint>;
declare global {
  interface Window {
    updateDatePickerConstraints?: DatePickerMap;
  }
}

    /**
     * Update date picker constraints based on other date selections
     */
    function updateDateConstraints(): void {
      const constraints = window.updateDatePickerConstraints;
      
      if (!constraints) {
        console.warn('Date picker constraints API not available yet');
        return;
      }
      
      const tripDates = getDateTimeValue('tripDates') as DateRange;
      const today = toDateOnly(new Date());
      
      try {
        // Trip dates: minimum is today
        constraints.tripDates?.setMinDate(today);
        
        // Join deadline: must be before trip start
        if (tripDates?.start && constraints.joinedBy) {
          const startDate = parseLocalDate(tripDates.start);
          if (startDate) {
            const dayBefore = new Date(startDate);
            dayBefore.setDate(startDate.getDate() - 1);
            
            constraints.joinedBy.setMinDate(today);
            constraints.joinedBy.setMaxDate(toDateOnly(dayBefore));
          }
        }
        
        // Pickup date: today ‚Üí trip start
        if (tripDates?.start && constraints.pickupDates) {
          constraints.pickupDates.setMinDate(today);
          constraints.pickupDates.setMaxDate(toDateOnly(tripDates.start));
        }
        
        // Drop-off dates
        updateDropoffDateConstraints();
      } catch (error) {
        console.error('Error updating date constraints:', error);
      }
    }


    /**
     * Update drop-off date constraints
     */
     function updateDropoffDateConstraints(): void {
      const constraints = window.updateDatePickerConstraints;
      
      if (!constraints?.dropoffDates) {
        return;
      }
      
      const tripDates = getDateTimeValue('tripDates') as DateRange;
      const pickupDateTime = getDateTimeValue('pickupDates') as string | null;
      
      try {
        // Min: pickup date
        if (pickupDateTime) {
          constraints.dropoffDates.setMinDate(
          toDateOnly(pickupDateTime)
          );
        }
        
        // Max: day after trip end
        if (tripDates?.end) {
          const endDate = parseLocalDate(tripDates.end);
          if (endDate) {
            const dayAfter = new Date(endDate);
            dayAfter.setDate(endDate.getDate() + 1);
            
            constraints.dropoffDates.setMaxDate(
            toDateOnly(dayAfter)
            );
          }
        }
      } catch (error) {
        console.error('Error updating dropoff constraints:', error);
      }
    }


    // ==================== UI UPDATE FUNCTIONS ====================

    /**
     * Update UI to reflect current step
     */
    function updateUI() {
      // Show/hide steps with display instead of adding/removing from DOM
      steps.forEach(s => {
        const isActive = Number(s.getAttribute('data-step')) === currentStep;
        
        if (isActive) {
          s.classList.remove("hidden");
          (s as HTMLElement).style.opacity = "0";
          setTimeout(() => (s as HTMLElement).style.opacity = "1", 50);
        } else {
          s.classList.add("hidden");
        }
      });

      // Update step labels
      labels.forEach(l => {
        const stepNum = Number(l.getAttribute('data-step'));
        const isActive = stepNum === currentStep;
        const isPast = stepNum < currentStep;
        
        l.classList.toggle("text-blue-600", isActive);
        l.classList.toggle("text-green-600", isPast);
        l.classList.toggle("text-slate-400", !isActive && !isPast);
        l.classList.toggle("font-semibold", isActive);
      });

      // Update progress bar
      if (progressBar) {
        // Show full bar at step 5 (confirmation)
        const progress = currentStep === totalSteps ? 100 : (currentStep / totalSteps) * 100;
        progressBar.style.width = `${progress}%`;
      }

      // Show/hide navigation buttons
      if (prevBtn) prevBtn.classList.toggle("hidden", currentStep === 1);
      if (nextBtn) nextBtn.classList.toggle("hidden", currentStep === totalSteps);
      if (submitBtn) submitBtn.classList.toggle("hidden", currentStep !== totalSteps);
    }

    // ==================== EVENT HANDLERS ====================

    /**
     * Character counter for title
     */
    if (titleInput && titleCount) {
      titleInput.addEventListener("input", () => {
        titleCount.textContent = titleInput.value.length.toString();
      });
    }

    /**
     * Character counter for description
     */
    if (descInput && descCount) {
      descInput.addEventListener("input", () => {
        descCount.textContent = descInput.value.length.toString();
      });
    }

    /**
     * Cost sharing method change handler
     */
    const budgetConfig = {
      'split_evenly': {
        label: 'Estimated Budget Per Person',
        context: '(recommended)',
        helper: 'This will be split equally among all participants',
        placeholder: 'e.g. 5000 per person',
        show: true
      },
      'organizer_shoulders_cost': {
        label: 'Total Trip Budget',
        context: '(optional)',
        helper: 'Total cost you expect to shoulder for the entire trip',
        placeholder: 'e.g. 50000 total',
        show: true
      },
      'pay_own_expenses': {
        label: 'Estimated Budget Per Person',
        context: '(optional)',
        helper: 'Give participants an idea of what to budget for their personal expenses',
        placeholder: 'e.g. 3000 per person',
        show: true
      },
      'custom_split': {
        label: 'Estimated Total Budget',
        context: '(optional)',
        helper: 'Total trip cost before splitting (you can finalize the split later)',
        placeholder: 'e.g. 40000 total',
        show: true
      }
    };

    if (costSharing) {
      costSharing.addEventListener('change', (e: any) => {
        const method = (e.target as HTMLSelectElement).value;
        const config = ( budgetConfig as any)[method];

        if (config && config.show && budgetWrapper) {
          budgetWrapper.classList.remove('hidden');
          if (budgetLabel) budgetLabel.textContent = config.label;
          if (budgetContext) budgetContext.textContent = config.context;
          if (budgetHelper) budgetHelper.textContent = config.helper;
          if (estimatedBudget) estimatedBudget.placeholder = config.placeholder;

          // Update helper text for cost sharing
          if (costSharingHelper) {
            if (method === 'split_evenly') {
              costSharingHelper.textContent = 'All costs will be divided equally among participants';
            } else if (method === 'organizer_shoulders_cost') {
              costSharingHelper.textContent = 'You\'ll cover all trip expenses';
            } else if (method === 'pay_own_expenses') {
              costSharingHelper.textContent = 'Each person pays for their own meals, activities, etc.';
            } else {
              costSharingHelper.textContent = 'You\'ll decide the split arrangement later';
            }
          }
        } else if (budgetWrapper) {
          budgetWrapper.classList.add('hidden');
          if (estimatedBudget) estimatedBudget.setCustomValidity('');
          if (costSharingHelper) costSharingHelper.textContent = 'Choose how expenses will be handled';
        }
      });
    }

    /**
     * Same location checkbox handler
     */
    if (sameLocationCheckbox) {
      sameLocationCheckbox.addEventListener("change", (e) => {
        const isChecked = (e.target as HTMLInputElement).checked;
        
        if (dropoffWrapper) {
          if (isChecked) {
            dropoffWrapper.classList.add("hidden");

            // Clear and disable the location fields only
            if (dropoffInput) {
              dropoffInput.required = false;
              dropoffInput.value = "";
              dropoffInput.classList.remove('border-red-300');
            }

            const dropoffCoordinates = document.getElementById("dropoffCoordinates") as HTMLInputElement;
            if (dropoffCoordinates) {
              dropoffCoordinates.value = "";
            }
          } else {
            dropoffWrapper.classList.remove("hidden");

            // Re-enable location fields
            if (dropoffInput) {
              dropoffInput.required = true;
            }

            // Update date constraints for dropoff
            updateDropoffDateConstraints();
          }
        }
      });

      // Initialize same location as checked
      sameLocationCheckbox.checked = true;
    }

    /**
     * Navigation button handlers
     */
    if (nextBtn) {
      nextBtn.onclick = () => {
        if (validateCurrentStep() && currentStep < totalSteps) {
          currentStep++;
          updateUI();
          // Populate confirmation data when going to Step 5
          if (currentStep === 5) {
            populateConfirmationData();
          }
        }
      };
    }

    if (prevBtn) {
      prevBtn.onclick = () => {
        if (currentStep > 1) {
          currentStep--;
          updateUI();
        }
      };
    }

    // Quick edit links for Step 5
    document.querySelectorAll('[data-goto-step]').forEach(btn => {
      btn.addEventListener('click', () => {
        const targetStep = parseInt(btn.getAttribute('data-goto-step') || '1');
        currentStep = targetStep;
        updateUI();
      });
    });

    /**
     * Populate confirmation data for Step 5
     */
    function populateConfirmationData() {
      const title = (document.getElementById('tripTitle') as HTMLInputElement)?.value || '-';
      const startDate = (document.querySelector('input[name="start_date"]') as HTMLInputElement)?.value || '';
      const endDate = (document.querySelector('input[name="end_date"]') as HTMLInputElement)?.value || '';
      const destination = (document.getElementById('regionInput') as HTMLInputElement)?.value || '-';
      const maxPax = (document.getElementById('maxPax') as HTMLInputElement)?.value || '-';
      const budget = (document.getElementById('estimatedBudget') as HTMLInputElement)?.value || 'Not set';
      const costSharing = (document.getElementById('costSharing') as any)?.value || '-';

      const confirmTitle = document.getElementById('confirm-title');
      const confirmDates = document.getElementById('confirm-dates');
      const confirmDestination = document.getElementById('confirm-destination');
      const confirmPax = document.getElementById('confirm-pax');
      const confirmBudget = document.getElementById('confirm-budget');
      const confirmCostSharing = document.getElementById('confirm-costsharing');

      if (confirmTitle) confirmTitle.textContent = title;
      if (confirmDates) confirmDates.textContent = startDate && endDate ? `${startDate} to ${endDate}` : '-';
      if (confirmDestination) confirmDestination.textContent = destination;
      if (confirmPax) confirmPax.textContent = `${maxPax} people`;
      if (confirmBudget) confirmBudget.textContent = budget !== 'Not set' ? `‚Ç±${parseInt(budget).toLocaleString()}` : 'Not set';

      const costSharingLabels: Record<string, string> = {
        'split_evenly': 'Split Evenly',
        'organizer_shoulders_cost': 'Organizer Shoulders All Costs',
        'pay_own_expenses': 'Everyone Pays Own Expenses',
        'custom_split': 'Custom Split'
      };
      if (confirmCostSharing) confirmCostSharing.textContent = costSharingLabels[costSharing] || '-';

      // Initialize confirmation map with all 3 location markers
      initConfirmMap();
    }

    let confirmMap: any = null;

    async function initConfirmMap() {
      const mapContainer = document.getElementById('confirm-map');
      if (!mapContainer || !(window as any).mapboxgl) return;

      // Parse coordinates from hidden inputs
      const regionRaw = (document.getElementById('regionCoordinates') as HTMLInputElement)?.value;
      const pickupRaw = (document.getElementById('pickupCoordinates') as HTMLInputElement)?.value;
      const dropoffRaw = (document.getElementById('dropoffCoordinates') as HTMLInputElement)?.value;

      const parseCoords = (raw: string): [number, number] | null => {
        try {
          const arr = JSON.parse(raw);
          if (Array.isArray(arr) && arr.length === 2) return [arr[0], arr[1]]; // [lng, lat]
        } catch {}
        return null;
      };

      const regionCoords = regionRaw ? parseCoords(regionRaw) : null;
      const pickupCoords = pickupRaw ? parseCoords(pickupRaw) : null;
      const dropoffCoords = dropoffRaw ? parseCoords(dropoffRaw) : null;

      if (!regionCoords && !pickupCoords && !dropoffCoords) return;

      // Fetch token
      let token: string | null = null;
      try {
        const res = await fetch('/api/mapbox-token');
        const json = await res.json();
        token = ( json as any ).token;
      } catch {}
      if (!token) return;

      // Destroy previous instance if re-entering step 5
      if (confirmMap) { confirmMap.remove(); confirmMap = null; }

      // Clear placeholder content
      mapContainer.innerHTML = '';

      const mbgl = (window as any).mapboxgl;
      mbgl.accessToken = token;

      const center = regionCoords || pickupCoords || dropoffCoords!;
      confirmMap = new mbgl.Map({
        container: mapContainer,
        style: 'mapbox://styles/mapbox/streets-v12',
        center,
        zoom: 9,
        accessToken: token,
      });

      confirmMap.on('load', () => {
        const markerDefs = [
          { coords: regionCoords,  color: '#ef4444', label: 'Destination' },
          { coords: pickupCoords,  color: '#22c55e', label: 'Pickup' },
          { coords: dropoffCoords, color: '#3b82f6', label: 'Dropoff' },
        ];

        const bounds = new mbgl.LngLatBounds();
        let hasPoints = false;

        markerDefs.forEach(({ coords, color, label }) => {
          if (!coords) return;
          const el = document.createElement('div');
          el.style.cssText = `width:14px;height:14px;border-radius:50%;background:${color};border:3px solid white;box-shadow:0 2px 6px rgba(0,0,0,.4);`;
          new mbgl.Marker(el).setLngLat(coords).setPopup(new mbgl.Popup({ offset: 12 }).setText(label)).addTo(confirmMap);
          bounds.extend(coords);
          hasPoints = true;
        });

        if (hasPoints) {
          confirmMap.fitBounds(bounds, { padding: 60, maxZoom: 14, duration: 500 });
        }
      });
    }

    /**
     * Listen for date changes to update constraints and validate
     */
    document.addEventListener('change', (e) => {
      const target = e.target as HTMLInputElement;
      
      if (target.name === 'start_date' || target.name === 'end_date' || target.name === 'joined_by') {
        updateDateConstraints();
        if (currentStep === 1) {
          validateDates();
        }
      }
      
      if (target.name === 'pickup_dates') {
        if (currentStep === 4) {
          validateMeetingTime();
        }
        updateDropoffDateConstraints();
      }
      
      if (target.name === 'dropoff_dates') {
        if (currentStep === 4) {
          validateDropoffTime();
        }
      }
    });

    // ==================== MAPBOX INTEGRATION ====================
    function createSessionToken() {
      // generate UUID
      return crypto.randomUUID();
    }
    // create sessionID
    const sessionId = createSessionToken();
    if (!sessionId) {
      console.error('Session ID not found for Mapbox integration');
    } else {
      // Region/Destination autocomplete
      createMapboxSearchBox({
        sessionTokenID: sessionId,
        targetSelector: "#regionInput",
        onSelect: (result) => {
          const regionInput = document.getElementById("regionInput") as HTMLInputElement;
          const regionCoordinates = document.getElementById("regionCoordinates") as HTMLInputElement;
          
          if (regionInput) regionInput.value = result.name;
          if (regionCoordinates) regionCoordinates.value = JSON.stringify(result.coordinates);
        },
      });

      // Pickup point autocomplete
      createMapboxSearchBox({
        sessionTokenID: sessionId,
        targetSelector: "#pickupInput",
        onSelect: (result) => {
          const pickupInput = document.getElementById("pickupInput") as HTMLInputElement;
          const pickupCoordinates = document.getElementById("pickupCoordinates") as HTMLInputElement;
          
          if (pickupInput) pickupInput.value = result.name;
          if (pickupCoordinates) pickupCoordinates.value = JSON.stringify(result.coordinates);
        },
      });

      // Dropoff point autocomplete
      createMapboxSearchBox({
        sessionTokenID: sessionId,
        targetSelector: "#dropoffInput",
        onSelect: (result) => {
          const dropoffInput = document.getElementById("dropoffInput") as HTMLInputElement;
          const dropoffCoordinates = document.getElementById("dropoffCoordinates") as HTMLInputElement;
          
          if (dropoffInput) dropoffInput.value = result.name;
          if (dropoffCoordinates) dropoffCoordinates.value = JSON.stringify(result.coordinates);
        },
      });
    }

    // ==================== MAP PICKER MODAL HANDLERS ====================
    // Listen for location selection events from modals
    document.addEventListener('locationSelected', (e: any) => {
      const { fieldId, coordinates, address } = e.detail;
      
      if (fieldId === 'region') {
        const regionInput = document.getElementById('regionInput') as HTMLInputElement;
        const regionCoordinates = document.getElementById('regionCoordinates') as HTMLInputElement;
        if (regionInput) regionInput.value = address;
        if (regionCoordinates) regionCoordinates.value = JSON.stringify(coordinates);
      } else if (fieldId === 'pickup') {
        const pickupInput = document.getElementById('pickupInput') as HTMLInputElement;
        const pickupCoordinates = document.getElementById('pickupCoordinates') as HTMLInputElement;
        if (pickupInput) pickupInput.value = address;
        if (pickupCoordinates) pickupCoordinates.value = JSON.stringify(coordinates);
      } else if (fieldId === 'dropoff') {
        const dropoffInput = document.getElementById('dropoffInput') as HTMLInputElement;
        const dropoffCoordinates = document.getElementById('dropoffCoordinates') as HTMLInputElement;
        if (dropoffInput) dropoffInput.value = address;
        if (dropoffCoordinates) dropoffCoordinates.value = JSON.stringify(coordinates);
      }
    });

    // Map picker button handlers
    const regionPickBtn = document.getElementById('region-pick-map-btn');
    const pickupPickBtn = document.getElementById('pickup-pick-map-btn');
    const dropoffPickBtn = document.getElementById('dropoff-pick-map-btn');

    regionPickBtn?.addEventListener('click', () => {
      const openFn = (window as any).openRegionMapPicker;
      if (openFn) openFn();
    });

    pickupPickBtn?.addEventListener('click', () => {
      const openFn = (window as any).openPickupMapPicker;
      if (openFn) openFn();
    });

    dropoffPickBtn?.addEventListener('click', () => {
      const openFn = (window as any).openDropoffMapPicker;
      if (openFn) openFn();
    });

    // ==================== FORM SUBMISSION ====================

    if (form) {
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        
        // Final validation
        if (!validateCurrentStep()) {
          showToast({
            message: 'Please fill in all required fields correctly',
            type: 'error'
          });
          return;
        }
        
        showLoading();
        
        try {
          // Collect ALL form data directly - no disabling needed with novalidate attribute
          const formData = new FormData(form);

          // Handle tags - use getAll for multiple values
          const tagsInputs = formData.getAll("tags");
          let tagsArray: string[] = [];
          
          if (tagsInputs.length > 0) {
            tagsArray = tagsInputs
              .flatMap(tag => typeof tag === 'string' ? tag.split(',') : [])
              .map(tag => tag.trim())
              .filter(tag => tag.length > 0);
          }

          // Generate slug from title
          const title = formData.get("title") as string;
          
          if (!title) {
            showToast({
              message: 'Trip title is required. Please go back to Step 2.',
              type: 'error'
            });
            hideLoading();
            return;
          }
          
          const description = formData.get("description") as string;
          if (!description) {
            showToast({
              message: 'Trip description is required. Please go back to Step 2.',
              type: 'error'
            });
            hideLoading();
            return;
          }
          
          const genderPreference = formData.get("gender_preference") as string;
          if (!genderPreference) {
            showToast({
              message: 'Gender preference is required. Please go back to Step 3.',
              type: 'error'
            });
            hideLoading();
            return;
          }
          
          const costSharing = formData.get("cost_sharing") as string;
          if (!costSharing) {
            showToast({
              message: 'Cost sharing method is required. Please go back to Step 3.',
              type: 'error'
            });
            hideLoading();
            return;
          }
          
          const regionAddress = formData.get("region_address") as string;
          if (!regionAddress) {
            showToast({
              message: 'Destination is required. Please go back to Step 1.',
              type: 'error'
            });
            hideLoading();
            return;
          }
          
          let slug: string;
          
          try {
            slug = await slugify(title);
          } catch (slugError) {
            console.error('Slug generation failed:', slugError);
            // Fallback slug generation
            slug = title.toLowerCase()
              .replace(/[^a-z0-9]+/g, '-')
              .replace(/^-+|-+$/g, '');
          }

          // Handle same location logic
          const sameLocation = sameLocationCheckbox?.checked ?? true;
          
          let dropoffAddress = formData.get("dropoff_address") as string;
          let dropoffCoordinates = formData.get("dropoff_coordinates") as string;
          let dropoffDates = formData.get("dropoff_dates") as string;
          
          if (sameLocation) {
            // Same location: copy address and coordinates from pickup only
            dropoffAddress = formData.get("pickup_address") as string;
            dropoffCoordinates = formData.get("pickup_coordinates") as string;
            // dropoff date is always set independently by the user
          }

          // Construct trip data
          const tripData: TripFormData = {
            title: title,
            description: formData.get("description") as string,
            slug: slug,
            
            // Dates
            start_date: formData.get("start_date") as string,
            end_date: formData.get("end_date") as string,
            joined_by: formData.get("joined_by") as string,
            
            // Settings
            max_pax: parseInt(formData.get("max_pax") as string) || 2,
            gender_preference: formData.get("gender_preference") as 'any' | 'male' | 'female',
            cost_sharing: formData.get("cost_sharing") as 'split_evenly' | 'organizer_shoulders_cost' | 'pay_own_expenses' | 'custom_split',
            estimated_budget: formData.get("estimated_budget") ? parseFloat(formData.get("estimated_budget") as string) : null,
            tags: tagsArray,
            
            // Region/Destination
            region_address: formData.get("region_address") as string,
            region_coordinates: formData.get("region_coordinates") as string,
            
            // Pickup
            pickup_address: formData.get("pickup_address") as string,
            pickup_coordinates: formData.get("pickup_coordinates") as string,
            pickup_dates: formData.get("pickup_dates") as string,
            waiting_time: parseInt(formData.get("waiting_time") as string) || 15,
            
            // Dropoff
            dropoff_address: dropoffAddress,
            dropoff_coordinates: dropoffCoordinates,
            dropoff_dates: dropoffDates,
          };

          // Call the server action
          const { data: result, error } = await actions.trip.createTrip(tripData);
          
          if (error) {
            showToast({
              message: error.message || 'Failed to create trip',
              type: "error"
            });
          } else {
            sessionStorage.removeItem("tripDraft");

            const tripId = (result as any)?.trip_id;

            showToast({
              message: 'Trip created successfully!',
              type: "success"
            });

            setTimeout(() => {
              window.location.href = tripId ? `/trips/${tripId}` : `/trips`;
            }, 1000);
          }
        } catch (err) {
          console.error('Trip creation error:', err);
          showToast({ 
            message: err instanceof Error ? err.message : 'An unexpected error occurred', 
            type: "error" 
          });
        } finally {
          hideLoading();
        }
      });
    }

    // ==================== AUTOSAVE ====================

    let saveTimeout: number;
    if (form) {
      form.addEventListener("input", () => {
        clearTimeout(saveTimeout);
        saveTimeout = window.setTimeout(() => {
          try {
            const data = Object.fromEntries(new FormData(form).entries());
            sessionStorage.setItem("tripDraft", JSON.stringify(data));
          } catch (error) {
            console.error('Failed to save draft:', error);
          }
        }, 500);
      });
    }

    // ==================== LOAD DRAFT ====================

    const draft = sessionStorage.getItem("tripDraft");
    if (draft && form) {
      try {
        const data = JSON.parse(draft);
        Object.keys(data).forEach(key => {
          const input = form.querySelector(`[name="${key}"]`) as HTMLInputElement;
          if (input && data[key]) {
            input.value = data[key];
            
            // Update character counters
            if (input.id === "tripTitle" && titleCount) {
              titleCount.textContent = data[key].length.toString();
            }
            if (input.id === "tripDescription" && descCount) {
              descCount.textContent = data[key].length.toString();
            }
            
            // Trigger cost sharing update
            if (input.id === "costSharing") {
              costSharing.dispatchEvent(new Event('change'));
            }
          }
        });
        
        updateDateConstraints();
      } catch (error) {
        console.error('Failed to load draft:', error);
      }
    }

    // ==================== INITIALIZATION ====================

    // Initial UI update
    updateUI();

    // Initial date constraints setup (wait a bit for date pickers to initialize)
    setTimeout(() => {
      updateDateConstraints();
    }, 500);

    // Expose validation function globally for debugging
    (window as any).validateCurrentStep = validateCurrentStep;
    (window as any).validateDates = validateDates;
    (window as any).validateMeetingTime = validateMeetingTime;
    (window as any).validateDropoffTime = validateDropoffTime;

  </script>
</Layout>