---
import Layout from "@/layouts/PagePlate.astro";
import DatePicker from "@/components/DatePicker.astro";
import { Plane, CalendarDays, MapPin, Users, Clock, DollarSign, AlertCircle, Info } from "@lucide/astro";
import Tags from "@/components/Trip/Tags.astro";
---

<Layout title="Create Trip | Tara G">
  <section class="max-w-3xl mx-auto py-10 px-4 sm:px-8">
    <!-- HEADER -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold mb-2 bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">Plan Your Adventure</h1>
      <p class="text-slate-600">Create an unforgettable journey in just a few steps</p>
    </div>

    <!-- STEP PROGRESS BAR -->
    <div class="relative mb-10 mt-4">
      <div class="h-1 bg-slate-200 rounded-full"></div>
      <div id="progressBar" class="absolute top-0 h-1 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full transition-all duration-500 ease-out w-[25%]"></div>
      <div class="flex justify-between text-xs mt-2 font-medium">
        <span data-step="1" class="step-label text-blue-600 transition-all duration-300">Schedule</span>
        <span data-step="2" class="step-label text-slate-400 transition-all duration-300">Details</span>
        <span data-step="3" class="step-label text-slate-400 transition-all duration-300">Budget & Rules</span>
        <span data-step="4" class="step-label text-slate-400 transition-all duration-300">Logistics</span>
      </div>
    </div>

    <!-- FORM CARD -->
    <form id="tripStepperForm" novalidate class="backdrop-blur-md bg-white/70 border border-white/60 shadow-xl rounded-2xl p-6 space-y-6 transition-all duration-300">

      <!-- STEP 1: SCHEDULE -->
      <div class="step transition-opacity duration-300" data-step="1">
        <div class="flex items-center gap-2 mb-6">
          <div class="p-2 bg-blue-50 rounded-lg">
            <CalendarDays class="w-5 h-5 text-blue-500" />
          </div>
          <h2 class="font-semibold text-lg">When & Where</h2>
        </div>

        <div class="space-y-5">
          <!-- Trip Date Range -->
          <DatePicker
            label="Trip Dates"
            nameFrom="start_date"
            nameTo="end_date"
            required={true}
            helperText="When does your adventure begin and end?"
            id="tripDates"
          />

          <!-- Destination -->
          <div>
            <label class="font-medium mb-2 block text-slate-700">
              Destination
              <span class="text-red-500 ml-1">*</span>
            </label>
            <div class="relative group">
              <MapPin class="absolute left-3 top-3 w-4 h-4 text-blue-500 group-focus-within:text-purple-500 transition-colors" />
              <input 
                type="text" 
                name="region_address"
                class="border border-gray-300 rounded-lg w-full pl-10 pr-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" 
                id="regionInput"
                placeholder="Where are you headed?"
                required
              />
              <input type="hidden" name="region_coordinates" id="regionCoordinates" />
            </div>
          </div>

          <!-- Join Deadline with Time -->
          <DatePicker
            label="Join Deadline"
            name="joined_by"
            id="joinedBy"
            mode="single"
            enableTime={true}
            defaultTime="23:59"
            required={true}
            helperText="Last moment for participants to join (allows last-minute joiners!)"
          />
        </div>
      </div>

      <!-- STEP 2: DETAILS -->
      <div class="step hidden transition-opacity duration-300" data-step="2">
        <div class="flex items-center gap-2 mb-6">
          <div class="p-2 bg-blue-50 rounded-lg">
            <Plane class="w-5 h-5 text-blue-500" />
          </div>
          <h2 class="font-semibold text-lg">Trip Details</h2>
        </div>

        <div class="space-y-4">
          <div>
            <label class="font-medium mb-2 block text-slate-700" for="title">
              Trip Title
              <span class="text-red-500 ml-1">*</span>
            </label>
            <input 
              type="text" 
              name="title" 
              id="tripTitle"
              class="border border-gray-300 rounded-lg w-full px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" 
              placeholder="e.g. Siargao Surf Trip 2025"
              required
              maxlength="100"
            />
            <div class="text-xs text-slate-500 mt-1 text-right">
              <span id="titleCount">0</span>/100
            </div>
          </div>

          <div>
            <label class="font-medium mb-2 block text-slate-700" for="description">
              About the Trip
              <span class="text-red-500 ml-1">*</span>
            </label>
            <textarea 
              name="description" 
              id="tripDescription"
              class="border border-gray-300 rounded-lg w-full px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" 
              rows="4" 
              placeholder="What's the vibe? What are you hoping to explore?"
              required
              maxlength="500"
            ></textarea>
            <div class="text-xs text-slate-500 mt-1 text-right">
              <span id="descCount">0</span>/500
            </div>
          </div>

          <Tags />
        </div>
      </div>

      <!-- STEP 3: BUDGET & RULES -->
      <div class="step hidden transition-opacity duration-300" data-step="3">
        <div class="flex items-center gap-2 mb-6">
          <div class="p-2 bg-blue-50 rounded-lg">
            <Users class="w-5 h-5 text-blue-500" />
          </div>
          <h2 class="font-semibold text-lg">Budget & Participants</h2>
        </div>

        <div class="space-y-4">
          <!-- Cost Sharing Method -->
          <div>
            <label class="font-medium mb-2 block text-slate-700">
              Cost Sharing Method
              <span class="text-red-500 ml-1">*</span>
            </label>
            <select 
              name="cost_sharing" 
              id="costSharing"
              class="border border-gray-300 rounded-lg w-full px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
              required
            >
              <option value="">Select cost sharing method</option>
              <option value="split_evenly">Split Evenly</option>
              <option value="organizer_shoulders_cost">Organizer Shoulders All Costs</option>
              <option value="pay_own_expenses">Everyone Pays Own Expenses</option>
              <option value="custom_split">Custom Split (decide later)</option>
            </select>
            <p class="text-xs text-slate-500 mt-1" id="costSharingHelper">Choose how expenses will be handled</p>
          </div>

          <!-- Dynamic Budget Field -->
          <div id="budgetWrapper" class="hidden">
            <label for="estimated_budget" class="font-medium mb-2 block text-slate-700">
              <span id="budgetLabel">Estimated Budget</span>
              <span class="text-xs text-slate-500 ml-1" id="budgetContext">(recommended)</span>
            </label>
            <div class="relative">
              <DollarSign class="absolute left-3 top-3 w-4 h-4 text-blue-500" />
              <input 
                type="number" 
                name="estimated_budget" 
                id="estimatedBudget"
                class="border border-gray-300 rounded-lg w-full pl-10 pr-4 py-2.5 transition-all"
                placeholder="e.g. 5000"
                min="0"
                step="100"
              />
            </div>
            <p class="text-xs text-slate-500 mt-1" id="budgetHelper">This helps participants prepare financially</p>
          </div>

          <!-- Gender Preference -->
          <div>
            <label class="font-medium mb-2 block text-slate-700">
              Gender Preference
              <span class="text-red-500 ml-1">*</span>
            </label>
            <select 
              name="gender_preference" 
              id="genderPreference"
              class="border border-gray-300 rounded-lg w-full px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
              required
            >
              <option value="">Select gender preference</option>
              <option value="any">Any</option>
              <option value="male">Male Only</option>
              <option value="female">Female Only</option>
            </select>
          </div>

          <!-- Maximum Participants -->
          <div>
            <label for="max_pax" class="font-medium mb-2 block text-slate-700">
              Maximum Participants
              <span class="text-red-500 ml-1">*</span>
            </label>
            <input 
              type="number" 
              name="max_pax" 
              id="maxPax"
              class="border border-gray-300 rounded-lg w-full px-4 py-2.5  transition-all" 
              min="2"
              max="50"
              placeholder="e.g. 8"
              required
            />
            <p class="text-xs text-slate-500 mt-1">Minimum 2, maximum 50 participants</p>
          </div>
        </div>
      </div>

      <!-- STEP 4: LOGISTICS -->
      <div class="step hidden transition-opacity duration-300" data-step="4">
        <div class="flex items-center gap-2 mb-6">
          <div class="p-2 bg-blue-50 rounded-lg">
            <MapPin class="w-5 h-5 text-blue-500" />
          </div>
          <h2 class="font-semibold text-lg">Meetup & Transport</h2>
        </div>

        <div class="space-y-5">
          <!-- Meeting Time -->
          <DatePicker
            label="Meeting Date & Time"
            name="pickup_dates"
            id="pickupDates"
            mode="single"
            enableTime={true}
            defaultTime="06:00"
            required={true}
            helperText="When should everyone gather?"
          />

          <!-- Pickup Point -->
          <div>
            <label class="font-medium mb-2 block text-slate-700">
              Pickup Point
              <span class="text-red-500 ml-1">*</span>
            </label>
            <div class="relative">
              <MapPin class="absolute left-3 top-3 w-4 h-4 text-green-500" />
              <input 
                type="text"
                name="pickup_address"
                class="border border-gray-300 rounded-lg w-full pl-10 pr-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" 
                id="pickupInput" 
                placeholder="e.g. MOA Globe, Ayala Cebu Terminal"
                required
              />
              <input type="hidden" name="pickup_coordinates" id="pickupCoordinates" />
            </div>
          </div>

          <!-- Waiting Time / Grace Period -->
          <div>
            <label class="font-medium mb-2 block text-slate-700">Grace Period (minutes)</label>
            <div class="relative">
              <Clock class="absolute left-3 top-3 w-4 h-4 text-blue-500" />
              <input 
                type="number" 
                name="waiting_time" 
                id="waitingTime"
                min="0"
                max="60"
                placeholder="e.g. 15" 
                class="border border-gray-300 rounded-lg w-full pl-10 pr-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                value="15"
              />
            </div>
            <p class="text-xs text-slate-500 mt-1">How long will you wait for late participants?</p>
          </div>

          <!-- Same Location Checkbox -->
          <div class="flex items-start gap-3 p-4 bg-blue-50 rounded-lg border border-blue-100">
            <input 
              type="checkbox" 
              id="sameLocation" 
              class="mt-0.5 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
            />
            <label for="sameLocation" class="text-sm text-slate-700 cursor-pointer">
              <span class="font-medium">Drop-off at same location and time as pickup</span>
              <p class="text-xs text-slate-600 mt-1">Uncheck if you're planning a one-way trip or ending at a different location/time</p>
            </label>
          </div>

          <!-- Drop-off Section (conditional) -->
          <div id="dropoffWrapper" class="hidden space-y-4">
            <div class="border-t border-slate-200 pt-4">
              <h3 class="font-medium text-slate-700 mb-4 flex items-center gap-2">
                <MapPin class="w-4 h-4 text-red-500" />
                Drop-off Details
              </h3>
              
              <!-- Drop-off Location -->
              <div class="mb-4">
                <label class="font-medium mb-2 block text-slate-700">
                  Drop-off Point
                  <span class="text-red-500 ml-1">*</span>
                </label>
                <div class="relative">
                  <MapPin class="absolute left-3 top-3 w-4 h-4 text-red-500" />
                  <input 
                    type="text"
                    name="dropoff_address"
                    class="border border-gray-300 rounded-lg w-full pl-10 pr-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" 
                    id="dropoffInput" 
                    placeholder="Where will the trip end?"
                  />
                  <input type="hidden" name="dropoff_coordinates" id="dropoffCoordinates" />
                </div>
              </div>

              <!-- Drop-off Date & Time -->
              <DatePicker
                label="Drop-off Date & Time (Estimated)"
                name="dropoff_dates"
                id="dropoffDates"
                mode="single"
                enableTime={true}
                defaultTime="18:00"
                helperText="When do you expect to arrive at the drop-off point?"
              />
            </div>
          </div>

          <!-- Info Box -->
          <div class="flex items-start gap-3 p-4 bg-amber-50 rounded-lg border border-amber-100">
            <Info class="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5" />
            <div class="text-sm text-amber-900">
              <p class="font-medium mb-1">Additional Stops & Itinerary</p>
              <p class="text-xs text-amber-800">After creating your trip, you can add more pickup/drop-off points and finalize your complete itinerary in the trip dashboard.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- CONTROLS -->
      <div class="flex justify-between pt-6 border-t border-slate-200">
        <button 
          type="button" 
          id="stepPrev" 
          class="px-6 py-2.5 rounded-lg font-medium text-slate-600 hover:bg-slate-100 transition-all duration-200 hidden"
        >
          ‚Üê Back
        </button>
        <button 
          type="button" 
          id="stepNext" 
          class="px-6 py-2.5 rounded-lg font-medium bg-gradient-to-r from-blue-500 to-purple-500 text-white hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-200 ml-auto"
        >
          Next ‚Üí
        </button>
        <button 
          type="submit" 
          id="stepSubmit" 
          class="px-6 py-2.5 rounded-lg font-medium bg-gradient-to-r from-green-500 to-emerald-500 text-white hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-200 ml-auto hidden"
        >
          Create Trip ‚ú®
        </button>
      </div>
    </form>

    <!-- Tips Section -->
    <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-100">
      <h3 class="font-semibold text-sm text-blue-900 mb-2">üí° Pro Tips</h3>
      <ul class="text-xs text-blue-800 space-y-1">
        <li>‚Ä¢ Join deadline includes time - perfect for last-minute joiners!</li>
        <li>‚Ä¢ Budget field changes based on your cost sharing method</li>
        <li>‚Ä¢ Set join deadline a few hours before meeting time for better planning</li>
        <li>‚Ä¢ You can add more stops and finalize itinerary after creating the trip</li>
        <li>‚Ä¢ A 15-minute grace period is usually ideal</li>
      </ul>
    </div>

  </section>

  <!-- CONSOLIDATED SCRIPT - ALL LOGIC IN ONE PLACE -->
  <script>
    import { createMapboxSearchBox } from "../../scripts/mapBoxSearch.js";
    import { actions } from "astro:actions";
    import type { TripFormData } from "@/types/trip";
    import { slugify } from "@/scripts/Slugify";
    import { showToast } from "@/scripts/Toast";
    import { showLoading, hideLoading } from "@/lib/loading";

    // ==================== GLOBAL STATE ====================
    let currentStep = 1;
    const totalSteps = 4;

    // ==================== DOM ELEMENTS ====================
    const steps = document.querySelectorAll(".step");
    const progressBar = document.getElementById("progressBar");
    const labels = document.querySelectorAll(".step-label");
    const nextBtn = document.getElementById("stepNext");
    const prevBtn = document.getElementById("stepPrev");
    const submitBtn = document.getElementById("stepSubmit");
    const form = document.getElementById("tripStepperForm") as HTMLFormElement;

    // Character counters
    const titleInput = document.getElementById("tripTitle") as HTMLInputElement;
    const descInput = document.getElementById("tripDescription") as HTMLTextAreaElement;
    const titleCount = document.getElementById("titleCount");
    const descCount = document.getElementById("descCount");

    // Cost Sharing Elements
    const costSharing = document.getElementById("costSharing") as any;
    const budgetWrapper = document.getElementById("budgetWrapper");
    const budgetLabel = document.getElementById("budgetLabel");
    const budgetContext = document.getElementById("budgetContext");
    const budgetHelper = document.getElementById("budgetHelper");
    const estimatedBudget = document.getElementById("estimatedBudget") as HTMLInputElement;
    const costSharingHelper = document.getElementById("costSharingHelper");

    // Same Location Elements
    const sameLocationCheckbox = document.getElementById("sameLocation") as HTMLInputElement;
    const dropoffWrapper = document.getElementById("dropoffWrapper");
    const dropoffInput = document.getElementById("dropoffInput") as HTMLInputElement;

    // ==================== UTILITY FUNCTIONS ====================
    
    /**
     * Get date/time value from various input types
     * Handles both single date pickers and date ranges
     */
    function getDateTimeValue(id: string) {
      if (id === 'tripDates') {
        // For range picker - try multiple possible input name patterns
        const fromInput = document.querySelector(`input[name="start_date"]`) as HTMLInputElement;
        const toInput = document.querySelector(`input[name="end_date"]`) as HTMLInputElement;
        
        if (!fromInput || !toInput) {
          console.warn(`Date range inputs not found for ${id}`);
          return { start: null, end: null };
        }
        
        return {
          start: fromInput.value || null,
          end: toInput.value || null
        };
      } else {
        // For single date pickers - try the actual input name first
        const directInput = document.querySelector(`input[name="${id.replace(/([A-Z])/g, '_$1').toLowerCase()}"]`) as HTMLInputElement;
        if (directInput?.value) {
          return directInput.value;
        }
        
        // Fallback to looking for hidden input
        const hiddenInput = document.getElementById(`${id}-hidden`) as HTMLInputElement;
        if (hiddenInput?.value) {
          return hiddenInput.value;
        }
        
        // Last resort - try the display input
        const displayInput = document.getElementById(id) as HTMLInputElement;
        if (displayInput?.value) {
          return displayInput.value;
        }
        
        console.warn(`No value found for date picker: ${id}`);
        return null;
      }
    }

    /**
     * Show error message for date/time picker
     */
    function showDateTimeError(id: string, message: string) {
      const errorDiv = document.querySelector(`[data-error="${id}"]`);
      const errorText = document.querySelector(`[data-error-text="${id}"]`);
      const pickerInput = document.getElementById(id);
      
      if (errorDiv && errorText) {
        errorText.textContent = message;
        errorDiv.classList.remove('hidden');
      }
      
      if (pickerInput) {
        pickerInput.classList.add('border-red-300');
      }
    }

    /**
     * Hide error message for date/time picker
     */
    function hideDateTimeError(id: string) {
      const errorDiv = document.querySelector(`[data-error="${id}"]`);
      const pickerInput = document.getElementById(id);
      
      if (errorDiv) {
        errorDiv.classList.add('hidden');
      }
      
      if (pickerInput) {
        pickerInput.classList.remove('border-red-300');
      }
    }

    // ==================== VALIDATION FUNCTIONS ====================

    /**
     * Validate trip dates and join deadline
     */
    function validateDates(): boolean {
      const tripDates = getDateTimeValue('tripDates') as any;
      const joinedByDateTime = getDateTimeValue('joinedBy') as any;
      
      let isValid = true;
      const now = new Date();
      
      // Clear previous errors
      hideDateTimeError('tripDates');
      hideDateTimeError('joinedBy');
      
      // If fields are empty, let HTML5 validation handle it
      if (!tripDates.start || !tripDates.end || !joinedByDateTime) {
        return true;
      }
      
      const start = new Date(tripDates.start);
      const end = new Date(tripDates.end);
      const joinBy = new Date(joinedByDateTime);
      
      // Trip cannot start in the past
      if (start < now) {
        showDateTimeError('tripDates', 'Trip cannot start in the past');
        isValid = false;
      }
      
      // End date must be after start date
      if (end < start) {
        showDateTimeError('tripDates', 'End date must be after start date');
        isValid = false;
      }
      
      // Join deadline validations
      if (joinBy < now) {
        showDateTimeError('joinedBy', 'Join deadline cannot be in the past');
        isValid = false;
      } else if (joinBy >= start) {
        showDateTimeError('joinedBy', 'Join deadline must be before trip start');
        isValid = false;
      }
      
      return isValid;
    }

    /**
     * Validate meeting/pickup time
     */
    function validateMeetingTime(): boolean {
      const pickupDateTime = getDateTimeValue('pickupDates') as any;
      const tripDates = getDateTimeValue('tripDates') as any;
      
      let isValid = true;
      const now = new Date();
      
      hideDateTimeError('pickupDates');
      
      if (!pickupDateTime) {
        return true; // Let HTML5 validation handle empty required fields
      }
      
      const meetingTime = new Date(pickupDateTime);
      
      // Meeting time cannot be in the past
      if (meetingTime < now) {
        showDateTimeError('pickupDates', 'Meeting time cannot be in the past');
        isValid = false;
      }
      
      // Meeting should be on or before trip start
      if (tripDates.start) {
        const tripStart = new Date(tripDates.start);
        if (meetingTime > tripStart) {
          showDateTimeError('pickupDates', 'Meeting time should be on or before trip start');
          isValid = false;
        }
      }
      
      return isValid;
    }

    function toDateOnly(value: string | Date): DateOnlyString {
      const d = typeof value === 'string' ? new Date(value) : value;
      return d.toISOString().split('T')[0] as DateOnlyString;
    }

    /**
     * Validate drop-off time
     */
    function validateDropoffTime(): boolean {
      const dropoffDateTime = getDateTimeValue('dropoffDates') as any;
      const pickupDateTime = getDateTimeValue('pickupDates') as any;
      const tripDates = getDateTimeValue('tripDates') as any;
      
      let isValid = true;
      
      hideDateTimeError('dropoffDates');
      
      // Only validate if dropoff section is visible and has value
      if (dropoffWrapper && !dropoffWrapper.classList.contains('hidden') && dropoffDateTime) {
        const dropoffTime = new Date(dropoffDateTime);
        
        // Drop-off must be after pickup
        if (pickupDateTime) {
          const pickupTime = new Date(pickupDateTime);
          if (dropoffTime <= pickupTime) {
            showDateTimeError('dropoffDates', 'Drop-off time must be after pickup time');
            isValid = false;
          }
        }
        
        // Drop-off should be within reasonable range of trip end
        if (tripDates.end) {
          const tripEnd = new Date(tripDates.end);
          const maxDropoff = new Date(tripEnd);
          maxDropoff.setDate(maxDropoff.getDate() + 1); // Allow 1 day buffer
          
          if (dropoffTime > maxDropoff) {
            showDateTimeError('dropoffDates', 'Drop-off should be within trip duration (plus 1 day)');
            isValid = false;
          }
        }
      }
      
      return isValid;
    }

    /**
     * Validate the current step
     */
    function validateCurrentStep(): boolean {
      const currentStepElement = document.querySelector(`.step[data-step="${currentStep}"]`);
      if (!currentStepElement) return false;
      
      const requiredInputs = currentStepElement.querySelectorAll('[required]') as NodeListOf<HTMLInputElement>;
      let hasEmptyFields = false;
      
      requiredInputs.forEach((input: HTMLInputElement) => {
        // Skip validation for hidden fields
        const isInHiddenWrapper = input.offsetParent === null;
        
        if (!isInHiddenWrapper) {
          const isEmpty = !input.value || (input.tagName === 'SELECT' && input.value === '');
          
          if (isEmpty) {
            input.classList.add('border-red-300');
            hasEmptyFields = true;
          } else {
            input.classList.remove('border-red-300');
          }
        }
      });
      
      if (hasEmptyFields) {
        showToast({
          message: 'Please fill in all required fields',
          type: 'error'
        });
        return false;
      }
      
      // Step-specific validation
      if (currentStep === 1) {
        return validateDates();
      }
      
      if (currentStep === 4) {
        return validateMeetingTime() && validateDropoffTime();
      }
      
      return true;
    }

    // ==================== DATE CONSTRAINT UPDATES ====================
    type DateOnlyString = `${number}-${number}-${number}`;

interface DateRange {
  start?: string;
  end?: string;
}

interface DatePickerConstraint {
  setMinDate(date: DateOnlyString): void;
  setMaxDate(date: DateOnlyString): void;
}

type DatePickerMap = Record<string, DatePickerConstraint>;
declare global {
  interface Window {
    updateDatePickerConstraints?: DatePickerMap;
  }
}

    /**
     * Update date picker constraints based on other date selections
     */
    function updateDateConstraints(): void {
      const constraints = window.updateDatePickerConstraints;
      
      if (!constraints) {
        console.warn('Date picker constraints API not available yet');
        return;
      }
      
      const tripDates = getDateTimeValue('tripDates') as DateRange;
      const today = toDateOnly(new Date());
      
      try {
        // Trip dates: minimum is today
        constraints.tripDates?.setMinDate(today);
        
        // Join deadline: must be before trip start
        if (tripDates?.start && constraints.joinedBy) {
          const startDate = new Date(tripDates.start);
          const dayBefore = new Date(startDate);
          dayBefore.setDate(startDate.getDate() - 1);
          
          constraints.joinedBy.setMinDate(today);
          constraints.joinedBy.setMaxDate(toDateOnly(dayBefore));
        }
        
        // Pickup date: today ‚Üí trip start
        if (tripDates?.start && constraints.pickupDates) {
          constraints.pickupDates.setMinDate(today);
          constraints.pickupDates.setMaxDate(toDateOnly(tripDates.start));
        }
        
        // Drop-off dates
        updateDropoffDateConstraints();
      } catch (error) {
        console.error('Error updating date constraints:', error);
      }
    }


    /**
     * Update drop-off date constraints
     */
     function updateDropoffDateConstraints(): void {
      const constraints = window.updateDatePickerConstraints;
      
      if (!constraints?.dropoffDates) {
        return;
      }
      
      const tripDates = getDateTimeValue('tripDates') as DateRange;
      const pickupDateTime = getDateTimeValue('pickupDates') as string | null;
      
      try {
        // Min: pickup date
        if (pickupDateTime) {
          constraints.dropoffDates.setMinDate(
          toDateOnly(pickupDateTime)
          );
        }
        
        // Max: day after trip end
        if (tripDates?.end) {
          const endDate = new Date(tripDates.end);
          const dayAfter = new Date(endDate);
          dayAfter.setDate(endDate.getDate() + 1);
          
          constraints.dropoffDates.setMaxDate(
          toDateOnly(dayAfter)
          );
        }
      } catch (error) {
        console.error('Error updating dropoff constraints:', error);
      }
    }


    // ==================== UI UPDATE FUNCTIONS ====================

    /**
     * Update UI to reflect current step
     */
    function updateUI() {
      // Show/hide steps with display instead of adding/removing from DOM
      steps.forEach(s => {
        const isActive = Number(s.getAttribute('data-step')) === currentStep;
        
        if (isActive) {
          s.classList.remove("hidden");
          (s as HTMLElement).style.opacity = "0";
          setTimeout(() => (s as HTMLElement).style.opacity = "1", 50);
        } else {
          s.classList.add("hidden");
        }
      });

      // Update step labels
      labels.forEach(l => {
        const stepNum = Number(l.getAttribute('data-step'));
        const isActive = stepNum === currentStep;
        const isPast = stepNum < currentStep;
        
        l.classList.toggle("text-blue-600", isActive);
        l.classList.toggle("text-green-600", isPast);
        l.classList.toggle("text-slate-400", !isActive && !isPast);
        l.classList.toggle("font-semibold", isActive);
      });

      // Update progress bar
      if (progressBar) {
        progressBar.style.width = `${(currentStep / totalSteps) * 100}%`;
      }

      // Show/hide navigation buttons
      if (prevBtn) prevBtn.classList.toggle("hidden", currentStep === 1);
      if (nextBtn) nextBtn.classList.toggle("hidden", currentStep === totalSteps);
      if (submitBtn) submitBtn.classList.toggle("hidden", currentStep !== totalSteps);
    }

    // ==================== EVENT HANDLERS ====================

    /**
     * Character counter for title
     */
    if (titleInput && titleCount) {
      titleInput.addEventListener("input", () => {
        titleCount.textContent = titleInput.value.length.toString();
      });
    }

    /**
     * Character counter for description
     */
    if (descInput && descCount) {
      descInput.addEventListener("input", () => {
        descCount.textContent = descInput.value.length.toString();
      });
    }

    /**
     * Cost sharing method change handler
     */
    const budgetConfig = {
      'split_evenly': {
        label: 'Estimated Budget Per Person',
        context: '(recommended)',
        helper: 'This will be split equally among all participants',
        placeholder: 'e.g. 5000 per person',
        show: true
      },
      'organizer_shoulders_cost': {
        label: 'Total Trip Budget',
        context: '(optional)',
        helper: 'Total cost you expect to shoulder for the entire trip',
        placeholder: 'e.g. 50000 total',
        show: true
      },
      'pay_own_expenses': {
        label: 'Estimated Budget Per Person',
        context: '(optional)',
        helper: 'Give participants an idea of what to budget for their personal expenses',
        placeholder: 'e.g. 3000 per person',
        show: true
      },
      'custom_split': {
        label: 'Estimated Total Budget',
        context: '(optional)',
        helper: 'Total trip cost before splitting (you can finalize the split later)',
        placeholder: 'e.g. 40000 total',
        show: true
      }
    };

    if (costSharing) {
      costSharing.addEventListener('change', (e: any) => {
        const method = (e.target as HTMLSelectElement).value;
        const config = ( budgetConfig as any)[method];

        if (config && config.show && budgetWrapper) {
          budgetWrapper.classList.remove('hidden');
          if (budgetLabel) budgetLabel.textContent = config.label;
          if (budgetContext) budgetContext.textContent = config.context;
          if (budgetHelper) budgetHelper.textContent = config.helper;
          if (estimatedBudget) estimatedBudget.placeholder = config.placeholder;

          // Update helper text for cost sharing
          if (costSharingHelper) {
            if (method === 'split_evenly') {
              costSharingHelper.textContent = 'All costs will be divided equally among participants';
            } else if (method === 'organizer_shoulders_cost') {
              costSharingHelper.textContent = 'You\'ll cover all trip expenses';
            } else if (method === 'pay_own_expenses') {
              costSharingHelper.textContent = 'Each person pays for their own meals, activities, etc.';
            } else {
              costSharingHelper.textContent = 'You\'ll decide the split arrangement later';
            }
          }
        } else if (budgetWrapper) {
          budgetWrapper.classList.add('hidden');
          if (estimatedBudget) estimatedBudget.setCustomValidity('');
          if (costSharingHelper) costSharingHelper.textContent = 'Choose how expenses will be handled';
        }
      });
    }

    /**
     * Same location checkbox handler
     */
    if (sameLocationCheckbox) {
      sameLocationCheckbox.addEventListener("change", (e) => {
        const isChecked = (e.target as HTMLInputElement).checked;
        
        if (dropoffWrapper) {
          if (isChecked) {
            dropoffWrapper.classList.add("hidden");
            
            // Clear and disable dropoff fields
            if (dropoffInput) {
              dropoffInput.required = false;
              dropoffInput.value = "";
              dropoffInput.classList.remove('border-red-300');
            }
            
            const dropoffCoordinates = document.getElementById("dropoffCoordinates") as HTMLInputElement;
            if (dropoffCoordinates) {
              dropoffCoordinates.value = "";
            }
            
            // Clear and disable dropoff date picker
            const dropoffDatesInput = document.getElementById("dropoffDates") as HTMLInputElement;
            if (dropoffDatesInput) {
              dropoffDatesInput.required = false;
              dropoffDatesInput.value = "";
              
              // Clear flatpickr if available
              if ((dropoffDatesInput as any)._flatpickr) {
                (dropoffDatesInput as any)._flatpickr.clear();
              }
            }
            
            hideDateTimeError('dropoffDates');
          } else {
            dropoffWrapper.classList.remove("hidden");
            
            // Enable dropoff fields
            if (dropoffInput) {
              dropoffInput.required = true;
            }
            
            const dropoffDatesInput = document.getElementById("dropoffDates") as HTMLInputElement;
            if (dropoffDatesInput) {
              dropoffDatesInput.required = true;
            }
            
            // Update constraints for dropoff date
            updateDropoffDateConstraints();
          }
        }
      });

      // Initialize same location as checked
      sameLocationCheckbox.checked = true;
    }

    /**
     * Navigation button handlers
     */
    if (nextBtn) {
      nextBtn.onclick = () => {
        if (validateCurrentStep() && currentStep < totalSteps) {
          currentStep++;
          updateUI();
        }
      };
    }

    if (prevBtn) {
      prevBtn.onclick = () => {
        if (currentStep > 1) {
          currentStep--;
          updateUI();
        }
      };
    }

    /**
     * Listen for date changes to update constraints and validate
     */
    document.addEventListener('change', (e) => {
      const target = e.target as HTMLInputElement;
      
      if (target.name === 'start_date' || target.name === 'end_date' || target.name === 'joined_by') {
        updateDateConstraints();
        if (currentStep === 1) {
          validateDates();
        }
      }
      
      if (target.name === 'pickup_dates') {
        if (currentStep === 4) {
          validateMeetingTime();
        }
        updateDropoffDateConstraints();
      }
      
      if (target.name === 'dropoff_dates') {
        if (currentStep === 4) {
          validateDropoffTime();
        }
      }
    });

    // ==================== MAPBOX INTEGRATION ====================
    function createSessionToken() {
      // generate UUID
      return crypto.randomUUID();
    }
    // create sessionID
    const sessionId = await createSessionToken();
    if (!sessionId) {
      console.error('Session ID not found for Mapbox integration');
    } else {
      // Region/Destination autocomplete
      createMapboxSearchBox({
        sessionTokenID: sessionId,
        targetSelector: "#regionInput",
        onSelect: (result) => {
          const regionInput = document.getElementById("regionInput") as HTMLInputElement;
          const regionCoordinates = document.getElementById("regionCoordinates") as HTMLInputElement;
          
          if (regionInput) regionInput.value = result.name;
          if (regionCoordinates) regionCoordinates.value = JSON.stringify(result.coordinates);
        },
      });

      // Pickup point autocomplete
      createMapboxSearchBox({
        sessionTokenID: sessionId,
        targetSelector: "#pickupInput",
        onSelect: (result) => {
          const pickupInput = document.getElementById("pickupInput") as HTMLInputElement;
          const pickupCoordinates = document.getElementById("pickupCoordinates") as HTMLInputElement;
          
          if (pickupInput) pickupInput.value = result.name;
          if (pickupCoordinates) pickupCoordinates.value = JSON.stringify(result.coordinates);
        },
      });

      // Dropoff point autocomplete
      createMapboxSearchBox({
        sessionTokenID: sessionId,
        targetSelector: "#dropoffInput",
        onSelect: (result) => {
          const dropoffInput = document.getElementById("dropoffInput") as HTMLInputElement;
          const dropoffCoordinates = document.getElementById("dropoffCoordinates") as HTMLInputElement;
          
          if (dropoffInput) dropoffInput.value = result.name;
          if (dropoffCoordinates) dropoffCoordinates.value = JSON.stringify(result.coordinates);
        },
      });
    }

    // ==================== FORM SUBMISSION ====================

    if (form) {
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        
        // Final validation
        if (!validateCurrentStep()) {
          showToast({
            message: 'Please fill in all required fields correctly',
            type: 'error'
          });
          return;
        }
        
        showLoading();
        
        try {
          // Collect ALL form data directly - no disabling needed with novalidate attribute
          const formData = new FormData(form);

          // Log all form data for debugging
          console.log("Raw FormData entries:");
          for (let [key, value] of formData.entries()) {
            console.log(`  ${key}: ${value}`);
          }

          // Handle tags - use getAll for multiple values
          const tagsInputs = formData.getAll("tags");
          let tagsArray: string[] = [];
          
          if (tagsInputs.length > 0) {
            tagsArray = tagsInputs
              .flatMap(tag => typeof tag === 'string' ? tag.split(',') : [])
              .map(tag => tag.trim())
              .filter(tag => tag.length > 0);
          }

          // Generate slug from title
          const title = formData.get("title") as string;
          
          if (!title) {
            showToast({
              message: 'Trip title is required. Please go back to Step 2.',
              type: 'error'
            });
            hideLoading();
            return;
          }
          
          const description = formData.get("description") as string;
          if (!description) {
            showToast({
              message: 'Trip description is required. Please go back to Step 2.',
              type: 'error'
            });
            hideLoading();
            return;
          }
          
          const genderPreference = formData.get("gender_preference") as string;
          if (!genderPreference) {
            showToast({
              message: 'Gender preference is required. Please go back to Step 3.',
              type: 'error'
            });
            hideLoading();
            return;
          }
          
          const costSharing = formData.get("cost_sharing") as string;
          if (!costSharing) {
            showToast({
              message: 'Cost sharing method is required. Please go back to Step 3.',
              type: 'error'
            });
            hideLoading();
            return;
          }
          
          const regionAddress = formData.get("region_address") as string;
          if (!regionAddress) {
            showToast({
              message: 'Destination is required. Please go back to Step 1.',
              type: 'error'
            });
            hideLoading();
            return;
          }
          
          let slug: string;
          
          try {
            slug = await slugify(title);
          } catch (slugError) {
            console.error('Slug generation failed:', slugError);
            // Fallback slug generation
            slug = title.toLowerCase()
              .replace(/[^a-z0-9]+/g, '-')
              .replace(/^-+|-+$/g, '');
          }

          // Handle same location logic
          const sameLocation = sameLocationCheckbox?.checked ?? true;
          
          let dropoffAddress = formData.get("dropoff_address") as string;
          let dropoffCoordinates = formData.get("dropoff_coordinates") as string;
          let dropoffDates = formData.get("dropoff_dates") as string;
          
          if (sameLocation) {
            // Use pickup details for dropoff
            dropoffAddress = formData.get("pickup_address") as string;
            dropoffCoordinates = formData.get("pickup_coordinates") as string;
            dropoffDates = formData.get("pickup_dates") as string;
          }

          // Construct trip data
          const tripData: TripFormData = {
            title: title,
            description: formData.get("description") as string,
            slug: slug,
            
            // Dates
            start_date: formData.get("start_date") as string,
            end_date: formData.get("end_date") as string,
            joined_by: formData.get("joined_by") as string,
            
            // Settings
            max_pax: parseInt(formData.get("max_pax") as string) || 2,
            gender_preference: formData.get("gender_preference") as 'any' | 'male' | 'female',
            cost_sharing: formData.get("cost_sharing") as 'split_evenly' | 'organizer_shoulders_cost' | 'pay_own_expenses' | 'custom_split',
            estimated_budget: formData.get("estimated_budget") ? parseFloat(formData.get("estimated_budget") as string) : null,
            tags: tagsArray,
            
            // Region/Destination
            region_address: formData.get("region_address") as string,
            region_coordinates: formData.get("region_coordinates") as string,
            
            // Pickup
            pickup_address: formData.get("pickup_address") as string,
            pickup_coordinates: formData.get("pickup_coordinates") as string,
            pickup_dates: formData.get("pickup_dates") as string,
            waiting_time: parseInt(formData.get("waiting_time") as string) || 15,
            
            // Dropoff
            dropoff_address: dropoffAddress,
            dropoff_coordinates: dropoffCoordinates,
            dropoff_dates: dropoffDates,
          };

          console.log("Submitting trip data:", tripData);

          // Call the server action
          const { data: result, error } = await actions.trip.createTrip(tripData);
          
          console.log("Server response:", result, error);

          if (error) {
            showToast({ 
              message: error.message || 'Failed to create trip', 
              type: "error" 
            });
          } else {
            // Clear draft from session storage
            sessionStorage.removeItem("tripDraft");
            
            // Parse the response to get trip_id
            let tripId;
            if (typeof result === 'string') {
              try {
                const parsed = JSON.parse(result);
                tripId = parsed.data?.trip_id || parsed.trip_id;
              } catch {
                tripId = result;
              }
            } else if (result && typeof result === 'object') {
              tripId = (result as any).trip_id || (result as any).data?.trip_id;
            } else {
              tripId = result;
            }
            
            console.log("Created trip ID:", tripId);
            
            // Show success message
            showToast({ 
              message: 'Trip created successfully!', 
              type: "success" 
            });
            
            // Redirect to trip page
            setTimeout(() => {
              if (tripId) {
                window.location.href = `/trips/${tripId}`;
              } else {
                window.location.href = `/trips`;
              }
            }, 1000);
          }
        } catch (err) {
          console.error('Trip creation error:', err);
          showToast({ 
            message: err instanceof Error ? err.message : 'An unexpected error occurred', 
            type: "error" 
          });
        } finally {
          hideLoading();
        }
      });
    }

    // ==================== AUTOSAVE ====================

    let saveTimeout: number;
    if (form) {
      form.addEventListener("input", () => {
        clearTimeout(saveTimeout);
        saveTimeout = window.setTimeout(() => {
          try {
            const data = Object.fromEntries(new FormData(form).entries());
            sessionStorage.setItem("tripDraft", JSON.stringify(data));
          } catch (error) {
            console.error('Failed to save draft:', error);
          }
        }, 500);
      });
    }

    // ==================== LOAD DRAFT ====================

    const draft = sessionStorage.getItem("tripDraft");
    if (draft && form) {
      try {
        const data = JSON.parse(draft);
        Object.keys(data).forEach(key => {
          const input = form.querySelector(`[name="${key}"]`) as HTMLInputElement;
          if (input && data[key]) {
            input.value = data[key];
            
            // Update character counters
            if (input.id === "tripTitle" && titleCount) {
              titleCount.textContent = data[key].length.toString();
            }
            if (input.id === "tripDescription" && descCount) {
              descCount.textContent = data[key].length.toString();
            }
            
            // Trigger cost sharing update
            if (input.id === "costSharing") {
              costSharing.dispatchEvent(new Event('change'));
            }
          }
        });
        
        updateDateConstraints();
      } catch (error) {
        console.error('Failed to load draft:', error);
      }
    }

    // ==================== INITIALIZATION ====================

    // Initial UI update
    updateUI();

    // Initial date constraints setup (wait a bit for date pickers to initialize)
    setTimeout(() => {
      updateDateConstraints();
    }, 500);

    // Expose validation function globally for debugging
    (window as any).validateCurrentStep = validateCurrentStep;
    (window as any).validateDates = validateDates;
    (window as any).validateMeetingTime = validateMeetingTime;
    (window as any).validateDropoffTime = validateDropoffTime;

function uuidv4() {
throw new Error("Function not implemented.");
}
  </script>
</Layout>