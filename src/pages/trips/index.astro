---
// File: src/pages/trips/index.astro
import Pageplate from "@/layouts/PagePlate.astro";
import TripCard from "@/components/TripCard.astro";
import SuggestedTripCard from "@/components/SuggestedTripCard.astro";
import PreferencesPrompt from "@/components/PreferencesPrompt.astro";
import { supabase, supabaseAdmin } from "@/lib/supabase";

const userId = Astro.locals.user_id;

if (!userId) {
  return Astro.redirect("/login");
}

// Get URL parameters for pagination and filters
const url = new URL(Astro.request.url);
const currentTab = url.searchParams.get('tab') || 'owned';
const currentPage = parseInt(url.searchParams.get('page') || '1');
const searchQuery = url.searchParams.get('search') || '';
const statusFilter = url.searchParams.get('status') || '';
const regionFilter = url.searchParams.get('region') || '';

// Preference filters for Discover tab
const budgetFilter = url.searchParams.get('budget') || '';
const styleFilter = url.searchParams.get('style') || '';
const paceFilter = url.searchParams.get('pace') || '';

const itemsPerPage = 12;
const offset = (currentPage - 1) * itemsPerPage;

// Fetch user preferences and settings
const [preferencesResult, settingsResult] = await Promise.all([
  supabaseAdmin.from('user_travel_preferences').select('*').eq('user_id', userId).single(),
  supabaseAdmin.from('user_settings').select('preferences_prompt_until').eq('user_id', userId).single()
]);

const userPreferences = preferencesResult.data;
const userSettings = settingsResult.data;
const now = new Date().toISOString();
const showPreferencesPrompt = !userPreferences && 
  (!userSettings?.preferences_prompt_until || userSettings.preferences_prompt_until < now);

// Get initial data for all tabs using RPC functions
const [ownedResult, memberResult, discoverResult, suggestedResult] = await Promise.all([
  supabase.rpc('get_user_owned_trips', {
    p_user_id: userId,
    p_search: currentTab === 'owned' ? (searchQuery || null) : null,
    p_status: currentTab === 'owned' ? (statusFilter || null) : null,
    p_limit: itemsPerPage,
    p_offset: currentTab === 'owned' ? offset : 0,
  }),
  supabase.rpc('get_user_member_trips', {
    p_user_id: userId,
    p_search: currentTab === 'member' ? (searchQuery || null) : null,
    p_member_status: currentTab === 'member' ? (statusFilter || null) : null,
    p_limit: itemsPerPage,
    p_offset: currentTab === 'member' ? offset : 0,
  }),
  supabase.rpc('get_discover_trips', {
    p_user_id: userId,
    p_search: currentTab === 'discover' ? (searchQuery || null) : null,
    p_region: currentTab === 'discover' ? (regionFilter || null) : null,
    p_budget: currentTab === 'discover' ? (budgetFilter || null) : null,
    p_travel_style: currentTab === 'discover' ? (styleFilter || null) : null,
    p_pace: currentTab === 'discover' ? (paceFilter || null) : null,
    p_limit: itemsPerPage,
    p_offset: currentTab === 'discover' ? offset : 0,
  }),
  supabase.rpc('get_suggested_trips', {
    p_user_id: userId,
    p_limit: 6,
  }),
]);

console.log("Trip data:", ownedResult);
const ownedTrips = ownedResult.data || [];
const memberTrips = memberResult.data || [];
const discoverTrips = discoverResult.data || [];
const suggestedTrips = suggestedResult.data || [];

const ownedCount = ownedTrips[0]?.total_count || 0;
const memberCount = memberTrips[0]?.total_count || 0;
const discoverCount = discoverTrips[0]?.total_count || 0;

// Determine which trips to show based on current tab
let currentTrips = ownedTrips;
let currentCount = ownedCount;
let currentType: 'owned' | 'member' | 'discover' = 'owned';

if (currentTab === 'member') {
  currentTrips = memberTrips;
  currentCount = memberCount;
  currentType = 'member';
} else if (currentTab === 'discover') {
  currentTrips = discoverTrips;
  currentCount = discoverCount;
  currentType = 'discover';
}

const totalPages = Math.ceil(currentCount / itemsPerPage);

// Helper function to build URL with params
function buildUrl(params: Record<string, string>) {
  const newUrl = new URL(Astro.request.url);
  Object.entries(params).forEach(([key, value]) => {
    if (value) {
      newUrl.searchParams.set(key, value);
    } else {
      newUrl.searchParams.delete(key);
    }
  });
  return newUrl.pathname + newUrl.search;
}
---

<Pageplate title="My Trips">
  <!-- Hero Section -->
  <section class="px-6 py-12 bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50">
    <div class="max-w-5xl mx-auto text-center space-y-5">
      <h1 class="text-5xl font-extrabold text-gray-900 tracking-tight">
        Welcome back, Explorer
      </h1>
      <p class="text-lg text-gray-600 max-w-2xl mx-auto">
        Your adventures begin here â€” past, present, and those waiting to happen.
      </p>
      <a
        href="/trips/create"
        class="inline-flex items-center gap-2 px-8 py-3.5 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-semibold shadow-lg hover:shadow-xl transition-all transform hover:scale-105"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
        </svg>
        Create New Trip
      </a>
    </div>
  </section>

  <!-- Main Content -->
  <section class="max-w-7xl mx-auto px-6 py-10">
    <div id="trips-container">
      <!-- Tab Navigation -->
      <div class="border-b border-gray-200 mb-8">
        <nav class="flex gap-8" aria-label="Trips tabs">
          <a
            href={buildUrl({ tab: 'owned', page: '1', search: '', status: '', region: '' })}
            class={`tab-link pb-4 px-1 font-semibold transition-colors relative ${currentTab === 'owned' ? 'active-tab' : 'inactive-tab'}`}
          >
            My Trips
            <span class="ml-2 px-2.5 py-0.5 text-xs rounded-full bg-blue-100 text-blue-800 font-medium">
              {ownedCount}
            </span>
          </a>
          <a
            href={buildUrl({ tab: 'member', page: '1', search: '', status: '', region: '' })}
            class={`tab-link pb-4 px-1 font-semibold transition-colors relative ${currentTab === 'member' ? 'active-tab' : 'inactive-tab'}`}
          >
            Joined Trips
            <span class="ml-2 px-2.5 py-0.5 text-xs rounded-full bg-gray-100 text-gray-600 font-medium">
              {memberCount}
            </span>
          </a>
          <a
            href={buildUrl({ tab: 'discover', page: '1', search: '', status: '', region: '', budget: '', style: '', pace: '' })}
            class={`tab-link pb-4 px-1 font-semibold transition-colors relative ${currentTab === 'discover' ? 'active-tab' : 'inactive-tab'}`}
          >
            Discover
            <span class="ml-2 px-2.5 py-0.5 text-xs rounded-full bg-gray-100 text-gray-600 font-medium">
              {discoverCount}
            </span>
          </a>
        </nav>
      </div>

      <!-- Search and Filter Bar -->
      <form method="GET" class="mb-8 flex gap-4 flex-wrap items-end">
        <input type="hidden" name="tab" value={currentTab} />
        <input type="hidden" name="page" value="1" />
        
        <div class="flex-1 min-w-[300px]">
          <label for="search-input" class="block text-sm font-medium text-gray-700 mb-2">
            Search trips
          </label>
          <div class="relative">
            <input
              type="text"
              id="search-input"
              name="search"
              value={searchQuery}
              placeholder="Search by title or description..."
              class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-shadow"
            />
            <svg class="absolute left-3 top-3.5 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
          </div>
        </div>
        
        <div class="w-48">
          <label for="status-filter" class="block text-sm font-medium text-gray-700 mb-2">
            Status
          </label>
          <select
            id="status-filter"
            name="status"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          >
            <option value="" selected={statusFilter === ''}>All Status</option>
            <option value="planning" selected={statusFilter === 'planning'}>Planning</option>
            <option value="upcoming" selected={statusFilter === 'upcoming'}>Upcoming</option>
            <option value="ongoing" selected={statusFilter === 'ongoing'}>Ongoing</option>
            <option value="completed" selected={statusFilter === 'completed'}>Completed</option>
            <option value="cancelled" selected={statusFilter === 'cancelled'}>Cancelled</option>
          </select>
        </div>

        {currentTab === 'discover' && (
          <div class="w-48">
            <label for="region-filter" class="block text-sm font-medium text-gray-700 mb-2">
              Region
            </label>
            <select
              id="region-filter"
              name="region"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="" selected={regionFilter === ''}>All Regions</option>
              <option value="NCR" selected={regionFilter === 'NCR'}>NCR</option>
              <option value="CAR" selected={regionFilter === 'CAR'}>Cordillera</option>
              <option value="I" selected={regionFilter === 'I'}>Ilocos Region</option>
              <option value="II" selected={regionFilter === 'II'}>Cagayan Valley</option>
              <option value="III" selected={regionFilter === 'III'}>Central Luzon</option>
              <option value="IV-A" selected={regionFilter === 'IV-A'}>CALABARZON</option>
              <option value="IV-B" selected={regionFilter === 'IV-B'}>MIMAROPA</option>
              <option value="V" selected={regionFilter === 'V'}>Bicol Region</option>
              <option value="VI" selected={regionFilter === 'VI'}>Western Visayas</option>
              <option value="VII" selected={regionFilter === 'VII'}>Central Visayas</option>
              <option value="VIII" selected={regionFilter === 'VIII'}>Eastern Visayas</option>
              <option value="IX" selected={regionFilter === 'IX'}>Zamboanga Peninsula</option>
              <option value="X" selected={regionFilter === 'X'}>Northern Mindanao</option>
              <option value="XI" selected={regionFilter === 'XI'}>Davao Region</option>
              <option value="XII" selected={regionFilter === 'XII'}>SOCCSKSARGEN</option>
              <option value="XIII" selected={regionFilter === 'XIII'}>Caraga</option>
              <option value="BARMM" selected={regionFilter === 'BARMM'}>BARMM</option>
            </select>
          </div>
        )}

        {/* Preference Filters - Only show when on Discover tab */}
        {currentTab === 'discover' && (
          <details class="group">
            <summary class="cursor-pointer px-4 py-3 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium text-gray-700 list-none flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
              </svg>
              Preferences
              {(budgetFilter || styleFilter || paceFilter) && (
                <span class="ml-2 px-2 py-0.5 text-xs bg-blue-100 text-blue-700 rounded-full">
                  {(budgetFilter ? 1 : 0) + (styleFilter ? 1 : 0) + (paceFilter ? 1 : 0)}
                </span>
              )}
            </summary>
            <div class="absolute mt-2 p-4 bg-white border border-gray-200 rounded-lg shadow-lg z-10 flex gap-4">
              <div>
                <label for="budget-filter" class="block text-sm font-medium text-gray-700 mb-2">
                  Budget
                </label>
                <select
                  id="budget-filter"
                  name="budget"
                  class="w-40 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                >
                  <option value="" selected={budgetFilter === ''}>Any</option>
                  <option value="budget" selected={budgetFilter === 'budget'}>Budget</option>
                  <option value="moderate" selected={budgetFilter === 'moderate'}>Moderate</option>
                  <option value="luxury" selected={budgetFilter === 'luxury'}>Luxury</option>
                </select>
              </div>
              <div>
                <label for="style-filter" class="block text-sm font-medium text-gray-700 mb-2">
                  Travel Style
                </label>
                <select
                  id="style-filter"
                  name="style"
                  class="w-40 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                >
                  <option value="" selected={styleFilter === ''}>Any</option>
                  <option value="adventure" selected={styleFilter === 'adventure'}>Adventure</option>
                  <option value="relax" selected={styleFilter === 'relax'}>Relax</option>
                  <option value="beach" selected={styleFilter === 'beach'}>Beach</option>
                  <option value="mountain" selected={styleFilter === 'mountain'}>Mountain</option>
                  <option value="cultural" selected={styleFilter === 'cultural'}>Cultural</option>
                  <option value="food" selected={styleFilter === 'food'}>Food Trip</option>
                </select>
              </div>
              <div>
                <label for="pace-filter" class="block text-sm font-medium text-gray-700 mb-2">
                  Pace
                </label>
                <select
                  id="pace-filter"
                  name="pace"
                  class="w-40 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                >
                  <option value="" selected={paceFilter === ''}>Any</option>
                  <option value="relaxed" selected={paceFilter === 'relaxed'}>Relaxed</option>
                  <option value="moderate" selected={paceFilter === 'moderate'}>Moderate</option>
                  <option value="fast" selected={paceFilter === 'fast'}>Fast-paced</option>
                </select>
              </div>
            </div>
          </details>
        )}

        <button
          type="submit"
          class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors"
        >
          Apply Filters
        </button>

        {(searchQuery || statusFilter || regionFilter || budgetFilter || styleFilter || paceFilter) && (
          <a
            href={buildUrl({ tab: currentTab, page: '1', search: '', status: '', region: '', budget: '', style: '', pace: '' })}
            class="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium rounded-lg transition-colors"
          >
            Clear Filters
          </a>
        )}
      </form>

      <!-- Trips Grid -->
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 mb-10">
        {currentTrips.map((trip: any) => (
          <TripCard client:visible trip={trip} type={currentType} />
        ))}
      </div>

      <!-- Empty State -->
      {currentTrips.length === 0 && (
        <div class="text-center py-20">
          {currentTab === 'owned' ? (
            <div>
              <div class="inline-flex items-center justify-center w-24 h-24 rounded-full bg-gray-100 mb-6">
                <svg class="w-12 h-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                </svg>
              </div>
              <h3 class="text-xl font-semibold text-gray-900 mb-2">No trips yet</h3>
              <p class="text-gray-500 mb-6">Start planning your next adventure!</p>
              <a
                href="/trips/create"
                class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 shadow-sm"
              >
                Create your first trip
              </a>
            </div>
          ) : currentTab === 'member' ? (
            <div>
              <div class="inline-flex items-center justify-center w-24 h-24 rounded-full bg-gray-100 mb-6">
                <svg class="w-12 h-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                </svg>
              </div>
              <h3 class="text-xl font-semibold text-gray-900 mb-2">Not part of any trips yet</h3>
              <p class="text-gray-500 mb-6">Explore and join trips from the Discover tab</p>
            </div>
          ) : (
            <div>
              <div class="inline-flex items-center justify-center w-24 h-24 rounded-full bg-gray-100 mb-6">
                <svg class="w-12 h-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
              </div>
              <h3 class="text-xl font-semibold text-gray-900 mb-2">No trips found</h3>
              <p class="text-gray-500">
                {userPreferences 
                  ? "Try adjusting your filters to find more trips"
                  : "Set your travel preferences to get personalized recommendations"}
              </p>
              {!userPreferences && (
                <button
                  id="open-preferences-from-empty"
                  class="mt-4 inline-flex items-center px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors"
                >
                  Set Preferences
                </button>
              )}
            </div>
          )}
        </div>
      )}

      <!-- Pagination -->
      {totalPages > 1 && (
        <nav class="flex justify-center items-center gap-2 mt-10" aria-label="Pagination">
          <!-- Previous button -->
          {currentPage > 1 ? (
            <a
              href={buildUrl({ tab: currentTab, page: String(currentPage - 1), search: searchQuery, status: statusFilter, region: regionFilter })}
              class="px-4 py-2 rounded-lg font-medium transition-colors text-gray-700 hover:bg-gray-100"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
              </svg>
            </a>
          ) : (
            <span class="px-4 py-2 rounded-lg font-medium text-gray-400 cursor-not-allowed">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
              </svg>
            </span>
          )}

          <!-- First page -->
          <a
            href={buildUrl({ tab: currentTab, page: '1', search: searchQuery, status: statusFilter, region: regionFilter })}
            class={`px-4 py-2 rounded-lg font-medium transition-colors ${
              1 === currentPage 
                ? 'bg-blue-600 text-white shadow-md' 
                : 'text-gray-700 hover:bg-gray-100'
            }`}
          >
            1
          </a>

          {currentPage > 3 && <span class="px-2 text-gray-400">...</span>}

          <!-- Middle pages -->
          {currentPage - 1 > 1 && (
            <a
              href={buildUrl({ tab: currentTab, page: String(currentPage - 1), search: searchQuery, status: statusFilter, region: regionFilter })}
              class="px-4 py-2 rounded-lg font-medium transition-colors text-gray-700 hover:bg-gray-100"
            >
              {currentPage - 1}
            </a>
          )}

          {currentPage !== 1 && currentPage !== totalPages && (
            <a
              href={buildUrl({ tab: currentTab, page: String(currentPage), search: searchQuery, status: statusFilter, region: regionFilter })}
              class="px-4 py-2 rounded-lg font-medium transition-colors bg-blue-600 text-white shadow-md"
            >
              {currentPage}
            </a>
          )}

          {currentPage + 1 < totalPages && (
            <a
              href={buildUrl({ tab: currentTab, page: String(currentPage + 1), search: searchQuery, status: statusFilter, region: regionFilter })}
              class="px-4 py-2 rounded-lg font-medium transition-colors text-gray-700 hover:bg-gray-100"
            >
              {currentPage + 1}
            </a>
          )}

          {currentPage < totalPages - 2 && <span class="px-2 text-gray-400">...</span>}

          <!-- Last page -->
          {totalPages > 1 && (
            <a
              href={buildUrl({ tab: currentTab, page: String(totalPages), search: searchQuery, status: statusFilter, region: regionFilter })}
              class={`px-4 py-2 rounded-lg font-medium transition-colors ${
                totalPages === currentPage 
                  ? 'bg-blue-600 text-white shadow-md' 
                  : 'text-gray-700 hover:bg-gray-100'
              }`}
            >
              {totalPages}
            </a>
          )}

          <!-- Next button -->
          {currentPage < totalPages ? (
            <a
              href={buildUrl({ tab: currentTab, page: String(currentPage + 1), search: searchQuery, status: statusFilter, region: regionFilter })}
              class="px-4 py-2 rounded-lg font-medium transition-colors text-gray-700 hover:bg-gray-100"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </a>
          ) : (
            <span class="px-4 py-2 rounded-lg font-medium text-gray-400 cursor-not-allowed">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </span>
          )}
        </nav>
      )}
    </div>

    <!-- Suggested Trips Section -->
    {ownedTrips.length < 3 && suggestedTrips.length > 0 && (
      <section class="mt-16 pt-12 border-t border-gray-200">
        <div class="flex items-center justify-between mb-8">
          <div>
            <h2 class="text-3xl font-bold text-gray-900">Suggested for You</h2>
            <p class="text-gray-600 mt-2">Based on your interests and preferences</p>
          </div>
          <svg class="w-8 h-8 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
          </svg>
        </div>
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          {suggestedTrips.map((trip: any) => (
            <SuggestedTripCard client:visible trip={trip} />
          ))}
        </div>
      </section>
    )}
  </section>

  {/* Preferences Prompt Modal */}
  {showPreferencesPrompt && (
    <PreferencesPrompt userId={userId} client:idle />
  )}

  <style>
    .active-tab {
      border-bottom: 2px solid rgb(37, 99, 235);
      color: rgb(37, 99, 235);
    }
    .inactive-tab {
      border-bottom: 2px solid transparent;
      color: rgb(107, 114, 128);
      transition: all 0.2s;
    }
    .inactive-tab:hover {
      color: rgb(55, 65, 81);
      border-bottom-color: rgb(209, 213, 219);
    }
  </style>

  <script>
    // Auto-submit form on filter change with debounce for search
    let searchTimeout: number;
    const form = document.querySelector('form');
    const searchInput = document.getElementById('search-input');
    const statusFilter = document.getElementById('status-filter');
    const regionFilter = document.getElementById('region-filter');
    const budgetFilter = document.getElementById('budget-filter');
    const styleFilter = document.getElementById('style-filter');
    const paceFilter = document.getElementById('pace-filter');
    const openPreferencesBtn = document.getElementById('open-preferences-from-empty');

    if (searchInput && form) {
      searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = window.setTimeout(() => {
          form.submit();
        }, 500);
      });
    }

    if (statusFilter && form) {
      statusFilter.addEventListener('change', () => {
        form.submit();
      });
    }

    if (regionFilter && form) {
      regionFilter.addEventListener('change', () => {
        form.submit();
      });
    }

    // Preference filters
    if (budgetFilter && form) {
      budgetFilter.addEventListener('change', () => {
        form.submit();
      });
    }

    if (styleFilter && form) {
      styleFilter.addEventListener('change', () => {
        form.submit();
      });
    }

    if (paceFilter && form) {
      paceFilter.addEventListener('change', () => {
        form.submit();
      });
    }

    // Open preferences from empty state
    if (openPreferencesBtn) {
      openPreferencesBtn.addEventListener('click', () => {
        const modal = document.getElementById('preferences-modal');
        if (modal) modal.classList.remove('hidden');
      });
    }
  </script>
</Pageplate>